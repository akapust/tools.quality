<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Brainstorming Tool – Ideen, Bewertung & Maßnahmen</title>

  <!-- html2canvas ist bewusst NICHT drin: Print ist der bessere Workflow -->
  <style>
    :root{
      --blue:#1155b2;
      --dark:#09387a;
      --light-bg:#f8fafc;
      --border:#d1d9e6;
      --muted:#64748b;
      --text:#27304d;
      --note:#fff9c4;

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#e53e3e;

      --radius:4px;
      --shadow:0 4px 12px rgba(0,0,0,.10);
    }

    body{ margin:0; background:#fff; color:var(--text); font-family:"Segoe UI", Roboto, system-ui, -apple-system, Arial, sans-serif; }
    *{ box-sizing:border-box; }
    :focus-visible{ outline:2px solid var(--blue); outline-offset:2px; }

    .app{ max-width:1100px; margin:20px auto; padding:0 12px; }
    .card{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden; }

    /* Intro */
    .intro{ padding:22px 25px; border-bottom:3px solid var(--blue); background:var(--light-bg); }
    .intro-top{ display:flex; justify-content:space-between; align-items:flex-start; gap:14px; flex-wrap:wrap; }
    .title{ margin:0; color:var(--dark); font-size:20px; text-transform:uppercase; letter-spacing:.4px; }
    .sub{ margin:6px 0 0; font-size:13px; color:var(--muted); max-width:780px; }

    .top-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
    .lang{ display:flex; gap:8px; }
    .btn{
      padding:10px 18px;
      font-size:13px;
      font-weight:800;
      border-radius:var(--radius);
      cursor:pointer;
      border:1px solid var(--border);
      background:#fff;
      text-transform:uppercase;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
      color:#334155;
      user-select:none;
    }
    .btn:hover{ border-color:rgba(17,85,178,.55); color:var(--blue); background:#f8fafc; }
    .btn.primary{ background:var(--blue); color:#fff; border-color:var(--blue); }
    .btn.primary:hover{ background:var(--dark); border-color:var(--dark); color:#fff; }
    .btn.danger{ color:var(--red); border-color:rgba(229,62,62,.35); }
    .btn.small{ padding:8px 12px; font-size:12px; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .grid{ margin-top:16px; display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }

    .box{ background:#fff; border:1px solid var(--border); border-radius:var(--radius); padding:12px 14px; }
    .box h3{ margin:0 0 6px; font-size:13px; color:var(--dark); text-transform:uppercase; }
    .box p, .box ol{ margin:0; font-size:13px; color:#334155; }
    .box ol{ padding-left:18px; }
    .privacy{ border-left:3px solid var(--blue); }

    /* Body */
    .body{ padding:25px; }

    .section{
      border:1px solid #edf2f7;
      border-radius:var(--radius);
      padding:16px;
      background:#fff;
      margin-bottom:16px;
    }
    .section-head{
      display:flex; justify-content:space-between; align-items:flex-end; gap:12px; flex-wrap:wrap;
      border-bottom:1px solid #eef2f7; padding-bottom:10px; margin-bottom:12px;
    }
    .sec-title{ margin:0; color:var(--dark); font-size:15px; font-weight:900; text-transform:uppercase; letter-spacing:.3px; }
    .sec-sub{ margin:4px 0 0; font-size:13px; color:var(--muted); }
    .sec-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .saved-pill{
      font-size:11px; font-weight:900; text-transform:uppercase;
      padding:4px 8px; border-radius:999px;
      border:1px solid rgba(22,163,74,.35);
      background:rgba(22,163,74,.08);
      color:#0f172a;
      white-space:nowrap;
      display:none;
    }
    .saved-pill.show{ display:inline-flex; }
    .saved-pill span{ color:var(--muted); font-weight:800; margin-left:6px; text-transform:none; }

    /* Form meta */
    .meta-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media(max-width:900px){ .meta-grid{ grid-template-columns:1fr; } }
    .field{ display:flex; flex-direction:column; gap:6px; }
    .label{ font-size:12px; font-weight:900; text-transform:uppercase; color:#334155; letter-spacing:.2px; }
    .input, .textarea, .select{
      width:100%;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:10px;
      font-size:13px;
      outline:none;
      font-family:inherit;
    }
    .textarea{ min-height:76px; resize:vertical; }
    .input:focus, .textarea:focus, .select:focus{
      border-color: rgba(17,85,178,.7);
      box-shadow:0 0 0 3px rgba(17,85,178,.12);
    }

    /* Step 1: Ideas vs Clusters separation */
    .step1-grid{ display:grid; grid-template-columns:1.2fr .8fr; gap:12px; }
    @media(max-width:980px){ .step1-grid{ grid-template-columns:1fr; } }

    .panel{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      background:#fff;
    }
    .panel h4{
      margin:0 0 6px;
      font-size:13px;
      font-weight:900;
      text-transform:uppercase;
      color:var(--dark);
    }
    .hint{ margin:0; font-size:12px; color:var(--muted); }

    .item{
      background:var(--note);
      border-left:3px solid #fbc02d;
      border-radius:3px;
      padding:8px 10px;
      box-shadow:2px 2px 4px rgba(0,0,0,0.05);
      position:relative;
    }
    .item-top{ display:flex; justify-content:space-between; gap:8px; align-items:flex-start; }
    .item-text{ margin:0; font-size:13px; color:#0f172a; font-weight:800; }
    .item-meta{ margin:4px 0 0; font-size:12px; color:var(--muted); }
    .item-actions{ display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end; }
    .x{
      border:none; background:transparent; cursor:pointer; font-size:18px; line-height:1;
      color:#94a3b8; padding:0 2px;
    }
    .x:hover{ color:var(--red); }

    .list{ display:flex; flex-direction:column; gap:8px; margin-top:10px; }
    .divider{ height:1px; background:#eef2f7; margin:12px 0; }

    .tag{
      display:inline-flex; align-items:center; gap:6px;
      border:1px solid rgba(17,85,178,.25);
      color:#0f172a;
      font-weight:900;
      font-size:11px;
      text-transform:uppercase;
      border-radius:999px;
      padding:4px 8px;
      background:#fff;
      white-space:nowrap;
    }

    /* Step 2: Evaluation */
    .eval-list .eval-card{
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:12px;
      background:#fff;
      box-shadow:0 6px 18px rgba(27,51,92,.05);
    }
    .eval-head{ display:flex; justify-content:space-between; gap:10px; flex-wrap:wrap; align-items:flex-start; }
    .eval-title{ margin:0; font-weight:900; color:#0f172a; font-size:13px; text-transform:uppercase; letter-spacing:.2px; }
    .eval-body{ margin-top:10px; display:grid; grid-template-columns: 1.2fr .8fr; gap:12px; align-items:start; }
    @media(max-width:980px){ .eval-body{ grid-template-columns:1fr; } }
    .eval-controls{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .eval-controls .field{ gap:4px; }
    .ryg{ display:flex; gap:8px; flex-wrap:wrap; }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      border-radius:999px;
      padding:6px 10px;
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:12px;
      background:#fff;
    }
    .dot{ width:12px; height:12px; border-radius:50%; display:inline-block; }
    .pill.red .dot{ background:var(--red); }
    .pill.yellow .dot{ background:var(--yellow); }
    .pill.green .dot{ background:var(--green); }
    .pill input{ position:absolute; opacity:0; width:1px; height:1px; }
    .pill.selected{ box-shadow:0 6px 14px rgba(0,0,0,.08); transform:translateY(-1px); }
    .pill.red.selected{ border-color: rgba(229,62,62,.55); background: rgba(229,62,62,.08); }
    .pill.yellow.selected{ border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.10); }
    .pill.green.selected{ border-color: rgba(22,163,74,.55); background: rgba(22,163,74,.08); }

    .eval-textarea{ min-height:64px; }

    /* Step 3: Measures */
    .measure-table{ display:flex; flex-direction:column; gap:10px; }
    .measure-row{
      border:1px solid #e2e8f0;
      border-radius:var(--radius);
      padding:10px;
      background:#fff;
      display:grid;
      grid-template-columns: 1.3fr .55fr .55fr .55fr;
      gap:10px;
      align-items:start;
      position:relative;
      padding-right: 38px;
    }
    @media(max-width:980px){ .measure-row{ grid-template-columns:1fr; } }
    .measure-row textarea{
      border:none; outline:none; background:transparent; resize:vertical; min-height:56px; font-family:inherit; font-size:13px;
    }
    .measure-row input, .measure-row select{
      width:100%;
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:10px;
      font-size:13px;
      outline:none;
      background:#fff;
    }
    .measure-row input:focus, .measure-row select:focus{
      border-color: rgba(17,85,178,.7);
      box-shadow:0 0 0 3px rgba(17,85,178,.12);
    }

    .status-badge{
      display:inline-flex;
      align-items:center;
      padding:4px 10px;
      border-radius:999px;
      font-weight:900;
      font-size:11px;
      text-transform:uppercase;
      border:1px solid var(--border);
      background:#fff;
      white-space:nowrap;
      color:#0f172a;
    }
    .status-open{ border-color: rgba(245,158,11,.35); background: rgba(245,158,11,.10); }
    .status-done{ border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08); }
    .status-drop{ border-color: rgba(229,62,62,.35); background: rgba(229,62,62,.08); }

    .measure-x{
      position:absolute; top:8px; right:10px;
      border:none; background:transparent; cursor:pointer;
      font-size:18px; line-height:1; color:#94a3b8;
    }
    .measure-x:hover{ color:var(--red); }

    .filters{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .filters .select{ width:auto; min-width:220px; }

    /* Footer */
    .footer{
      padding:12px 25px;
      background:var(--light-bg);
      border-top:1px solid var(--border);
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .footer a{ color:var(--dark); font-weight:800; text-decoration:none; }
    .footer a:hover{ text-decoration:underline; }

    /* More section */
    .more{ margin-top: 10px; padding-top: 18px; border-top: 2px solid var(--blue); }
    .more-title{ margin:0 0 6px; font-size:13px; color:var(--dark); text-transform:uppercase; font-weight:900; }
    .more-sub{ margin:0 0 10px; font-size:13px; color:var(--muted); }

    /* Bottom export actions */
    .bottom-actions{
      margin-top: 18px;
      padding-top: 16px;
      border-top:2px solid var(--blue);
      display:flex; gap:10px; flex-wrap:wrap;
      align-items:center;
    }

    /* Toast */
    .toast{
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f172a;
      color:#fff;
      padding: 12px 18px;
      border-radius: 999px;
      font-size: 14px;
      z-index: 9999;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s;
      box-shadow: 0 10px 22px rgba(0,0,0,.18);
    }
    .toast.show{ opacity: 1; }

    /* Print */
    @media print{
      .top-actions, .lang, .btn, .bottom-actions, .toast { display:none !important; }
      .card{ box-shadow:none !important; border:none !important; }
      .app{ margin:0 !important; }
      .body{ padding:0 !important; }
      .section{ border:none !important; }
      .more a{ text-decoration:underline; }
    }
  </style>
</head>

<body>
  <div id="qm-brainstorm-app" class="app">
    <section class="card">
      <!-- Intro -->
      <section class="intro">
        <div class="intro-top">
          <div>
            <h2 class="title" data-i18n="title">Brainstorming Tool – Ideen, Bewertung & Maßnahmen</h2>
            <p class="sub" data-i18n="subtitle">
              Strukturierter Workflow: <strong>1) Brainstorming</strong> → <strong>2) Bewerten</strong> → <strong>3) Maßnahmen</strong>.
              Alles läuft lokal im Browser (Autosave) – mit JSON Import/Export und Print.
            </p>
          </div>

          <div class="top-actions">
            <div class="lang" aria-label="Language switch">
              <button type="button" class="btn small" id="btnLangDE">DE</button>
              <button type="button" class="btn small" id="btnLangEN">EN</button>
            </div>
            <a class="btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
          </div>
        </div>

        <div class="grid">
          <div class="box">
            <h3 data-i18n="boxNameTitle">Name Tool</h3>
            <p data-i18n="boxNameText">Brainstorming – Ideen + Cluster + Bewertung + Maßnahmen</p>
          </div>

          <div class="box">
            <h3 data-i18n="boxGoalTitle">Ziel</h3>
            <p data-i18n="boxGoalText">Ideen sammeln, sauber clustern, bewerten und in umsetzbare Maßnahmen überführen.</p>
          </div>

          <div class="box">
            <h3 data-i18n="boxHowTitle">So benutzt du das Tool</h3>
            <ol>
              <li data-i18n="step1">Thema/Ziel/Scope ausfüllen und speichern.</li>
              <li data-i18n="step2">Ideen sammeln (Brainstorming) und optional Clustern.</li>
              <li data-i18n="step3">Ideen in die Bewertung übernehmen, Rot/Gelb/Grün setzen und speichern.</li>
              <li data-i18n="step4">Aus Rot/Gelb Maßnahmen erzeugen: Termin/Owner/Status pflegen.</li>
              <li data-i18n="step5">Am Ende: Drucken oder JSON sichern/laden.</li>
            </ol>
          </div>

          <div class="box privacy">
            <h3 data-i18n="boxPrivacyTitle">Datenschutz</h3>
            <p data-i18n="boxPrivacyText">
              Dieses Tool arbeitet vollständig im Browser. Es werden keine Daten an einen Server übertragen.
              Autosave erfolgt lokal im Browser (LocalStorage). JSON-Dateien werden lokal gespeichert/geladen.
            </p>
          </div>
        </div>
      </section>

      <div class="body">
        <!-- SECTION: Meta -->
        <section class="section" aria-label="Thema Ziel Scope">
          <div class="section-head">
            <div>
              <h3 class="sec-title" data-i18n="metaTitle">1) Thema / Ziel / Scope</h3>
              <p class="sec-sub" data-i18n="metaSub">Diese Angaben werden gespeichert und erscheinen im Print.</p>
            </div>
            <div class="sec-actions">
              <span class="saved-pill" id="pillMeta">✓ <span id="pillMetaTs"></span></span>
              <button type="button" class="btn" id="btnSaveMeta" data-i18n="btnSave">Speichern</button>
            </div>
          </div>

          <div class="meta-grid">
            <div class="field">
              <label class="label" for="metaTopic" data-i18n="topicLabel">Thema</label>
              <input id="metaTopic" class="input" type="text" data-i18n-placeholder="topicPh" placeholder="z.B. Lieferfähigkeit verbessern" />
            </div>
            <div class="field">
              <label class="label" for="metaOwner" data-i18n="ownerLabel">Owner / Verantwortlich</label>
              <input id="metaOwner" class="input" type="text" data-i18n-placeholder="ownerPh" placeholder="z.B. Operations / QM" />
            </div>
            <div class="field">
              <label class="label" for="metaGoal" data-i18n="goalLabel">Ziel / Outcome</label>
              <textarea id="metaGoal" class="textarea" data-i18n-placeholder="goalPh" placeholder="Was soll am Ende erreicht sein?"></textarea>
            </div>
            <div class="field">
              <label class="label" for="metaScope" data-i18n="scopeLabel">Scope / Notizen</label>
              <textarea id="metaScope" class="textarea" data-i18n-placeholder="scopePh" placeholder="Rahmen, Grenzen, Annahmen, Kontext..."></textarea>
            </div>
          </div>
        </section>

        <!-- SECTION: Step 1 -->
        <section class="section" aria-label="Brainstorming">
          <div class="section-head">
            <div>
              <h3 class="sec-title" data-i18n="bsTitle">2) Brainstorming</h3>
              <p class="sec-sub" data-i18n="bsSub">Ideen sammeln und (optional) in Cluster einordnen – strikt getrennt.</p>
            </div>
            <div class="sec-actions">
              <span class="saved-pill" id="pillBS">✓ <span id="pillBSTs"></span></span>
              <button type="button" class="btn" id="btnSaveBS" data-i18n="btnSave">Speichern</button>
              <button type="button" class="btn danger" id="btnClearBS" data-i18n="btnClearBS">Leeren</button>
            </div>
          </div>

          <div class="step1-grid">
            <!-- Ideas panel -->
            <div class="panel" aria-label="Ideen Liste">
              <h4 data-i18n="ideasTitle">Ideen</h4>
              <p class="hint" data-i18n="ideasHint">Kurz formulieren. Du kannst später bewerten und Maßnahmen ableiten.</p>

              <div class="divider"></div>

              <div class="field">
                <label class="label" for="ideaInput" data-i18n="ideaLabel">Neue Idee</label>
                <textarea id="ideaInput" class="textarea" data-i18n-placeholder="ideaPh" placeholder="Idee eingeben..."></textarea>
              </div>

              <div class="sec-actions" style="justify-content:flex-end; margin-top:10px;">
                <button type="button" class="btn primary" id="btnAddIdea" data-i18n="btnAddIdea">+ Idee hinzufügen</button>
              </div>

              <div class="list" id="ideasList"></div>
            </div>

            <!-- Cluster panel -->
            <div class="panel" aria-label="Cluster">
              <h4 data-i18n="clusterTitle">Cluster</h4>
              <p class="hint" data-i18n="clusterHint">Erstelle Cluster und ordne Ideen zu. Cluster und Ideenlisten bleiben getrennt.</p>

              <div class="divider"></div>

              <div class="field">
                <label class="label" for="clusterInput" data-i18n="clusterLabel">Neuer Cluster</label>
                <input id="clusterInput" class="input" type="text" data-i18n-placeholder="clusterPh" placeholder="z.B. Lieferanten / Prozess / IT" />
              </div>

              <div class="sec-actions" style="justify-content:flex-end; margin-top:10px;">
                <button type="button" class="btn" id="btnAddCluster" data-i18n="btnAddCluster">+ Cluster</button>
              </div>

              <div class="list" id="clustersList"></div>

              <div class="divider"></div>

              <div class="field">
                <label class="label" for="assignIdea" data-i18n="assignIdeaLabel">Idee auswählen</label>
                <select id="assignIdea" class="select"></select>
              </div>
              <div class="field">
                <label class="label" for="assignCluster" data-i18n="assignClusterLabel">Cluster auswählen</label>
                <select id="assignCluster" class="select"></select>
              </div>
              <div class="sec-actions" style="justify-content:flex-end; margin-top:10px;">
                <button type="button" class="btn" id="btnAssign" data-i18n="btnAssign">Zuordnen</button>
              </div>

              <p class="hint" style="margin-top:10px;" data-i18n="assignHint">
                Hinweis: Eine Idee kann in genau einem Cluster liegen (änderbar).
              </p>
            </div>
          </div>
        </section>

        <!-- SECTION: Step 2 -->
        <section class="section" aria-label="Bewertung">
          <div class="section-head">
            <div>
              <h3 class="sec-title" data-i18n="evalTitle">3) Bewerten</h3>
              <p class="sec-sub" data-i18n="evalSub">Übernimm Ideen aus dem Brainstorming. Setze Rot/Gelb/Grün und speichere sichtbar.</p>
            </div>
            <div class="sec-actions">
              <span class="saved-pill" id="pillEval">✓ <span id="pillEvalTs"></span></span>
              <button type="button" class="btn" id="btnSaveEval" data-i18n="btnSave">Speichern</button>
            </div>
          </div>

          <div class="filters">
            <div class="field" style="min-width:260px;">
              <label class="label" for="pickIdea" data-i18n="pickIdeaLabel">Idee öffnen (in Bewertung)</label>
              <select id="pickIdea" class="select"></select>
            </div>
            <button type="button" class="btn primary" id="btnOpenIdea" data-i18n="btnOpenIdea">Öffnen</button>
            <span class="hint" data-i18n="openIdeaHint">Die Idee erscheint unten als Bewertungskarte.</span>
          </div>

          <div class="divider"></div>

          <div class="eval-list" id="evalList"></div>
        </section>

        <!-- SECTION: Step 3 -->
        <section class="section" aria-label="Maßnahmen">
          <div class="section-head">
            <div>
              <h3 class="sec-title" data-i18n="measTitle">4) Maßnahmen</h3>
              <p class="sec-sub" data-i18n="measSub">Aus Rot/Gelb werden Maßnahmen (mit Termin/Owner/Status). Alles ist veränderbar.</p>
            </div>
            <div class="sec-actions">
              <span class="saved-pill" id="pillMeas">✓ <span id="pillMeasTs"></span></span>
              <button type="button" class="btn" id="btnSaveMeas" data-i18n="btnSave">Speichern</button>
              <button type="button" class="btn primary" id="btnFromEval" data-i18n="btnFromEval">Aus Rot/Gelb erzeugen</button>
              <button type="button" class="btn" id="btnAddMeas" data-i18n="btnAddMeas">+ Maßnahme</button>
            </div>
          </div>

          <div class="filters">
            <div class="field" style="min-width:260px;">
              <label class="label" for="filterStatus" data-i18n="filterStatus">Filter Status</label>
              <select id="filterStatus" class="select">
                <option value="all" data-i18n="filterAll">Alle</option>
                <option value="open" data-i18n="statusOpen">Offen</option>
                <option value="done" data-i18n="statusDone">Abgeschlossen</option>
                <option value="dropped" data-i18n="statusDropped">Verworfen</option>
              </select>
            </div>
            <div class="hint" data-i18n="measHint">Tipp: Status wechseln, Maßnahmen löschen oder Termine anpassen.</div>
          </div>

          <div class="divider"></div>

          <div class="measure-table" id="measuresList"></div>
        </section>

        <!-- Bottom: Print/JSON (must be near bottom, before More Infos) -->
        <div class="bottom-actions" aria-label="Export und Daten">
          <button type="button" class="btn primary" id="btnPrint" data-i18n="btnPrint">Drucken</button>
          <button type="button" class="btn" id="btnExportJson" data-i18n="btnExportJson">JSON speichern</button>
          <button type="button" class="btn" id="btnImportJson" data-i18n="btnImportJson">JSON laden</button>
          <input type="file" id="jsonFile" accept="application/json" style="display:none;" />
          <button type="button" class="btn danger" id="btnResetAll" data-i18n="btnResetAll">Reset</button>
        </div>

        <!-- More infos -->
        <section class="more">
          <h3 class="more-title" data-i18n="moreTitle">Weiterführende Infos</h3>
          <p class="more-sub" data-i18n="moreSub">Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).</p>

          <div class="grid">
            <div class="box">
              <h3 data-i18n="lexTitle">Lexikon</h3>
              <p data-i18n="lexText">Methodenwissen zu Brainstorming, Bewertung und Umsetzung.</p>
              <p style="margin-top:8px;">
                <a href="https://www.quality.de/lexikon/" target="_blank" rel="noopener" data-i18n="lexLink">Zum Lexikon</a>
              </p>
            </div>

            <div class="box">
              <h3 data-i18n="trainTitle">Ausbildungen &amp; Seminare</h3>
              <p data-i18n="trainText">Vertiefe deine Methodenkompetenz im Qualitätsmanagement:</p>
              <ol style="margin:8px 0 0; padding-left:18px;">
                <li><a href="https://www.quality.de/weiterbildung/kvp/" target="_blank" rel="noopener" data-i18n="trainKvp">KVP Seminare</a></li>
                <li><a href="https://www.quality.de/weiterbildung/qualitaetsmanagement/" target="_blank" rel="noopener" data-i18n="trainQm">Qualitätsmanagement</a></li>
              </ol>
            </div>
          </div>
        </section>
      </div>

      <footer class="footer">
        <div>© <span id="year"></span></div>
        <div><a href="https://www.quality.de/" target="_blank" rel="noopener">Quality Services &amp; Wissen GmbH</a></div>
      </footer>
    </section>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

<script>
(function(){
  const ROOT = document.getElementById("qm-brainstorm-app");
  if(!ROOT) return;

  const STORAGE_KEY = "qm_brainstorm_v1_state";

  const $ = (sel)=> ROOT.querySelector(sel);
  const $$ = (sel)=> Array.from(ROOT.querySelectorAll(sel));

  function nowTs(){
    const d = new Date();
    const pad = (n)=> String(n).padStart(2,"0");
    return pad(d.getDate())+"."+pad(d.getMonth()+1)+"."+d.getFullYear()+" "+pad(d.getHours())+":"+pad(d.getMinutes());
  }

  function toast(msg){
    const t = document.getElementById("toast");
    if(!t) return;
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(toast._t);
    toast._t = setTimeout(()=> t.classList.remove("show"), 2400);
  }

  function esc(s){
    return String(s ?? "")
      .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
  }

  function clamp(n,a,b){ return Math.max(a, Math.min(b, n)); }

  // i18n
  const I18N = {
    de:{
      title:"Brainstorming Tool – Ideen, Bewertung & Maßnahmen",
      subtitle:"Strukturierter Workflow: 1) Brainstorming → 2) Bewerten → 3) Maßnahmen. Alles läuft lokal im Browser (Autosave) – mit JSON Import/Export und Print.",
      backHome:"Zurück zur Startseite",

      boxNameTitle:"Name Tool",
      boxNameText:"Brainstorming – Ideen + Cluster + Bewertung + Maßnahmen",
      boxGoalTitle:"Ziel",
      boxGoalText:"Ideen sammeln, sauber clustern, bewerten und in umsetzbare Maßnahmen überführen.",
      boxHowTitle:"So benutzt du das Tool",
      step1:"Thema/Ziel/Scope ausfüllen und speichern.",
      step2:"Ideen sammeln (Brainstorming) und optional Clustern.",
      step3:"Ideen in die Bewertung übernehmen, Rot/Gelb/Grün setzen und speichern.",
      step4:"Aus Rot/Gelb Maßnahmen erzeugen: Termin/Owner/Status pflegen.",
      step5:"Am Ende: Drucken oder JSON sichern/laden.",
      boxPrivacyTitle:"Datenschutz",
      boxPrivacyText:"Dieses Tool arbeitet vollständig im Browser. Es werden keine Daten an einen Server übertragen. Autosave erfolgt lokal im Browser (LocalStorage). JSON-Dateien werden lokal gespeichert/geladen.",

      btnSave:"Speichern",
      btnPrint:"Drucken",
      btnExportJson:"JSON speichern",
      btnImportJson:"JSON laden",
      btnResetAll:"Reset",

      metaTitle:"1) Thema / Ziel / Scope",
      metaSub:"Diese Angaben werden gespeichert und erscheinen im Print.",
      topicLabel:"Thema",
      ownerLabel:"Owner / Verantwortlich",
      goalLabel:"Ziel / Outcome",
      scopeLabel:"Scope / Notizen",
      topicPh:"z.B. Lieferfähigkeit verbessern",
      ownerPh:"z.B. Operations / QM",
      goalPh:"Was soll am Ende erreicht sein?",
      scopePh:"Rahmen, Grenzen, Annahmen, Kontext...",

      bsTitle:"2) Brainstorming",
      bsSub:"Ideen sammeln und (optional) in Cluster einordnen – strikt getrennt.",
      btnClearBS:"Leeren",

      ideasTitle:"Ideen",
      ideasHint:"Kurz formulieren. Du kannst später bewerten und Maßnahmen ableiten.",
      ideaLabel:"Neue Idee",
      ideaPh:"Idee eingeben...",
      btnAddIdea:"+ Idee hinzufügen",
      openInEval:"In Bewertung öffnen",
      delete:"Löschen",
      clusterTag:"Cluster",

      clusterTitle:"Cluster",
      clusterHint:"Erstelle Cluster und ordne Ideen zu. Cluster und Ideenlisten bleiben getrennt.",
      clusterLabel:"Neuer Cluster",
      clusterPh:"z.B. Lieferanten / Prozess / IT",
      btnAddCluster:"+ Cluster",
      assignIdeaLabel:"Idee auswählen",
      assignClusterLabel:"Cluster auswählen",
      btnAssign:"Zuordnen",
      assignHint:"Hinweis: Eine Idee kann in genau einem Cluster liegen (änderbar).",

      evalTitle:"3) Bewerten",
      evalSub:"Übernimm Ideen aus dem Brainstorming. Setze Rot/Gelb/Grün und speichere sichtbar.",
      pickIdeaLabel:"Idee öffnen (in Bewertung)",
      btnOpenIdea:"Öffnen",
      openIdeaHint:"Die Idee erscheint unten als Bewertungskarte.",
      prioLabel:"Priorität (Rot/Gelb/Grün)",
      red:"Rot",
      yellow:"Gelb",
      green:"Grün",
      impactLabel:"Impact (1–5)",
      effortLabel:"Aufwand (1–5)",
      noteLabel:"Notiz / Begründung",
      notePh:"Warum ist diese Idee wichtig? Was prüfen wir?",
      btnToMeasures:"Als Maßnahme übernehmen",
      saved:"Gespeichert",

      measTitle:"4) Maßnahmen",
      measSub:"Aus Rot/Gelb werden Maßnahmen (mit Termin/Owner/Status). Alles ist veränderbar.",
      btnFromEval:"Aus Rot/Gelb erzeugen",
      btnAddMeas:"+ Maßnahme",
      filterStatus:"Filter Status",
      filterAll:"Alle",
      statusOpen:"Offen",
      statusDone:"Abgeschlossen",
      statusDropped:"Verworfen",
      measHint:"Tipp: Status wechseln, Maßnahmen löschen oder Termine anpassen.",
      measTextPh:"Maßnahme (Was? Wirkung?) – Bezug zur Idee…",
      dueLabel:"Termin",
      ownerShort:"Owner",
      statusLabel:"Status",
      deleteMeasure:"Maßnahme löschen",

      moreTitle:"Weiterführende Infos",
      moreSub:"Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).",
      lexTitle:"Lexikon",
      lexText:"Methodenwissen zu Brainstorming, Bewertung und Umsetzung.",
      lexLink:"Zum Lexikon",
      trainTitle:"Ausbildungen & Seminare",
      trainText:"Vertiefe deine Methodenkompetenz im Qualitätsmanagement:",
      trainKvp:"KVP Seminare",
      trainQm:"Qualitätsmanagement",

      confirmReset:"Alles löschen?"
    },
    en:{
      title:"Brainstorming Tool – Ideas, Evaluation & Actions",
      subtitle:"Structured workflow: 1) Brainstorming → 2) Evaluate → 3) Actions. Runs locally in your browser (autosave) – with JSON import/export and print.",
      backHome:"Back to home",

      boxNameTitle:"Tool name",
      boxNameText:"Brainstorming – Ideas + Clusters + Evaluation + Actions",
      boxGoalTitle:"Goal",
      boxGoalText:"Collect ideas, cluster them cleanly, evaluate, and turn them into actionable measures.",
      boxHowTitle:"How to use this tool",
      step1:"Fill topic/goal/scope and save.",
      step2:"Collect ideas (brainstorm) and optionally cluster them.",
      step3:"Move ideas into evaluation, set Red/Yellow/Green and save visibly.",
      step4:"Turn Red/Yellow into actions: due date/owner/status.",
      step5:"At the end: print or save/load JSON.",
      boxPrivacyTitle:"Privacy",
      boxPrivacyText:"This tool runs entirely in your browser. No data is sent to a server. Autosave is local (LocalStorage). JSON files are saved/loaded locally.",

      btnSave:"Save",
      btnPrint:"Print",
      btnExportJson:"Save JSON",
      btnImportJson:"Load JSON",
      btnResetAll:"Reset",

      metaTitle:"1) Topic / Goal / Scope",
      metaSub:"These fields are saved and included in print.",
      topicLabel:"Topic",
      ownerLabel:"Owner / Responsible",
      goalLabel:"Goal / Outcome",
      scopeLabel:"Scope / Notes",
      topicPh:"e.g. Improve delivery performance",
      ownerPh:"e.g. Operations / Quality",
      goalPh:"What should be achieved?",
      scopePh:"Constraints, assumptions, context...",

      bsTitle:"2) Brainstorming",
      bsSub:"Collect ideas and (optionally) assign clusters – strictly separated.",
      btnClearBS:"Clear",

      ideasTitle:"Ideas",
      ideasHint:"Keep it short. You can evaluate and derive actions later.",
      ideaLabel:"New idea",
      ideaPh:"Enter idea...",
      btnAddIdea:"+ Add idea",
      openInEval:"Open in evaluation",
      delete:"Delete",
      clusterTag:"Cluster",

      clusterTitle:"Clusters",
      clusterHint:"Create clusters and assign ideas. Cluster list and idea list remain separate.",
      clusterLabel:"New cluster",
      clusterPh:"e.g. Suppliers / Process / IT",
      btnAddCluster:"+ Cluster",
      assignIdeaLabel:"Select idea",
      assignClusterLabel:"Select cluster",
      btnAssign:"Assign",
      assignHint:"Note: One idea can belong to one cluster (changeable).",

      evalTitle:"3) Evaluate",
      evalSub:"Bring ideas from brainstorming. Set Red/Yellow/Green and save visibly.",
      pickIdeaLabel:"Open idea (in evaluation)",
      btnOpenIdea:"Open",
      openIdeaHint:"The idea appears below as an evaluation card.",
      prioLabel:"Priority (Red/Yellow/Green)",
      red:"Red",
      yellow:"Yellow",
      green:"Green",
      impactLabel:"Impact (1–5)",
      effortLabel:"Effort (1–5)",
      noteLabel:"Note / rationale",
      notePh:"Why does it matter? What will we verify?",
      btnToMeasures:"Convert to action",
      saved:"Saved",

      measTitle:"4) Actions",
      measSub:"Red/Yellow become actions (with due date/owner/status). Everything is editable.",
      btnFromEval:"Create from Red/Yellow",
      btnAddMeas:"+ Action",
      filterStatus:"Filter status",
      filterAll:"All",
      statusOpen:"Open",
      statusDone:"Completed",
      statusDropped:"Discarded",
      measHint:"Tip: Change status, delete actions, or adjust due dates.",
      measTextPh:"Action (what? impact?) – reference to the idea…",
      dueLabel:"Due date",
      ownerShort:"Owner",
      statusLabel:"Status",
      deleteMeasure:"Delete action",

      moreTitle:"More information",
      moreSub:"Glossary & relevant training (opens in a new tab).",
      lexTitle:"Glossary",
      lexText:"Methods for brainstorming, evaluation and execution.",
      lexLink:"Open glossary",
      trainTitle:"Training & courses",
      trainText:"Deepen your quality-method skills:",
      trainKvp:"CIP / KVP training",
      trainQm:"Quality management",

      confirmReset:"Delete everything?"
    }
  };

  let currentLang = localStorage.getItem("qmLang") || (navigator.language && navigator.language.toLowerCase().startsWith("de") ? "de" : "en");

  function t(key){
    return (I18N[currentLang] && I18N[currentLang][key]) ? I18N[currentLang][key] : key;
  }

  function applyI18n(){
    document.documentElement.lang = currentLang;
    $$("[data-i18n]").forEach(el=> el.textContent = t(el.dataset.i18n));
    $$("[data-i18n-placeholder]").forEach(el=> el.placeholder = t(el.dataset.i18nPlaceholder));

    $("#btnLangDE").classList.toggle("primary", currentLang==="de");
    $("#btnLangEN").classList.toggle("primary", currentLang==="en");

    // dynamic placeholders
    $$("[data-phkey]").forEach(el=>{
      el.placeholder = t(el.getAttribute("data-phkey"));
    });
  }

  function setLang(lang){
    currentLang = (lang==="de"||lang==="en") ? lang : "de";
    localStorage.setItem("qmLang", currentLang);
    applyI18n();
    toast(lang==="de" ? "Sprache: Deutsch" : "Language: English");
  }

  // State
  let state = {
    lang: currentLang,
    meta: { topic:"", owner:"", goal:"", scope:"" },
    ideas: [],          // {id,text,clusterId|null, createdAt}
    clusters: [],       // {id,name}
    eval: [],           // {id, ideaId, prio:"red|yellow|green", impact:3, effort:3, note:""}
    measures: [],       // {id, fromIdeaId, fromEvalId, text, due, owner, status:"open|done|dropped"}
    ts: new Date().toISOString()
  };

  function uid(){
    try{ return crypto.randomUUID(); }catch{ return "id_"+Math.random().toString(16).slice(2); }
  }

  // Persist / Restore
  function persist(withToast=false, pill=null){
    state.lang = currentLang;
    state.meta.topic = $("#metaTopic").value.trim();
    state.meta.owner = $("#metaOwner").value.trim();
    state.meta.goal  = $("#metaGoal").value.trim();
    state.meta.scope = $("#metaScope").value.trim();
    state.ts = new Date().toISOString();

    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    if(pill){
      pill.classList.add("show");
      const tsEl = pill.querySelector("span");
      if(tsEl) tsEl.textContent = nowTs();
    }
    if(withToast) toast(t("saved"));
  }

  function restore(){
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return false;
    try{
      const p = JSON.parse(raw);
      if(!p || typeof p !== "object") return false;

      state = {
        lang: (p.lang==="de"||p.lang==="en") ? p.lang : currentLang,
        meta: {
          topic: String(p.meta?.topic ?? ""),
          owner: String(p.meta?.owner ?? ""),
          goal:  String(p.meta?.goal ?? ""),
          scope: String(p.meta?.scope ?? "")
        },
        ideas: Array.isArray(p.ideas) ? p.ideas.map(x=>({
          id:String(x.id ?? uid()),
          text:String(x.text ?? ""),
          clusterId: x.clusterId ? String(x.clusterId) : null,
          createdAt: String(x.createdAt ?? new Date().toISOString())
        })) : [],
        clusters: Array.isArray(p.clusters) ? p.clusters.map(x=>({
          id:String(x.id ?? uid()),
          name:String(x.name ?? "")
        })) : [],
        eval: Array.isArray(p.eval) ? p.eval.map(x=>({
          id:String(x.id ?? uid()),
          ideaId:String(x.ideaId ?? ""),
          prio: (x.prio==="red"||x.prio==="yellow"||x.prio==="green") ? x.prio : "yellow",
          impact: clamp(Number(x.impact ?? 3), 1, 5),
          effort: clamp(Number(x.effort ?? 3), 1, 5),
          note: String(x.note ?? "")
        })) : [],
        measures: Array.isArray(p.measures) ? p.measures.map(x=>({
          id:String(x.id ?? uid()),
          fromIdeaId: x.fromIdeaId ? String(x.fromIdeaId) : null,
          fromEvalId: x.fromEvalId ? String(x.fromEvalId) : null,
          text:String(x.text ?? ""),
          due:String(x.due ?? ""),
          owner:String(x.owner ?? ""),
          status: (x.status==="open"||x.status==="done"||x.status==="dropped") ? x.status : "open"
        })) : [],
        ts: String(p.ts ?? new Date().toISOString())
      };

      // apply language from state
      currentLang = state.lang;
      localStorage.setItem("qmLang", currentLang);

      // fill meta inputs
      $("#metaTopic").value = state.meta.topic;
      $("#metaOwner").value = state.meta.owner;
      $("#metaGoal").value  = state.meta.goal;
      $("#metaScope").value = state.meta.scope;

      return true;
    }catch(e){
      return false;
    }
  }

  // UI Builders
  function rebuildSelects(){
    // assign selects
    const ideaSel = $("#assignIdea");
    const clSel = $("#assignCluster");
    const pickSel = $("#pickIdea");

    ideaSel.innerHTML = "";
    clSel.innerHTML = "";
    pickSel.innerHTML = "";

    // ideas
    state.ideas.forEach(idea=>{
      const opt1 = document.createElement("option");
      opt1.value = idea.id;
      opt1.textContent = idea.text ? idea.text.slice(0, 80) : "—";
      ideaSel.appendChild(opt1);

      const opt2 = document.createElement("option");
      opt2.value = idea.id;
      opt2.textContent = idea.text ? idea.text.slice(0, 80) : "—";
      pickSel.appendChild(opt2);
    });

    // clusters
    const none = document.createElement("option");
    none.value = "";
    none.textContent = "—";
    clSel.appendChild(none);

    state.clusters.forEach(c=>{
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name || "—";
      clSel.appendChild(opt);
    });

    // default selected
    if(state.ideas.length){
      ideaSel.value = state.ideas[0].id;
      pickSel.value = state.ideas[0].id;
    }
  }

  function clusterName(id){
    const c = state.clusters.find(x=>x.id===id);
    return c ? c.name : "—";
  }

  function renderIdeas(){
    const host = $("#ideasList");
    host.innerHTML = "";

    state.ideas.forEach(idea=>{
      const wrap = document.createElement("div");
      wrap.className = "item";
      const tag = idea.clusterId ? `<span class="tag">${esc(t("clusterTag"))}: ${esc(clusterName(idea.clusterId))}</span>` : "";

      wrap.innerHTML = `
        <div class="item-top">
          <div style="flex:1; min-width:220px;">
            <p class="item-text">${esc(idea.text || "—")}</p>
            <div class="item-meta">${tag}</div>
          </div>
          <div class="item-actions">
            <button type="button" class="btn small" data-act="openEval" data-id="${esc(idea.id)}">${esc(t("openInEval"))}</button>
            <button type="button" class="btn small danger" data-act="delIdea" data-id="${esc(idea.id)}">${esc(t("delete"))}</button>
          </div>
        </div>
      `;
      host.appendChild(wrap);
    });

    host.querySelectorAll('[data-act="delIdea"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        // remove idea + its eval entries (and keep measures but mark reference as null)
        state.ideas = state.ideas.filter(x=>x.id!==id);
        state.eval = state.eval.filter(x=>x.ideaId!==id);
        state.measures = state.measures.map(m => (m.fromIdeaId===id) ? {...m, fromIdeaId:null} : m);
        rebuildAll();
        persist(true, $("#pillBS"));
      });
    });

    host.querySelectorAll('[data-act="openEval"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        openIdeaToEval(btn.getAttribute("data-id"));
      });
    });
  }

  function renderClusters(){
    const host = $("#clustersList");
    host.innerHTML = "";

    state.clusters.forEach(c=>{
      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div class="item-top">
          <div style="flex:1;">
            <p class="item-text">${esc(c.name || "—")}</p>
          </div>
          <div class="item-actions">
            <button type="button" class="btn small danger" data-act="delCluster" data-id="${esc(c.id)}">${esc(t("delete"))}</button>
          </div>
        </div>
      `;
      host.appendChild(div);
    });

    host.querySelectorAll('[data-act="delCluster"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        // remove cluster and unassign ideas
        state.clusters = state.clusters.filter(x=>x.id!==id);
        state.ideas = state.ideas.map(i => (i.clusterId===id) ? {...i, clusterId:null} : i);
        rebuildAll();
        persist(true, $("#pillBS"));
      });
    });
  }

  function renderEval(){
    const host = $("#evalList");
    host.innerHTML = "";

    if(!state.eval.length){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = currentLang==="de"
        ? "Noch keine Bewertungen. Öffne eine Idee oben (Button oder Dropdown)."
        : "No evaluations yet. Open an idea above (button or dropdown).";
      host.appendChild(empty);
      return;
    }

    state.eval.forEach(e=>{
      const idea = state.ideas.find(x=>x.id===e.ideaId);
      const title = idea ? idea.text : (currentLang==="de" ? "Idee (gelöscht)" : "Idea (deleted)");

      const card = document.createElement("div");
      card.className = "eval-card";
      card.id = "eval_"+e.id;
      card.innerHTML = `
        <div class="eval-head">
          <div style="flex:1; min-width:240px;">
            <p class="eval-title">${esc(title)}</p>
            <div class="item-meta">${idea && idea.clusterId ? `<span class="tag">${esc(t("clusterTag"))}: ${esc(clusterName(idea.clusterId))}</span>` : ""}</div>
          </div>
          <div class="item-actions">
            <button type="button" class="btn small primary" data-act="toMeas" data-id="${esc(e.id)}">${esc(t("btnToMeasures"))}</button>
            <button type="button" class="btn small danger" data-act="delEval" data-id="${esc(e.id)}">${esc(t("delete"))}</button>
          </div>
        </div>

        <div class="eval-body">
          <div class="field">
            <label class="label">${esc(t("noteLabel"))}</label>
            <textarea class="textarea eval-textarea" data-phkey="notePh"></textarea>
          </div>

          <div>
            <div class="field" style="margin-bottom:10px;">
              <label class="label">${esc(t("prioLabel"))}</label>
              <div class="ryg" data-ryg="${esc(e.id)}">
                <label class="pill red" data-val="red"><span class="dot"></span>${esc(t("red"))}<input type="radio" name="prio_${esc(e.id)}"></label>
                <label class="pill yellow" data-val="yellow"><span class="dot"></span>${esc(t("yellow"))}<input type="radio" name="prio_${esc(e.id)}"></label>
                <label class="pill green" data-val="green"><span class="dot"></span>${esc(t("green"))}<input type="radio" name="prio_${esc(e.id)}"></label>
              </div>
            </div>

            <div class="eval-controls">
              <div class="field">
                <label class="label">${esc(t("impactLabel"))}</label>
                <input class="input" type="number" min="1" max="5" step="1" value="${e.impact}">
              </div>
              <div class="field">
                <label class="label">${esc(t("effortLabel"))}</label>
                <input class="input" type="number" min="1" max="5" step="1" value="${e.effort}">
              </div>
            </div>

            <div class="sec-actions" style="justify-content:flex-end; margin-top:10px;">
              <button type="button" class="btn" data-act="saveEvalOne" data-id="${esc(e.id)}">${esc(t("btnSave"))}</button>
            </div>
          </div>
        </div>
      `;

      host.appendChild(card);

      // fill note
      const note = card.querySelector("textarea");
      note.value = e.note || "";
      note.addEventListener("input", ()=>{
        e.note = note.value;
        // autosave but no toast
        persist(false);
      });

      // priority selection
      const ryg = card.querySelector(`[data-ryg="${e.id}"]`);
      const pills = Array.from(ryg.querySelectorAll(".pill"));
      function applySel(){
        pills.forEach(p=> p.classList.toggle("selected", p.getAttribute("data-val")===e.prio));
      }
      applySel();
      pills.forEach(p=>{
        p.addEventListener("click", ()=>{
          e.prio = p.getAttribute("data-val");
          applySel();
          persist(false);
        });
      });

      // impact/effort
      const nums = card.querySelectorAll('input[type="number"]');
      nums[0].addEventListener("input", ()=>{
        e.impact = clamp(Number(nums[0].value||3), 1, 5);
        persist(false);
      });
      nums[1].addEventListener("input", ()=>{
        e.effort = clamp(Number(nums[1].value||3), 1, 5);
        persist(false);
      });
    });

    host.querySelectorAll('[data-act="delEval"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-id");
        state.eval = state.eval.filter(x=>x.id!==id);
        // measures keep ref but ok
        rebuildAll();
        persist(true, $("#pillEval"));
      });
    });

    host.querySelectorAll('[data-act="saveEvalOne"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        persist(true, $("#pillEval"));
      });
    });

    host.querySelectorAll('[data-act="toMeas"]').forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const evalId = btn.getAttribute("data-id");
        const e = state.eval.find(x=>x.id===evalId);
        if(!e) return;

        // only red/yellow suggested, but allow all
        const idea = state.ideas.find(x=>x.id===e.ideaId);
        const baseText = idea ? idea.text : "";
        addMeasure({
          fromIdeaId: e.ideaId,
          fromEvalId: e.id,
          text: baseText ? baseText : "",
          due: "",
          owner: state.meta.owner || "",
          status: "open"
        }, {showToast:true});
      });
    });
  }

  function renderMeasures(){
    const host = $("#measuresList");
    host.innerHTML = "";

    const filter = $("#filterStatus").value || "all";

    const measures = state.measures.filter(m=>{
      if(filter==="all") return true;
      return m.status === filter;
    });

    if(!measures.length){
      const empty = document.createElement("div");
      empty.className = "hint";
      empty.textContent = currentLang==="de"
        ? "Noch keine Maßnahmen. Erzeuge welche aus Rot/Gelb oder füge manuell hinzu."
        : "No actions yet. Create from Red/Yellow or add manually.";
      host.appendChild(empty);
      return;
    }

    measures.forEach(m=>{
      const row = document.createElement("div");
      row.className = "measure-row";
      row.innerHTML = `
        <div>
          <div class="label" style="margin-bottom:6px;">${esc(t("measTextPh").includes("–") ? (currentLang==="de" ? "Maßnahme" : "Action") : (currentLang==="de" ? "Maßnahme" : "Action"))}</div>
          <textarea rows="2"></textarea>
          <div class="item-meta" style="margin-top:6px;">
            ${m.fromIdeaId ? `<span class="tag">Idea</span> ${esc((state.ideas.find(i=>i.id===m.fromIdeaId)?.text || "").slice(0,60))}` : ""}
          </div>
        </div>
        <div>
          <div class="label" style="margin-bottom:6px;">${esc(t("dueLabel"))}</div>
          <input type="date" />
        </div>
        <div>
          <div class="label" style="margin-bottom:6px;">${esc(t("ownerShort"))}</div>
          <input type="text" data-phkey="ownerShort" />
        </div>
        <div>
          <div class="label" style="margin-bottom:6px;">${esc(t("statusLabel"))}</div>
          <select>
            <option value="open">${esc(t("statusOpen"))}</option>
            <option value="done">${esc(t("statusDone"))}</option>
            <option value="dropped">${esc(t("statusDropped"))}</option>
          </select>
          <div style="margin-top:8px;">
            <span class="status-badge ${m.status==='open'?'status-open':(m.status==='done'?'status-done':'status-drop')}">${esc(m.status==='open'?t("statusOpen"):(m.status==='done'?t("statusDone"):t("statusDropped")))}</span>
          </div>
        </div>
        <button type="button" class="measure-x" title="${esc(t("deleteMeasure"))}" aria-label="${esc(t("deleteMeasure"))}">&times;</button>
      `;

      const ta = row.querySelector("textarea");
      const due = row.querySelector('input[type="date"]');
      const owner = row.querySelector('input[type="text"]');
      const sel = row.querySelector("select");
      const badge = row.querySelector(".status-badge");
      const del = row.querySelector(".measure-x");

      ta.value = m.text || "";
      due.value = m.due || "";
      owner.value = m.owner || "";
      sel.value = m.status || "open";

      function syncBadge(){
        badge.classList.remove("status-open","status-done","status-drop");
        badge.classList.add(m.status==='open'?'status-open':(m.status==='done'?'status-done':'status-drop'));
        badge.textContent = m.status==='open'?t("statusOpen"):(m.status==='done'?t("statusDone"):t("statusDropped"));
      }
      syncBadge();

      ta.addEventListener("input", ()=>{ m.text = ta.value; persist(false); });
      due.addEventListener("change", ()=>{ m.due = due.value; persist(false); });
      owner.addEventListener("input", ()=>{ m.owner = owner.value; persist(false); });
      sel.addEventListener("change", ()=>{ m.status = sel.value; syncBadge(); persist(false); });

      del.addEventListener("click", ()=>{
        state.measures = state.measures.filter(x=>x.id!==m.id);
        rebuildAll();
        persist(true, $("#pillMeas"));
      });

      host.appendChild(row);
    });

    applyI18n();
  }

  function openIdeaToEval(ideaId){
    if(!ideaId) return;
    // if already in eval, just scroll
    const existing = state.eval.find(x=>x.ideaId===ideaId);
    if(existing){
      rebuildAll();
      setTimeout(()=>{
        const el = document.getElementById("eval_"+existing.id);
        if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
      }, 20);
      toast(currentLang==="de" ? "Idee ist bereits in Bewertung." : "Idea is already in evaluation.");
      return;
    }

    const e = { id: uid(), ideaId, prio:"yellow", impact:3, effort:3, note:"" };
    state.eval.push(e);
    rebuildAll();
    persist(true, $("#pillEval"));

    // scroll to new card
    setTimeout(()=>{
      const el = document.getElementById("eval_"+e.id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    }, 30);
  }

  function addMeasure(m, opts={showToast:false}){
    const mm = {
      id: uid(),
      fromIdeaId: m.fromIdeaId ?? null,
      fromEvalId: m.fromEvalId ?? null,
      text: String(m.text ?? ""),
      due: String(m.due ?? ""),
      owner: String(m.owner ?? ""),
      status: (m.status==="open"||m.status==="done"||m.status==="dropped") ? m.status : "open"
    };
    state.measures.push(mm);
    rebuildAll();
    persist(true, $("#pillMeas"));
    if(opts.showToast) toast(currentLang==="de" ? "Als Maßnahme übernommen." : "Converted to action.");
  }

  function rebuildAll(){
    rebuildSelects();
    renderIdeas();
    renderClusters();
    renderEval();
    renderMeasures();
  }

  // Actions: Meta save buttons (visible)
  $("#btnSaveMeta").addEventListener("click", ()=>{
    persist(true, $("#pillMeta"));
    $("#pillMetaTs").textContent = nowTs();
    $("#pillMeta").classList.add("show");
  });

  $("#btnSaveBS").addEventListener("click", ()=>{
    persist(true, $("#pillBS"));
    $("#pillBSTs").textContent = nowTs();
    $("#pillBS").classList.add("show");
  });

  $("#btnSaveEval").addEventListener("click", ()=>{
    persist(true, $("#pillEval"));
    $("#pillEvalTs").textContent = nowTs();
    $("#pillEval").classList.add("show");
  });

  $("#btnSaveMeas").addEventListener("click", ()=>{
    persist(true, $("#pillMeas"));
    $("#pillMeasTs").textContent = nowTs();
    $("#pillMeas").classList.add("show");
  });

  // Autosave on meta input changes (no toast)
  ["metaTopic","metaOwner","metaGoal","metaScope"].forEach(id=>{
    $("#"+id).addEventListener("input", ()=> persist(false));
  });

  // Add idea
  $("#btnAddIdea").addEventListener("click", ()=>{
    const txt = $("#ideaInput").value.trim();
    if(!txt){
      toast(currentLang==="de" ? "Bitte eine Idee eingeben." : "Please enter an idea.");
      return;
    }
    state.ideas.push({ id: uid(), text: txt, clusterId: null, createdAt: new Date().toISOString() });
    $("#ideaInput").value = "";
    rebuildAll();
    persist(true, $("#pillBS"));
  });

  // Clear brainstorming
  $("#btnClearBS").addEventListener("click", ()=>{
    if(!confirm(currentLang==="de" ? "Brainstorming (Ideen/Cluster) leeren?" : "Clear brainstorming (ideas/clusters)?")) return;
    state.ideas = [];
    state.clusters = [];
    state.eval = []; // evaluation depends on ideas
    rebuildAll();
    persist(true, $("#pillBS"));
  });

  // Add cluster
  $("#btnAddCluster").addEventListener("click", ()=>{
    const name = $("#clusterInput").value.trim();
    if(!name){
      toast(currentLang==="de" ? "Bitte einen Clusternamen eingeben." : "Please enter a cluster name.");
      return;
    }
    state.clusters.push({ id: uid(), name });
    $("#clusterInput").value = "";
    rebuildAll();
    persist(true, $("#pillBS"));
  });

  // Assign idea to cluster
  $("#btnAssign").addEventListener("click", ()=>{
    const ideaId = $("#assignIdea").value;
    const clusterId = $("#assignCluster").value || null;
    if(!ideaId){
      toast(currentLang==="de" ? "Keine Idee ausgewählt." : "No idea selected.");
      return;
    }
    state.ideas = state.ideas.map(i => (i.id===ideaId) ? {...i, clusterId} : i);
    rebuildAll();
    persist(true, $("#pillBS"));
    toast(currentLang==="de" ? "Zuordnung gespeichert." : "Assignment saved.");
  });

  // Open idea to evaluation (dropdown)
  $("#btnOpenIdea").addEventListener("click", ()=>{
    const ideaId = $("#pickIdea").value;
    if(!ideaId){
      toast(currentLang==="de" ? "Keine Idee ausgewählt." : "No idea selected.");
      return;
    }
    openIdeaToEval(ideaId);
  });

  // Measures: create from red/yellow
  $("#btnFromEval").addEventListener("click", ()=>{
    const selected = state.eval.filter(e => e.prio==="red" || e.prio==="yellow");
    if(!selected.length){
      toast(currentLang==="de" ? "Keine Rot/Gelb Bewertungen gefunden." : "No Red/Yellow items found.");
      return;
    }

    // avoid duplicates: if a measure already exists for eval id, skip
    const existingEvalIds = new Set(state.measures.filter(m=>m.fromEvalId).map(m=>m.fromEvalId));
    let added = 0;

    selected.forEach(e=>{
      if(existingEvalIds.has(e.id)) return;
      const idea = state.ideas.find(i=>i.id===e.ideaId);
      addMeasure({
        fromIdeaId: e.ideaId,
        fromEvalId: e.id,
        text: idea ? idea.text : "",
        due: "",
        owner: state.meta.owner || "",
        status: "open"
      }, {showToast:false});
      added++;
    });

    persist(true, $("#pillMeas"));
    toast(currentLang==="de" ? `Maßnahmen erzeugt: ${added}` : `Actions created: ${added}`);
  });

  // Manual add measure
  $("#btnAddMeas").addEventListener("click", ()=>{
    addMeasure({
      fromIdeaId: null,
      fromEvalId: null,
      text: "",
      due: "",
      owner: state.meta.owner || "",
      status: "open"
    }, {showToast:false});
    toast(currentLang==="de" ? "Leere Maßnahme angelegt." : "Empty action added.");
  });

  // Filter measures
  $("#filterStatus").addEventListener("change", ()=> renderMeasures());

  // Bottom actions
  $("#btnPrint").addEventListener("click", ()=> window.print());

  $("#btnExportJson").addEventListener("click", ()=>{
    persist(false);
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "brainstorming_export.json";
    a.click();
  });

  $("#btnImportJson").addEventListener("click", ()=> $("#jsonFile").click());
  $("#jsonFile").addEventListener("change", (ev)=>{
    const f = ev.target.files && ev.target.files[0];
    if(!f) return;
    f.text().then(txt=>{
      const parsed = JSON.parse(txt);
      localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
      if(!restore()){
        toast(currentLang==="de" ? "JSON ungültig." : "Invalid JSON.");
        return;
      }
      rebuildAll();
      applyI18n();
      toast(currentLang==="de" ? "JSON geladen." : "JSON loaded.");
      persist(false);
    }).catch(()=>{
      toast(currentLang==="de" ? "JSON konnte nicht geladen werden." : "Could not load JSON.");
    }).finally(()=>{ ev.target.value=""; });
  });

  $("#btnResetAll").addEventListener("click", ()=>{
    if(!confirm(t("confirmReset"))) return;
    localStorage.removeItem(STORAGE_KEY);
    state = {
      lang: currentLang,
      meta:{topic:"",owner:"",goal:"",scope:""},
      ideas:[],
      clusters:[],
      eval:[],
      measures:[],
      ts: new Date().toISOString()
    };
    $("#metaTopic").value=""; $("#metaOwner").value=""; $("#metaGoal").value=""; $("#metaScope").value="";
    rebuildAll();
    persist(true, $("#pillMeta"));
    toast(currentLang==="de" ? "Zurückgesetzt." : "Reset.");
  });

  // Language
  $("#btnLangDE").addEventListener("click", ()=> setLang("de"));
  $("#btnLangEN").addEventListener("click", ()=> setLang("en"));

  // Init
  restore();
  $("#year").textContent = String(new Date().getFullYear());
  rebuildAll();
  applyI18n();

})();
</script>
</body>
</html>
