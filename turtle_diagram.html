<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Turtle Diagramm – Prozessanalyse</title>

  <style>
    :root{
      --blue:#1155b2;
      --dark:#09387a;
      --bg:#ffffff;
      --light-bg:#f8fafc;
      --border:#d1d9e6;
      --muted:#64748b;
      --text:#27304d;

      /* Turtle colors (close to screenshot) */
      --c-people:#f97316;        --bg-people:#fff7ed;
      --c-how:#eab308;           --bg-how:#fefce8;
      --c-with:#7c3aed;          --bg-with:#f5f3ff;

      --c-input:#2563eb;         --bg-input:#eff6ff;
      --c-output:#16a34a;        --bg-output:#ecfdf5;

      --c-risk:#0f172a;          --bg-risk:#f1f5f9;
      --c-kpi:#ef4444;           --bg-kpi:#fff1f2;
      --c-doc:#16a34a;           --bg-doc:#f0fdf4;

      --radius:6px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    body{ margin:0; background: var(--bg); }

    /* App shell */
    #qm-turtle-app{
      max-width: 1180px;
      margin: 18px auto;
      padding: 0 12px;
      font-family: "Segoe UI", Roboto, system-ui, -apple-system, Arial, sans-serif;
      color: var(--text);
      line-height: 1.5;
    }
    #qm-turtle-app *{ box-sizing: border-box; }
    #qm-turtle-app :focus-visible{ outline: 2px solid var(--blue); outline-offset: 2px; }

    .card{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    /* Header / Intro */
    .tool-intro{
      padding: 18px 20px;
      border-bottom: 3px solid var(--blue);
      background: var(--light-bg);
    }
    .intro-top{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tool-title{
      margin:0;
      color: var(--dark);
      font-size: 20px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .4px;
    }
    .tool-sub{ margin: 6px 0 0; font-size: 13px; color: var(--muted); max-width: 70ch; }

    .top-actions{
      display:flex; gap: 10px; align-items:center; flex-wrap: wrap; justify-content:flex-end;
    }

    .btn{
      padding: 10px 14px;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing: .3px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background:#fff;
      color: var(--dark);
      cursor:pointer;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    .btn:hover{ background:#f1f5f9; border-color: rgba(17,85,178,.35); }
    .btn.primary{ background: var(--blue); color:#fff; border-color: var(--blue); }
    .btn.primary:hover{ background: var(--dark); border-color: var(--dark); }
    .btn.danger{ color:#e53e3e; border-color: rgba(229,62,62,.35); }
    .btn.small{ padding: 8px 10px; font-size: 11px; }

    .lang-switch{ display:flex; gap: 8px; align-items:center; }
    .lang-switch .btn{ padding: 8px 10px; }

    .tool-grid{
      margin-top: 14px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media(max-width: 900px){ .tool-grid{ grid-template-columns: 1fr; } }

    .tool-box{
      background:#fff;
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
    }
    .tool-box h3{
      margin:0 0 6px;
      font-size: 13px;
      color: var(--dark);
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.25px;
    }
    .tool-box p, .tool-box ol{ margin:0; font-size: 13px; color:#334155; }
    .tool-box ol{ padding-left: 18px; }
    .tool-privacy{ border-left: 3px solid var(--blue); }

    .tool-box a{ color: var(--blue); text-decoration:none; font-weight: 800; }
    .tool-box a:hover{ text-decoration: underline; }

    .group-title{
      margin:0 0 6px;
      font-size:12px;
      font-weight:900;
      text-transform:uppercase;
      letter-spacing:.25px;
      color:#0f172a;
    }
    .split-ol{ margin:0; padding-left:18px; }
    .split-ol li{ margin:2px 0; }

    /* Badge */
    #qm-turtle-app .badge{
      display:inline-flex; align-items:center; justify-content:center;
      border-radius:999px; padding:4px 10px;
      font-size:11px; font-weight:900; text-transform:uppercase; letter-spacing:.3px;
      border:1px solid var(--border); background:#fff; color:#0f172a;
    }
    #qm-turtle-app .badge.premium{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#7c2d12; }
    #qm-turtle-app .badge.api{ border-color:rgba(17,85,178,.35); background:rgba(17,85,178,.08); color:var(--dark); }
    #qm-turtle-app .badge.lic{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.08); color:#14532d; }

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border); border-radius:999px; padding:6px 10px;
      font-size:12px; font-weight:900; background:#fff; color:#0f172a;
    }
    .pill.warn{ border-color:rgba(245,158,11,.35); background:rgba(245,158,11,.10); color:#7c2d12; }
    .pill.bad{ border-color:rgba(229,62,62,.35); background:rgba(229,62,62,.08); color:#7f1d1d; }
    .pill.ok{ border-color:rgba(22,163,74,.35); background:rgba(22,163,74,.08); color:#14532d; }

    /* Turtle header line (like screenshot) */
    .turtle-strip{
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      margin: 18px 0 10px;
      padding: 0 4px;
      color:#334155;
      font-size: 14px;
      font-weight: 800;
    }
    .turtle-strip strong{ color: var(--dark); font-weight: 900; }

    /* Diagram grid */
    .body{ padding: 18px 20px; }
    .diagram-wrap{
      border:1px solid #edf2f7;
      border-radius: var(--radius);
      background:#fff;
      padding: 14px;
    }
    .turtle-grid{
      display:grid;
      grid-template-columns: 1fr 1.15fr 1fr;
      gap: 12px;
    }
    @media(max-width: 980px){ .turtle-grid{ grid-template-columns: 1fr; } }

    .tbox{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      overflow:hidden;
      display:flex;
      flex-direction: column;
      min-height: 210px;
    }
    .tbox.headline-only{ min-height: 240px; }

    .tbox[data-color="people"]{ border-color: rgba(249,115,22,.25); background: var(--bg-people); }
    .tbox[data-color="how"]{ border-color: rgba(234,179,8,.28); background: var(--bg-how); }
    .tbox[data-color="with"]{ border-color: rgba(124,58,237,.22); background: var(--bg-with); }
    .tbox[data-color="input"]{ border-color: rgba(37,99,235,.22); background: var(--bg-input); }
    .tbox[data-color="output"]{ border-color: rgba(22,163,74,.22); background: var(--bg-output); }
    .tbox[data-color="risk"]{ border-color: rgba(15,23,42,.18); background: var(--bg-risk); }
    .tbox[data-color="kpi"]{ border-color: rgba(239,68,68,.20); background: var(--bg-kpi); }
    .tbox[data-color="doc"]{ border-color: rgba(22,163,74,.18); background: var(--bg-doc); }
    .tbox[data-color="process"]{ border-color: rgba(2,6,23,.12); background: #fff; }

    .tbox[data-color="people"]{ box-shadow: inset 4px 0 0 var(--c-people); }
    .tbox[data-color="how"]{ box-shadow: inset 4px 0 0 var(--c-how); }
    .tbox[data-color="with"]{ box-shadow: inset 4px 0 0 var(--c-with); }
    .tbox[data-color="input"]{ box-shadow: inset 4px 0 0 var(--c-input); }
    .tbox[data-color="output"]{ box-shadow: inset 4px 0 0 var(--c-output); }
    .tbox[data-color="risk"]{ box-shadow: inset 4px 0 0 var(--c-risk); }
    .tbox[data-color="kpi"]{ box-shadow: inset 4px 0 0 var(--c-kpi); }
    .tbox[data-color="doc"]{ box-shadow: inset 4px 0 0 var(--c-doc); }
    .tbox[data-color="process"]{ box-shadow: inset 4px 0 0 rgba(2,6,23,.35); }

    .tbox-head{
      padding: 12px 14px 10px;
      display:flex;
      justify-content: space-between;
      gap: 10px;
      align-items:baseline;
      border-bottom: 1px solid rgba(15,23,42,.06);
      background: rgba(255,255,255,.35);
    }
    .tbox-head .hL{
      font-weight: 900;
      letter-spacing:.25px;
      text-transform: uppercase;
      color:#0f172a;
      font-size: 16px;
      margin:0;
    }
    .tbox-head .hR{
      font-size: 14px;
      font-weight: 800;
      color: #64748b;
      margin:0;
      text-align:right;
    }

    .tbox-body{
      padding: 12px 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      flex: 1 1 auto;
    }

    /* Notes */
    .notes{
      display:flex;
      flex-direction: column;
      gap: 8px;
      flex: 1 1 auto;
      min-height: 90px;
    }
    .note{
      background: rgba(255,255,255,.92);
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 6px;
      padding: 8px 10px;
      position: relative;
      padding-right: 34px;
    }
    .note textarea{
      width: 100%;
      border:none;
      outline:none;
      background: transparent;
      resize: vertical;
      font-family: inherit;
      font-size: 13px;
      min-height: 44px;
      color:#0f172a;
    }
    .note-del{
      position:absolute;
      top:6px;
      right:8px;
      border:none;
      background: transparent;
      cursor:pointer;
      font-size: 18px;
      line-height: 1;
      color:#94a3b8;
    }
    .note-del:hover{ color:#e53e3e; }

    .note-to-measure{
      position:absolute;
      right: 34px;
      top: 7px;
      border: 1px solid rgba(15,23,42,.14);
      background:#fff;
      color:#0f172a;
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 11px;
      font-weight: 900;
      cursor:pointer;
    }
    .note-to-measure:hover{ border-color: rgba(17,85,178,.45); color: var(--blue); }

    .add-entry{
      border: 1px dashed rgba(100,116,139,.45);
      background: rgba(255,255,255,.55);
      color:#94a3b8;
      border-radius: 6px;
      padding: 10px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.25px;
      cursor:pointer;
    }
    .add-entry:hover{ color: var(--blue); border-color: rgba(17,85,178,.55); background:#fff; }

    /* Process center fields */
    .process-grid{
      display:flex;
      flex-direction: column;
      gap: 12px;
    }
    .field label{
      display:block;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      color:#334155;
      letter-spacing:.2px;
      margin-bottom: 6px;
    }
    .field input, .field textarea{
      width: 100%;
      padding: 10px 12px;
      border:1px solid rgba(15,23,42,.14);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      outline: none;
      background:#fff;
    }
    .field textarea{ min-height: 92px; resize: vertical; }

    .two-cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media(max-width: 480px){ .two-cols{ grid-template-columns: 1fr; } }

    /* Risks extra field */
    .risk-extra{
      border-top: 1px dashed rgba(15,23,42,.14);
      padding-top: 10px;
    }

    /* Measures */
    .measures-section{
      margin-top: 16px;
      padding-top: 14px;
      border-top: 2px solid var(--blue);
    }
    .section-title{
      margin:0 0 6px;
      font-size: 13px;
      font-weight: 900;
      color: var(--dark);
      text-transform: uppercase;
      letter-spacing:.25px;
    }
    .section-sub{
      margin:0 0 10px;
      font-size: 13px;
      color: var(--muted);
    }

    .measure-draft{
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      padding: 12px 14px;
    }

    /* optimized, more logical draft layout */
    .draft-grid{
      display:grid;
      grid-template-columns: 1.6fr .8fr .7fr 1.1fr;
      gap: 10px;
      align-items:end;
    }
    .draft-grid .draft-full{ grid-column: 1 / -1; }
    @media(max-width: 980px){
      .draft-grid{ grid-template-columns: 1fr; }
      .draft-grid .draft-full{ grid-column:auto; }
    }

    .draft-actions{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
      border-top: 1px solid rgba(15,23,42,.08);
      padding-top: 10px;
    }
    .hint-mini{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    .measures-list{
      margin-top: 12px;
      border:1px solid var(--border);
      border-radius: var(--radius);
      background:#fff;
      overflow:hidden;
    }
    .measures-head{
      padding: 10px 14px;
      background: var(--light-bg);
      border-bottom: 1px solid rgba(15,23,42,.08);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .measures-filters{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items:center;
    }
    .chip{
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
    }
    .chip.active{ border-color: rgba(17,85,178,.45); color: var(--blue); background: rgba(17,85,178,.06); }

    .measures-table{
      width: 100%;
      border-collapse: collapse;
      min-width: 980px;
    }
    .measures-table th, .measures-table td{
      padding: 10px 14px;
      border-bottom: 1px solid rgba(15,23,42,.06);
      vertical-align: top;
      font-size: 13px;
    }
    .measures-table th{
      text-align:left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing:.2px;
      color:#334155;
      background: rgba(248,250,252,.8);
      white-space:nowrap;
    }
    .m-title{
      font-weight: 900;
      color:#0f172a;
      margin:0;
    }
    .m-meta{
      margin-top: 4px;
      color: var(--muted);
      font-size: 12px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid rgba(15,23,42,.12);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
      background:#fff;
    }
    .status-open{ border-color: rgba(37,99,235,.30); background: rgba(37,99,235,.06); color: #1d4ed8; }
    .status-done{ border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.08); color: #15803d; }
    .status-drop{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.08); color: #b91c1c; }

    .row-actions{
      display:flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content:flex-end;
    }
    .icon-btn{
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 900;
      cursor:pointer;
      text-transform: uppercase;
      letter-spacing:.2px;
    }
    .icon-btn:hover{ border-color: rgba(17,85,178,.45); color: var(--blue); background: rgba(17,85,178,.06); }
    .icon-btn.danger{ border-color: rgba(239,68,68,.30); color: #b91c1c; }
    .icon-btn.danger:hover{ background: rgba(239,68,68,.07); border-color: rgba(239,68,68,.45); color:#b91c1c; }

    /* Mobile: stack table */
    @media (max-width: 820px){
      .measures-table{ min-width:0; }
      .measures-table thead{ display:none; }
      .measures-table, .measures-table tbody, .measures-table tr, .measures-table td{ display:block; width:100%; }
      .measures-table tr{
        border-top:1px solid rgba(15,23,42,.10);
        padding:10px 0;
      }
      .measures-table td{
        border-bottom:0;
        padding:8px 14px;
      }
      .measures-table td::before{
        content: attr(data-label);
        display:block;
        font-size:11px;
        font-weight:900;
        text-transform:uppercase;
        color: var(--muted);
        margin-bottom:6px;
      }
      .row-actions{ justify-content:flex-start; }
    }

    /* Bottom actions */
    .actions{
      margin-top: 16px;
      padding-top: 14px;
      border-top: 2px solid var(--blue);
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items:center;
    }
    .actions-left, .actions-right{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; }

    /* Footer / More */
    .tool-more{
      margin-top: 18px;
      padding-top: 14px;
      border-top: 2px solid var(--blue);
    }
    .more-title{ margin:0 0 6px; font-size: 13px; font-weight: 900; color: var(--dark); text-transform: uppercase; }
    .more-sub{ margin:0 0 10px; font-size: 13px; color: var(--muted); }

    .more-list{ margin: 8px 0 0; padding-left: 18px; font-size: 13px; color:#334155; }
    .more-list li{ margin: 4px 0; }

    .footer{
      padding: 12px 20px;
      background: var(--light-bg);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      display:flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .footer a{ color: var(--dark); font-weight: 900; text-decoration:none; }
    .footer a:hover{ text-decoration: underline; }

    /* AI Section */
    #qm-turtle-app .ai-grid{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    #qm-turtle-app .ai-grid .full{ grid-column:1 / -1; }
    #qm-turtle-app .ai-note{
      margin:10px 0 0;
      font-size:13px;
      color:#334155;
    }
    #qm-turtle-app .ai-note strong{ color:#0f172a; }
    #qm-turtle-app .ai-actions{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid rgba(17,85,178,.12);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-start;
    }

    /* Print */
    @media print{
      body{ background:#fff; }
      #qm-turtle-app{ margin:0; padding:0; }
      .tool-intro, .actions, .tool-more, .lang-switch, .top-actions .btn,
      .note-del, .note-to-measure, .add-entry, .row-actions, .chip,
      .ai-actions, #secAI { display:none !important; }
      .card{ box-shadow:none; border:none; }
      .diagram-wrap{ border:none; padding:0; }
      .measures-head{ background:#fff; }
      .measures-table th{ background:#fff; }
      .footer{ border-top: 1px solid #ddd; background:#fff; }
    }
  </style>
</head>

<body>
  <div id="qm-turtle-app">
    <section class="card">

      <section class="tool-intro">
        <div class="intro-top">
          <div>
            <h2 class="tool-title" data-i18n="title">Turtle Diagramm – Prozessanalyse</h2>
            <p class="tool-sub" data-i18n="subtitle">
              Prozesse strukturiert beschreiben (Input → Prozess → Output) und Rahmenbedingungen (Wer/Wie/Womit/KPIs/Dokumente/Risiken) sichtbar machen – inkl. Ableitung & Maßnahmenliste.
            </p>
          </div>

          <div class="top-actions">
            <div class="lang-switch" aria-label="Language switch">
              <button type="button" class="btn" id="btnLangDE">DE</button>
              <button type="button" class="btn" id="btnLangEN">EN</button>
            </div>
            <a class="btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
          </div>
        </div>

        <div class="tool-grid">
          <div class="tool-box">
            <h3 data-i18n="boxToolNameTitle">Name Tool</h3>
            <p data-i18n="boxToolNameText">Turtle Diagramm – Prozessanalyse (Input/Prozess/Output + Rahmenbedingungen)</p>
          </div>

          <div class="tool-box">
            <h3 data-i18n="boxGoalTitle">Ziel</h3>
            <p data-i18n="boxGoalText">Prozess sauber abgrenzen, Schnittstellen klären und Schwachstellen/Risiken identifizieren – als Grundlage für Maßnahmen.</p>
          </div>

          <div class="tool-box">
            <h3 data-i18n="boxHowTitle">So benutzt du das Tool</h3>

            <p class="group-title" data-i18n="howNoAiTitle">Ohne KI</p>
            <ol class="split-ol">
              <li data-i18n="step1">Prozess im Zentrum ausfüllen (Zweck/Start/Ende).</li>
              <li data-i18n="step2">In den Boxen rundherum Einträge sammeln (+ Eintrag).</li>
              <li data-i18n="step3">Optional: Eintrag → Maßnahme übernehmen (→ Maßnahme).</li>
              <li data-i18n="step4">Maßnahme mit Termin speichern → erscheint in der Maßnahmenliste.</li>
              <li data-i18n="step5">Drucken oder JSON speichern/laden.</li>
            </ol>

            <p class="group-title" style="margin-top:10px;" data-i18n="howAiTitle">Mit KI (Premium)</p>
            <ol class="split-ol">
              <li data-i18n="aiStep1">Prozessschritt & Kontext eingeben.</li>
              <li data-i18n="aiStep2">Lizenzschlüssel & OpenAI API Key eingeben.</li>
              <li data-i18n="aiStep3">Turtle + Maßnahmenliste generieren.</li>
              <li data-i18n="aiStep4">Ergebnis übernehmen → danach wie gewohnt ergänzen, bewerten oder löschen.</li>
            </ol>
          </div>

          <div class="tool-box tool-privacy">
            <h3 data-i18n="boxPrivacyTitle">Datenschutz</h3>
            <p><strong data-i18n="privacyNoAiHead">Ohne API/KI:</strong> <span data-i18n="privacyNoAiText">Dieses Tool läuft vollständig im Browser. Es werden keine Daten an Server übertragen. Optional wird der aktuelle Stand lokal im Browser gespeichert (Autosave) und kann als JSON exportiert/importiert werden.</span></p>
            <p style="margin-top:8px;"><strong data-i18n="privacyAiHead">Mit API/KI (Premium):</strong> <span data-i18n="privacyAiText">Nur wenn du den KI‑Assistenten nutzt, werden deine Eingaben (Prozessschritt/Kontext) aus dem Browser direkt an die OpenAI API übertragen. API Key und Lizenz bleiben lokal im Browser und werden nicht serverseitig gespeichert.</span></p>
          </div>
        </div>
      </section>

      <div class="body">
        <div class="turtle-strip">
          <div><strong data-i18n="stripLeftStrong">Kern</strong><span data-i18n="stripLeftText">: Prozess im Zentrum</span></div>
          <div><strong data-i18n="stripRightStrong">Rundherum</strong><span data-i18n="stripRightText">: Inputs/Outputs + Rollen/Methoden/Ressourcen/KPIs</span></div>
        </div>

        <div id="capture-area" class="diagram-wrap" aria-label="Turtle Diagramm">
          <div class="turtle-grid">
            <!-- Row 1 -->
            <section class="tbox" data-color="people" aria-label="Mit wem">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_people_left">MIT WEM?</p>
                <p class="hR" data-i18n="t_people_right">Rollen & Kompetenzen</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-people"></div>
                <button class="add-entry" type="button" data-box="people" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>

            <section class="tbox" data-color="how" aria-label="Wie">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_how_left">WIE?</p>
                <p class="hR" data-i18n="t_how_right">Ablauf & Methoden</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-how"></div>
                <button class="add-entry" type="button" data-box="how" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>

            <section class="tbox" data-color="with" aria-label="Womit">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_with_left">WOMIT?</p>
                <p class="hR" data-i18n="t_with_right">Ressourcen & Infrastruktur</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-with"></div>
                <button class="add-entry" type="button" data-box="with" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>

            <!-- Row 2 -->
            <section class="tbox" data-color="input" aria-label="Inputs">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_input_left">INPUTS</p>
                <p class="hR" data-i18n="t_input_right">Was kommt rein?</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-input"></div>
                <button class="add-entry" type="button" data-box="input" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>

            <section class="tbox headline-only" data-color="process" aria-label="Prozess im Zentrum">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_process_left">PROZESS IM ZENTRUM</p>
                <p class="hR" data-i18n="t_process_right">Zweck & Schnittstellen</p>
              </div>
              <div class="tbox-body">
                <div class="process-grid">
                  <div class="field">
                    <label for="processPurpose" data-i18n="purposeLabel">Zweck / Ergebnis</label>
                    <textarea id="processPurpose" data-i18n-placeholder="purposePh" placeholder="Was ist der Zweck des Prozesses? Was ist das gewünschte Ergebnis?"></textarea>
                  </div>
                  <div class="two-cols">
                    <div class="field">
                      <label for="processStart" data-i18n="startLabel">Start (Trigger)</label>
                      <input id="processStart" type="text" data-i18n-placeholder="startPh" placeholder="z.B. Bestellung / Wareneingang / Ticket ..." />
                    </div>
                    <div class="field">
                      <label for="processEnd" data-i18n="endLabel">Ende (Output erreicht)</label>
                      <input id="processEnd" type="text" data-i18n-placeholder="endPh" placeholder="z.B. Freigabe / Lieferung / Dokumentation ..." />
                    </div>
                  </div>
                </div>
              </div>
            </section>

            <section class="tbox" data-color="output" aria-label="Outputs">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_output_left">OUTPUTS</p>
                <p class="hR" data-i18n="t_output_right">Was kommt raus?</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-output"></div>
                <button class="add-entry" type="button" data-box="output" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>

            <!-- Row 3 -->
            <section class="tbox" data-color="risk" aria-label="Risiken">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_risk_left">RISIKEN</p>
                <p class="hR" data-i18n="t_risk_right">Fehlerquellen / Barrieren</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-risk"></div>
                <button class="add-entry" type="button" data-box="risk" data-i18n="addEntry">+ EINTRAG</button>

                <div class="risk-extra">
                  <div class="field" style="margin-top:10px;">
                    <label for="riskExtra" data-i18n="riskExtraLabel">Zusatzfeld: Barrieren / Kontrollen</label>
                    <textarea id="riskExtra" data-i18n-placeholder="riskExtraPh" placeholder="Welche Barrieren/Controls reduzieren das Risiko? (optional)"></textarea>
                  </div>
                </div>
              </div>
            </section>

            <section class="tbox" data-color="kpi" aria-label="Wie gemessen">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_kpi_left">WIE GEMESSEN?</p>
                <p class="hR" data-i18n="t_kpi_right">KPIs & Nachweise</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-kpi"></div>
                <button class="add-entry" type="button" data-box="kpi" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>

            <section class="tbox" data-color="doc" aria-label="Dokumente">
              <div class="tbox-head">
                <p class="hL" data-i18n="t_doc_left">DOKUMENTE</p>
                <p class="hR" data-i18n="t_doc_right">SOPs / Records</p>
              </div>
              <div class="tbox-body">
                <div class="notes" id="notes-doc"></div>
                <button class="add-entry" type="button" data-box="doc" data-i18n="addEntry">+ EINTRAG</button>
              </div>
            </section>
          </div>

          <!-- Measures -->
          <section class="measures-section" aria-label="Ableitung von Maßnahmen">
            <h3 class="section-title" data-i18n="measuresTitle">Ableitung von Maßnahmen</h3>
            <p class="section-sub" data-i18n="measuresSub">Formuliere Maßnahmen (Was?) mit Verantwortlichem (optional), Termin und Nachweis/Wirksamkeit – und speichere sie in die Maßnahmenliste.</p>

            <div class="measure-draft">
              <div class="draft-grid">
                <div class="field draft-full">
                  <label for="draftMeasure" data-i18n="draftMeasureLabel">Maßnahme</label>
                  <textarea id="draftMeasure" data-i18n-placeholder="draftMeasurePh" placeholder="z.B. Lieferantenfreigabe beschleunigen: 2 Alternativen qualifizieren (inkl. Kriterien) ..."></textarea>
                </div>

                <div class="field">
                  <label for="draftOwner" data-i18n="draftOwnerLabel">Owner</label>
                  <input id="draftOwner" type="text" data-i18n-placeholder="draftOwnerPh" placeholder="z.B. Einkauf" />
                </div>

                <div class="field">
                  <label for="draftDue" data-i18n="draftDueLabel">Termin</label>
                  <input id="draftDue" type="date" />
                </div>

                <div class="field">
                  <label for="draftProof" data-i18n="draftProofLabel">Nachweis / Wirksamkeit</label>
                  <input id="draftProof" type="text" data-i18n-placeholder="draftProofPh" placeholder="z.B. Audit, KPI, Dummy-Prüfung, Kurzzeitfähigkeit, Versuch ..." />
                </div>
              </div>

              <div class="draft-actions">
                <button type="button" class="btn primary" id="btnSaveDraft" data-i18n="btnSaveDraft">In Maßnahmenliste speichern</button>
                <button type="button" class="btn" id="btnClearDraft" data-i18n="btnClearDraft">Eingabe leeren</button>
              </div>
              <div class="hint-mini" data-i18n="draftHint">
                Tipp: Nutze bei einem Eintrag oben den Button „→ Maßnahme“, um den Text in die Maßnahmen-Eingabe zu übernehmen.
              </div>
            </div>

            <div class="measures-list" aria-label="Maßnahmenliste">
              <div class="measures-head">
                <div>
                  <div class="section-title" style="margin:0;" data-i18n="listTitle">Maßnahmenliste</div>
                  <div class="section-sub" style="margin:4px 0 0;" id="listSubText">—</div>
                </div>
                <div class="measures-filters" aria-label="Filter">
                  <span class="chip active" data-filter="all" data-i18n="filterAll">Alle</span>
                  <span class="chip" data-filter="open" data-i18n="filterOpen">Offen</span>
                  <span class="chip" data-filter="done" data-i18n="filterDone">Abgeschlossen</span>
                  <span class="chip" data-filter="drop" data-i18n="filterDrop">Verworfen</span>
                </div>
              </div>

              <table class="measures-table" aria-label="Maßnahmen Tabelle">
                <thead>
                  <tr>
                    <th data-i18n="thMeasure">Maßnahme</th>
                    <th data-i18n="thProof">Nachweis</th>
                    <th style="width:120px;" data-i18n="thDue">Termin</th>
                    <th style="width:180px;" data-i18n="thOwner">Owner</th>
                    <th style="width:160px;" data-i18n="thStatus">Status</th>
                    <th style="width:260px; text-align:right;" data-i18n="thActions">Aktionen</th>
                  </tr>
                </thead>
                <tbody id="measuresTbody"></tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- Bottom actions -->
        <div class="actions">
          <div class="actions-left">
            <button type="button" class="btn primary" id="btnPrint" data-i18n="btnPrint">Drucken</button>
            <a class="btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
          </div>

          <div class="actions-right">
            <button type="button" class="btn" id="btnSaveJson" data-i18n="btnSaveJson">JSON speichern</button>
            <button type="button" class="btn" id="btnLoadJson" data-i18n="btnLoadJson">JSON laden</button>
            <input type="file" id="jsonFile" accept="application/json" style="display:none" />
            <button type="button" class="btn danger" id="btnResetAll" data-i18n="btnResetAll">Reset</button>
          </div>
        </div>

        <!-- AI ASSISTANT (Premium) -->
        <section class="tool-more" style="margin-top:18px; border-top:2px solid var(--blue);" aria-labelledby="secAI">
          <h3 class="more-title" id="secAI" data-i18n="aiTitle">KI Assistent (Premium)</h3>
          <p class="more-sub" data-i18n="aiSub">Erzeuge aus Prozessschritt & Kontext ein ausgefülltes Turtle Diagramm inklusive Maßnahmenliste – danach arbeitest du wie gewohnt weiter.</p>

          <p class="ai-note" data-i18n="aiPitch">
            Nutze die volle Power des Tools: Der KI‑Assistent erstellt dir in Sekunden ein vollständiges Turtle‑Diagramm (Inputs/Outputs/Rollen/Methoden/Ressourcen/KPIs/Dokumente/Risiken) inkl. Maßnahmenliste – du bist damit <strong>bis zu 80% schneller</strong> und effizienter unterwegs. <strong>Kunden der Quality Services &amp; Wissen GmbH erhalten diese Funktion kostenlos.</strong>
          </p>

          <div class="ai-grid" style="margin-top:12px;">
            <div>
              <label for="aiLicense" class="field label" style="display:block;" data-i18n="aiLicenseLabel">Lizenzschlüssel</label>
              <div style="display:flex; gap:10px; align-items:center;">
                <span class="badge lic" data-i18n="aiLicBadge">Lizenz</span>
                <input id="aiLicense" type="password" placeholder="••••" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px;">
              </div>
              <div class="hint-mini" data-i18n="aiLicenseHint">Hinweis: erforderlich, um den KI‑Assistenten zu aktivieren.</div>
            </div>

            <div>
              <label for="aiApiKey" class="field label" style="display:block;" data-i18n="aiApiLabel">OpenAI API Key</label>
              <div style="display:flex; gap:10px; align-items:center;">
                <span class="badge api" data-i18n="aiApiBadge">API</span>
                <input id="aiApiKey" type="password" placeholder="sk-..." style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px;">
              </div>
              <div class="hint-mini" data-i18n="aiApiHint">Der Key bleibt lokal in deinem Browser und wird nicht serverseitig gespeichert.</div>
            </div>

            <div class="full">
              <label for="aiProcessStep" data-i18n="aiProcessLabel">Zu welchem Prozessschritt erstellen wir ein Turtle Diagramm?</label>
              <input id="aiProcessStep" type="text" placeholder="z.B. Wareneingangsprüfung / Reklamationsbearbeitung / Produktion Linie A …" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px;">
            </div>

            <div class="full">
              <label for="aiContext" data-i18n="aiContextLabel">Kontext</label>
              <textarea id="aiContext" placeholder="Ziel, Problem, Randbedingungen, bekannte Risiken, KPIs, Stakeholder …" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px; min-height:90px;"></textarea>
            </div>

            <div class="full">
              <div class="ai-actions">
                <button type="button" class="btn primary" id="btnAiGenerate" data-i18n="aiBtnGenerate">Turtle & Maßnahmen generieren</button>
                <button type="button" class="btn" id="btnAiApply" data-i18n="aiBtnApply" disabled>Ergebnis übernehmen</button>
                <button type="button" class="btn" id="btnAiDownload" data-i18n="aiBtnDownload" disabled>Ergebnis als JSON speichern</button>
                <span class="pill warn" id="aiStatePill">● <span id="aiStateText" data-i18n="aiStateIdle">Bereit</span></span>
                <span class="badge premium" style="margin-left:auto;" data-i18n="aiPremiumBadge">Premium</span>
              </div>
              <div class="hint-mini" data-i18n="aiHint">Tipp: Nach dem Übernehmen kannst du Einträge und Maßnahmen wie gewohnt bearbeiten, ergänzen oder löschen.</div>
            </div>
          </div>
        </section>

        <!-- More -->
        <section class="tool-more">
          <h3 class="more-title" data-i18n="moreTitle">Weiterführende Infos</h3>
          <p class="more-sub" data-i18n="moreSub">Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).</p>

          <div class="tool-grid">
            <div class="tool-box">
              <h3 data-i18n="lexTitle">Lexikon</h3>
              <p data-i18n="lexText">Definition, Nutzen & Anwendung des Turtle Diagramms.</p>
              <p style="margin-top:8px;">
                <a href="https://www.quality.de/lexikon/turtle-diagramm/" target="_blank" rel="noopener" data-i18n="lexLink">Zum Lexikonartikel: Turtle Diagramm</a>
              </p>
            </div>

            <div class="tool-box">
              <h3 data-i18n="trainTitle">Ausbildungen & Seminare</h3>
              <p data-i18n="trainText">Vertiefe deine Methodenkompetenz im Qualitätsmanagement:</p>
              <ul class="more-list">
                <li><a href="https://www.quality.de/weiterbildung/kvp/" target="_blank" rel="noopener" data-i18n="trainKvp">KVP Seminare</a></li>
                <li><a href="https://www.quality.de/weiterbildung/8d-seminare-8d-schulungen/" target="_blank" rel="noopener" data-i18n="train8d">8D Schulungen</a></li>
                <li><a href="https://www.quality.de/weiterbildung/qualitaetsmanagement/" target="_blank" rel="noopener" data-i18n="trainQm">Qualitätsmanagement</a></li>
              </ul>
            </div>
          </div>
        </section>
      </div>

      <footer class="footer">
        <div>© <span id="copyrightYear"></span></div>
        <div><a href="https://www.quality.de/" target="_blank" rel="noopener">Quality Services &amp; Wissen GmbH</a></div>
      </footer>
    </section>
  </div>

  <script>
  (function(){
    const ROOT = document.getElementById("qm-turtle-app");
    if(!ROOT) return;

    const STORAGE_KEY = "qm_turtle_state_v3";
    const LANG_KEY = "qmLang";

    const $ = (sel) => ROOT.querySelector(sel);
    const $$ = (sel) => Array.from(ROOT.querySelectorAll(sel));

    // ---------- i18n ----------
    const I18N = {
      de: {
        title: "Turtle Diagramm – Prozessanalyse",
        subtitle: "Prozesse strukturiert beschreiben (Input → Prozess → Output) und Rahmenbedingungen (Wer/Wie/Womit/KPIs/Dokumente/Risiken) sichtbar machen – inkl. Ableitung & Maßnahmenliste.",
        backHome: "Zurück zur Startseite",

        boxToolNameTitle: "Name Tool",
        boxToolNameText: "Turtle Diagramm – Prozessanalyse (Input/Prozess/Output + Rahmenbedingungen)",
        boxGoalTitle: "Ziel",
        boxGoalText: "Prozess sauber abgrenzen, Schnittstellen klären und Schwachstellen/Risiken identifizieren – als Grundlage für Maßnahmen.",
        boxHowTitle: "So benutzt du das Tool",
        howNoAiTitle: "Ohne KI",
        howAiTitle: "Mit KI (Premium)",
        step1: "Prozess im Zentrum ausfüllen (Zweck/Start/Ende).",
        step2: "In den Boxen rundherum Einträge sammeln (+ Eintrag).",
        step3: "Optional: Eintrag → Maßnahme übernehmen (→ Maßnahme).",
        step4: "Maßnahme mit Termin speichern → erscheint in der Maßnahmenliste.",
        step5: "Drucken oder JSON speichern/laden.",
        aiStep1: "Prozessschritt & Kontext eingeben.",
        aiStep2: "Lizenzschlüssel & OpenAI API Key eingeben.",
        aiStep3: "Turtle + Maßnahmenliste generieren.",
        aiStep4: "Ergebnis übernehmen → danach wie gewohnt ergänzen, bewerten oder löschen.",

        boxPrivacyTitle: "Datenschutz",
        privacyNoAiHead: "Ohne API/KI:",
        privacyNoAiText: "Dieses Tool läuft vollständig im Browser. Es werden keine Daten an Server übertragen. Optional wird der aktuelle Stand lokal im Browser gespeichert (Autosave) und kann als JSON exportiert/importiert werden.",
        privacyAiHead: "Mit API/KI (Premium):",
        privacyAiText: "Nur wenn du den KI‑Assistenten nutzt, werden deine Eingaben (Prozessschritt/Kontext) aus dem Browser direkt an die OpenAI API übertragen. API Key und Lizenz bleiben lokal im Browser und werden nicht serverseitig gespeichert.",

        stripLeftStrong: "Kern",
        stripLeftText: ": Prozess im Zentrum",
        stripRightStrong: "Rundherum",
        stripRightText: ": Inputs/Outputs + Rollen/Methoden/Ressourcen/KPIs",

        addEntry: "+ EINTRAG",
        toMeasure: "→ Maßnahme",
        deleteEntry: "Eintrag löschen",
        entryPlaceholder: "Eintrag notieren...",

        t_people_left: "MIT WEM?",
        t_people_right: "Rollen & Kompetenzen",
        t_how_left: "WIE?",
        t_how_right: "Ablauf & Methoden",
        t_with_left: "WOMIT?",
        t_with_right: "Ressourcen & Infrastruktur",
        t_input_left: "INPUTS",
        t_input_right: "Was kommt rein?",
        t_process_left: "PROZESS IM ZENTRUM",
        t_process_right: "Zweck & Schnittstellen",
        t_output_left: "OUTPUTS",
        t_output_right: "Was kommt raus?",
        t_risk_left: "RISIKEN",
        t_risk_right: "Fehlerquellen / Barrieren",
        t_kpi_left: "WIE GEMESSEN?",
        t_kpi_right: "KPIs & Nachweise",
        t_doc_left: "DOKUMENTE",
        t_doc_right: "SOPs / Records",

        purposeLabel: "Zweck / Ergebnis",
        purposePh: "Was ist der Zweck des Prozesses? Was ist das gewünschte Ergebnis?",
        startLabel: "Start (Trigger)",
        startPh: "z.B. Bestellung / Wareneingang / Ticket ...",
        endLabel: "Ende (Output erreicht)",
        endPh: "z.B. Freigabe / Lieferung / Dokumentation ...",

        riskExtraLabel: "Zusatzfeld: Barrieren / Kontrollen",
        riskExtraPh: "Welche Barrieren/Controls reduzieren das Risiko? (optional)",

        measuresTitle: "Ableitung von Maßnahmen",
        measuresSub: "Formuliere Maßnahmen (Was?) mit Verantwortlichem (optional), Termin und Nachweis/Wirksamkeit – und speichere sie in die Maßnahmenliste.",
        draftMeasureLabel: "Maßnahme",
        draftMeasurePh: "z.B. Lieferantenfreigabe beschleunigen: 2 Alternativen qualifizieren (inkl. Kriterien) ...",
        draftOwnerLabel: "Owner",
        draftOwnerPh: "z.B. Einkauf",
        draftDueLabel: "Termin",
        draftProofLabel: "Nachweis / Wirksamkeit",
        draftProofPh: "z.B. Audit, KPI, Dummy-Prüfung, Kurzzeitfähigkeit, Versuch ...",
        btnSaveDraft: "In Maßnahmenliste speichern",
        btnClearDraft: "Eingabe leeren",
        draftHint: "Tipp: Nutze bei einem Eintrag oben den Button „→ Maßnahme“, um den Text in die Maßnahmen-Eingabe zu übernehmen.",

        listTitle: "Maßnahmenliste",
        filterAll: "Alle",
        filterOpen: "Offen",
        filterDone: "Abgeschlossen",
        filterDrop: "Verworfen",
        thMeasure: "Maßnahme",
        thProof: "Nachweis",
        thDue: "Termin",
        thOwner: "Owner",
        thStatus: "Status",
        thActions: "Aktionen",
        statusOpen: "Offen",
        statusDone: "Abgeschlossen",
        statusDrop: "Verworfen",
        btnOpen: "Offen",
        btnDone: "Abschließen",
        btnDrop: "Verwerfen",
        btnEdit: "Bearbeiten",
        btnSaveRow: "Speichern",
        btnDelete: "Löschen",

        btnPrint: "Drucken",
        btnSaveJson: "JSON speichern",
        btnLoadJson: "JSON laden",
        btnResetAll: "Reset",
        confirmReset: "Alles löschen (inkl. Autosave)?",
        jsonName: "Turtle_Export.json",
        loadError: "Fehler beim Laden der Datei.",

        // AI
        aiTitle: "KI Assistent (Premium)",
        aiSub: "Erzeuge aus Prozessschritt & Kontext ein ausgefülltes Turtle Diagramm inklusive Maßnahmenliste – danach arbeitest du wie gewohnt weiter.",
        aiPremiumBadge: "Premium",
        aiPitch: "Nutze die volle Power des Tools: Der KI‑Assistent erstellt dir in Sekunden ein vollständiges Turtle‑Diagramm (Inputs/Outputs/Rollen/Methoden/Ressourcen/KPIs/Dokumente/Risiken) inkl. Maßnahmenliste – du bist damit <strong>bis zu 80% schneller</strong> und effizienter unterwegs. <strong>Kunden der Quality Services &amp; Wissen GmbH erhalten diese Funktion kostenlos.</strong>",
        aiLicenseLabel: "Lizenzschlüssel",
        aiLicBadge: "Lizenz",
        aiLicenseHint: "Hinweis: erforderlich, um den KI‑Assistenten zu aktivieren.",
        aiApiLabel: "OpenAI API Key",
        aiApiBadge: "API",
        aiApiHint: "Der Key bleibt lokal in deinem Browser und wird nicht serverseitig gespeichert.",
        aiProcessLabel: "Zu welchem Prozessschritt erstellen wir ein Turtle Diagramm?",
        aiContextLabel: "Kontext",
        aiBtnGenerate: "Turtle & Maßnahmen generieren",
        aiBtnApply: "Ergebnis übernehmen",
        aiBtnDownload: "Ergebnis als JSON speichern",
        aiStateIdle: "Bereit",
        aiStateWorking: "KI arbeitet…",
        aiStateOk: "Ergebnis bereit",
        aiStateBad: "Fehler",
        aiHint: "Tipp: Nach dem Übernehmen kannst du Einträge und Maßnahmen wie gewohnt bearbeiten, ergänzen oder löschen.",
        aiNeedLicense: "Lizenzschlüssel erforderlich (Premium).",
        aiBadLicense: "Lizenzschlüssel ungültig.",
        aiNeedKey: "OpenAI API Key fehlt.",
        aiNeedProcess: "Bitte Prozessschritt ausfüllen.",
        aiNeedContext: "Bitte Kontext ausfüllen.",

        moreTitle: "Weiterführende Infos",
        moreSub: "Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).",
        lexTitle: "Lexikon",
        lexText: "Definition, Nutzen & Anwendung des Turtle Diagramms.",
        lexLink: "Zum Lexikonartikel: Turtle Diagramm",
        trainTitle: "Ausbildungen & Seminare",
        trainText: "Vertiefe deine Methodenkompetenz im Qualitätsmanagement:",
        trainKvp: "KVP Seminare",
        train8d: "8D Schulungen",
        trainQm: "Qualitätsmanagement"
      },
      en: {
        title: "Turtle Diagram – Process Analysis",
        subtitle: "Describe processes in a structured way (Input → Process → Output) and make enablers visible (Who/How/With what/KPIs/Documents/Risks) – including action derivation & an action list.",
        backHome: "Back to home",

        boxToolNameTitle: "Tool name",
        boxToolNameText: "Turtle Diagram – Process Analysis (Input/Process/Output + enablers)",
        boxGoalTitle: "Goal",
        boxGoalText: "Define the process scope, clarify interfaces, and identify weaknesses/risks – as a basis for actions.",
        boxHowTitle: "How to use this tool",
        howNoAiTitle: "Without AI",
        howAiTitle: "With AI (Premium)",
        step1: "Fill out the center process (purpose/start/end).",
        step2: "Collect entries in the surrounding boxes (+ entry).",
        step3: "Optional: send an entry to the action draft (→ action).",
        step4: "Save the action with due date → it appears in the action list.",
        step5: "Print or save/load JSON.",
        aiStep1: "Enter process step & context.",
        aiStep2: "Enter license key & OpenAI API key.",
        aiStep3: "Generate turtle + action list.",
        aiStep4: "Apply result → then work as usual (edit, review, delete).",

        boxPrivacyTitle: "Privacy",
        privacyNoAiHead: "Without API/AI:",
        privacyNoAiText: "This tool runs entirely in your browser. No data is sent to any server. Optionally, the current state is saved locally (autosave) and can be exported/imported as JSON.",
        privacyAiHead: "With API/AI (Premium):",
        privacyAiText: "Only when you use the AI assistant, your inputs (process step/context) are sent from your browser directly to the OpenAI API. API key and license stay local in your browser and are not stored server-side.",

        stripLeftStrong: "Core",
        stripLeftText: ": process in the center",
        stripRightStrong: "Around it",
        stripRightText: ": inputs/outputs + roles/methods/resources/KPIs",

        addEntry: "+ ENTRY",
        toMeasure: "→ Action",
        deleteEntry: "Delete entry",
        entryPlaceholder: "Write an entry...",

        t_people_left: "WHO?",
        t_people_right: "Roles & skills",
        t_how_left: "HOW?",
        t_how_right: "Flow & methods",
        t_with_left: "WITH WHAT?",
        t_with_right: "Resources & infrastructure",
        t_input_left: "INPUTS",
        t_input_right: "What goes in?",
        t_process_left: "PROCESS IN THE CENTER",
        t_process_right: "Purpose & interfaces",
        t_output_left: "OUTPUTS",
        t_output_right: "What comes out?",
        t_risk_left: "RISKS",
        t_risk_right: "Failure sources / barriers",
        t_kpi_left: "HOW MEASURED?",
        t_kpi_right: "KPIs & evidence",
        t_doc_left: "DOCUMENTS",
        t_doc_right: "SOPs / records",

        purposeLabel: "Purpose / outcome",
        purposePh: "What is the purpose of the process? What is the desired outcome?",
        startLabel: "Start (trigger)",
        startPh: "e.g., order / goods receipt / ticket ...",
        endLabel: "End (output reached)",
        endPh: "e.g., approval / delivery / documentation ...",

        riskExtraLabel: "Extra field: barriers / controls",
        riskExtraPh: "Which barriers/controls reduce the risk? (optional)",

        measuresTitle: "Action derivation",
        measuresSub: "Formulate actions (What?) with an owner (optional), due date and evidence/effectiveness – then save them into the action list.",
        draftMeasureLabel: "Action",
        draftMeasurePh: "e.g., accelerate supplier release: qualify 2 alternatives (incl. criteria) ...",
        draftOwnerLabel: "Owner",
        draftOwnerPh: "e.g., Purchasing",
        draftDueLabel: "Due date",
        draftProofLabel: "Evidence / effectiveness",
        draftProofPh: "e.g., audit, KPI, dummy test, trial, capability check ...",
        btnSaveDraft: "Save to action list",
        btnClearDraft: "Clear draft",
        draftHint: "Tip: Use the “→ Action” button on an entry above to copy its text into the action draft.",

        listTitle: "Action list",
        filterAll: "All",
        filterOpen: "Open",
        filterDone: "Done",
        filterDrop: "Discarded",
        thMeasure: "Action",
        thProof: "Evidence",
        thDue: "Due",
        thOwner: "Owner",
        thStatus: "Status",
        thActions: "Actions",
        statusOpen: "Open",
        statusDone: "Done",
        statusDrop: "Discarded",
        btnOpen: "Open",
        btnDone: "Mark done",
        btnDrop: "Discard",
        btnEdit: "Edit",
        btnSaveRow: "Save",
        btnDelete: "Delete",

        btnPrint: "Print",
        btnSaveJson: "Save JSON",
        btnLoadJson: "Load JSON",
        btnResetAll: "Reset",
        confirmReset: "Delete everything (including autosave)?",
        jsonName: "Turtle_Export.json",
        loadError: "Error loading the file.",

        // AI
        aiTitle: "AI Assistant (Premium)",
        aiSub: "Generate a filled turtle diagram including an action list from process step & context – then continue working as usual.",
        aiPremiumBadge: "Premium",
        aiPitch: "Unlock the full power: the AI assistant creates a complete turtle diagram (inputs/outputs/roles/methods/resources/KPIs/documents/risks) including an action list in seconds – making you <strong>up to 80% faster</strong> and more efficient. <strong>Customers of Quality Services &amp; Wissen GmbH get this feature for free.</strong>",
        aiLicenseLabel: "License key",
        aiLicBadge: "License",
        aiLicenseHint: "Note: required to activate the AI assistant.",
        aiApiLabel: "OpenAI API key",
        aiApiBadge: "API",
        aiApiHint: "The key stays locally in your browser and is not stored server-side.",
        aiProcessLabel: "For which process step are we creating a turtle diagram?",
        aiContextLabel: "Context",
        aiBtnGenerate: "Generate turtle + actions",
        aiBtnApply: "Apply result",
        aiBtnDownload: "Download result as JSON",
        aiStateIdle: "Ready",
        aiStateWorking: "AI working…",
        aiStateOk: "Result ready",
        aiStateBad: "Error",
        aiHint: "Tip: After applying, you can edit, add or delete entries and actions as usual.",
        aiNeedLicense: "License key required (Premium).",
        aiBadLicense: "Invalid license key.",
        aiNeedKey: "OpenAI API key missing.",
        aiNeedProcess: "Please fill in the process step.",
        aiNeedContext: "Please fill in the context.",

        moreTitle: "More information",
        moreSub: "Glossary article & relevant training (opens in a new tab).",
        lexTitle: "Glossary",
        lexText: "Definition, benefits & how to use the Turtle diagram.",
        lexLink: "Open glossary article: Turtle diagram",
        trainTitle: "Training & courses",
        trainText: "Deepen your method skills in quality management:",
        trainKvp: "CIP / KVP training",
        train8d: "8D training",
        trainQm: "Quality management"
      }
    };

    let currentLang = (localStorage.getItem(LANG_KEY)
      || ((navigator.language||"").toLowerCase().startsWith("de") ? "de" : "en"));

    function t(key){
      const d = I18N[currentLang] || I18N.de;
      return (key in d) ? d[key] : key;
    }

    function applyI18n(){
      document.documentElement.lang = currentLang;
      $$("[data-i18n]").forEach(el => {
        // allow HTML in aiPitch
        if(el.dataset.i18n === "aiPitch"){
          el.innerHTML = t(el.dataset.i18n);
        }else{
          el.textContent = t(el.dataset.i18n);
        }
      });
      $$("[data-i18n-placeholder]").forEach(el => el.placeholder = t(el.dataset.i18nPlaceholder));

      // lang buttons
      $("#btnLangDE").classList.toggle("primary", currentLang==="de");
      $("#btnLangEN").classList.toggle("primary", currentLang==="en");

      // update note UI labels
      $$(".note textarea").forEach(ta=>{
        if(ta.dataset.i18nPlaceholder) ta.placeholder = t(ta.dataset.i18nPlaceholder);
      });
      $$(".note-to-measure").forEach(btn=>{
        btn.textContent = t("toMeasure");
        btn.title = t("toMeasure");
      });

      updateListHeader();
      renderMeasures();
    }

    function setLanguage(lang){
      currentLang = (lang==="de" || lang==="en") ? lang : "de";
      localStorage.setItem(LANG_KEY, currentLang);
      applyI18n();
      persist();
    }

    // ---------- State ----------
    function uid(){
      try{ return crypto.randomUUID(); }catch{ return "id_" + Math.random().toString(16).slice(2); }
    }

    const EMPTY_STATE = () => ({
      lang: currentLang,
      processPurpose: "",
      processStart: "",
      processEnd: "",
      riskExtra: "",
      boxes: { people: [], how: [], with: [], input: [], output: [], risk: [], kpi: [], doc: [] },
      draft: { text:"", owner:"", due:"", proof:"" },
      measures: [], // {id,text,owner,due,proof,status,ts}
      ts: new Date().toISOString()
    });

    let state = EMPTY_STATE();
    let filter = "all";
    let editRowId = null;

    // ---------- Persist ----------
    function persist(){
      state.lang = currentLang;
      state.ts = new Date().toISOString();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function restore(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      try{
        const p = JSON.parse(raw);
        if(!p || typeof p !== "object") return false;

        state = EMPTY_STATE();
        state.lang = (p.lang==="de"||p.lang==="en") ? p.lang : currentLang;

        state.processPurpose = String(p.processPurpose ?? "");
        state.processStart = String(p.processStart ?? "");
        state.processEnd = String(p.processEnd ?? "");
        state.riskExtra = String(p.riskExtra ?? "");

        const b = p.boxes || {};
        Object.keys(state.boxes).forEach(k=>{
          const arr = Array.isArray(b[k]) ? b[k] : [];
          state.boxes[k] = arr.map(x=>({ id: String(x.id || uid()), text: String(x.text || "") }));
        });

        const d = p.draft || {};
        state.draft = { 
          text: String(d.text ?? ""), 
          owner: String(d.owner ?? ""), 
          due: String(d.due ?? ""), 
          proof: String(d.proof ?? "") 
        };

        const m = Array.isArray(p.measures) ? p.measures : [];
        state.measures = m.map(x=>({
          id: String(x.id || uid()),
          text: String(x.text || ""),
          owner: String(x.owner || ""),
          due: String(x.due || ""),
          proof: String(x.proof || ""),
          status: (x.status==="done"||x.status==="drop"||x.status==="open") ? x.status : "open",
          ts: String(x.ts || new Date().toISOString())
        }));

        state.ts = String(p.ts ?? new Date().toISOString());
        return true;
      }catch(e){
        return false;
      }
    }

    // ---------- Helpers ----------
    function esc(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    // ---------- Notes ----------
    function renderBox(boxKey){
      const host = $("#notes-"+boxKey);
      if(!host) return;
      host.innerHTML = "";

      state.boxes[boxKey].forEach(item=>{
        const div = document.createElement("div");
        div.className = "note";
        div.innerHTML = `
          <button type="button" class="note-del" title="${esc(t("deleteEntry"))}" aria-label="${esc(t("deleteEntry"))}">&times;</button>
          <button type="button" class="note-to-measure" title="${esc(t("toMeasure"))}">${esc(t("toMeasure"))}</button>
          <textarea rows="2" data-i18n-placeholder="entryPlaceholder" placeholder="${esc(t("entryPlaceholder"))}">${esc(item.text)}</textarea>
        `;
        const ta = div.querySelector("textarea");
        const del = div.querySelector(".note-del");
        const toM = div.querySelector(".note-to-measure");

        ta.addEventListener("input", ()=>{
          item.text = ta.value;
          persist();
        });
        del.addEventListener("click", ()=>{
          state.boxes[boxKey] = state.boxes[boxKey].filter(x=>x.id !== item.id);
          renderBox(boxKey);
          persist();
        });
        toM.addEventListener("click", ()=>{
          const txt = (ta.value || "").trim();
          if(!txt) return;
          $("#draftMeasure").value = txt;
          state.draft.text = txt;
          persist();
          $("#draftMeasure").focus();
        });

        host.appendChild(div);
      });

      applyI18n();
    }

    function addEntry(boxKey){
      state.boxes[boxKey].push({ id: uid(), text: "" });
      renderBox(boxKey);
      persist();

      const host = $("#notes-"+boxKey);
      const last = host && host.querySelector(".note:last-child textarea");
      if(last) last.focus();
    }

    // ---------- Process fields ----------
    function syncFields(){
      $("#processPurpose").value = state.processPurpose;
      $("#processStart").value = state.processStart;
      $("#processEnd").value = state.processEnd;
      $("#riskExtra").value = state.riskExtra;

      $("#draftMeasure").value = state.draft.text;
      $("#draftOwner").value = state.draft.owner;
      $("#draftDue").value = state.draft.due;
      $("#draftProof").value = state.draft.proof;
    }

    // ---------- Measures ----------
    function statusPill(status){
      if(status==="done") return `<span class="status-pill status-done">${esc(t("statusDone"))}</span>`;
      if(status==="drop") return `<span class="status-pill status-drop">${esc(t("statusDrop"))}</span>`;
      return `<span class="status-pill status-open">${esc(t("statusOpen"))}</span>`;
    }

    function updateListHeader(){
      const total = state.measures.length;
      const open = state.measures.filter(m=>m.status==="open").length;
      const done = state.measures.filter(m=>m.status==="done").length;
      const drop = state.measures.filter(m=>m.status==="drop").length;

      const el = $("#listSubText");
      if(!el) return;

      el.textContent = (currentLang==="de")
        ? `Gesamt: ${total} · Offen: ${open} · Abgeschlossen: ${done} · Verworfen: ${drop}`
        : `Total: ${total} · Open: ${open} · Done: ${done} · Discarded: ${drop}`;
    }

    function filteredMeasures(){
      const list = [...state.measures];
      list.sort((a,b)=>{
        const da = a.due || "9999-12-31";
        const db = b.due || "9999-12-31";
        if(da < db) return -1;
        if(da > db) return 1;
        return String(a.ts).localeCompare(String(b.ts));
      });

      if(filter==="all") return list;
      return list.filter(m=>m.status===filter);
    }

    function renderMeasures(){
      updateListHeader();
      const tbody = $("#measuresTbody");
      tbody.innerHTML = "";

      const list = filteredMeasures();
      if(list.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="6" style="color:#64748b; padding:14px;">${currentLang==="de" ? "Keine Maßnahmen im aktuellen Filter." : "No actions in the current filter."}</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach(m=>{
        const isEdit = (editRowId === m.id);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="${esc(t("thMeasure"))}">
            ${isEdit
              ? `<div class="field" style="margin:0;">
                   <textarea data-edit="text" style="min-height:80px;">${esc(m.text)}</textarea>
                 </div>`
              : `<p class="m-title">${esc(m.text || "—")}</p>`
            }
          </td>

          <td data-label="${esc(t("thProof"))}">
            ${isEdit
              ? `<div class="field" style="margin:0;">
                   <input data-edit="proof" type="text" value="${esc(m.proof)}" placeholder="${esc(t("draftProofPh"))}" />
                 </div>`
              : `<div class="m-meta">${esc(m.proof || "—")}</div>`
            }
          </td>

          <td data-label="${esc(t("thDue"))}">
            ${isEdit
              ? `<div class="field" style="margin:0;">
                   <input data-edit="due" type="date" value="${esc(m.due)}"/>
                 </div>`
              : esc(m.due || "—")
            }
          </td>

          <td data-label="${esc(t("thOwner"))}">
            ${isEdit
              ? `<div class="field" style="margin:0;">
                   <input data-edit="owner" type="text" value="${esc(m.owner)}" placeholder="${esc(t("draftOwnerPh"))}"/>
                 </div>`
              : `<div class="m-meta">${esc(m.owner || "—")}</div>`
            }
          </td>

          <td data-label="${esc(t("thStatus"))}">${statusPill(m.status)}</td>

          <td data-label="${esc(t("thActions"))}" style="text-align:right;">
            <div class="row-actions">
              ${isEdit
                ? `<button type="button" class="icon-btn" data-act="save" data-id="${esc(m.id)}">${esc(t("btnSaveRow"))}</button>
                   <button type="button" class="icon-btn" data-act="cancel" data-id="${esc(m.id)}">${currentLang==="de" ? "Abbrechen" : "Cancel"}</button>`
                : `<button type="button" class="icon-btn" data-act="edit" data-id="${esc(m.id)}">${esc(t("btnEdit"))}</button>
                   <button type="button" class="icon-btn" data-act="open" data-id="${esc(m.id)}">${esc(t("btnOpen"))}</button>
                   <button type="button" class="icon-btn" data-act="done" data-id="${esc(m.id)}">${esc(t("btnDone"))}</button>
                   <button type="button" class="icon-btn" data-act="drop" data-id="${esc(m.id)}">${esc(t("btnDrop"))}</button>
                   <button type="button" class="icon-btn danger" data-act="del" data-id="${esc(m.id)}">${esc(t("btnDelete"))}</button>`
              }
            </div>
          </td>
        `;
        tbody.appendChild(tr);

        tr.querySelectorAll("[data-act]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            const act = btn.getAttribute("data-act");
            const id = btn.getAttribute("data-id");
            onRowAction(act, id, tr);
          });
        });
      });
    }

    function onRowAction(act, id, rowEl){
      const m = state.measures.find(x=>x.id===id);
      if(!m) return;

      if(act==="edit"){ editRowId = id; renderMeasures(); return; }
      if(act==="cancel"){ editRowId = null; renderMeasures(); return; }

      if(act==="save"){
        const text = rowEl.querySelector('[data-edit="text"]')?.value ?? m.text;
        const owner = rowEl.querySelector('[data-edit="owner"]')?.value ?? m.owner;
        const due = rowEl.querySelector('[data-edit="due"]')?.value ?? m.due;
        const proof = rowEl.querySelector('[data-edit="proof"]')?.value ?? m.proof;

        m.text = String(text).trim();
        m.owner = String(owner).trim();
        m.due = String(due).trim();
        m.proof = String(proof).trim();

        editRowId = null;
        persist();
        renderMeasures();
        return;
      }

      if(act==="open") m.status = "open";
      if(act==="done") m.status = "done";
      if(act==="drop") m.status = "drop";
      if(act==="del"){
        const ok = confirm(currentLang==="de" ? "Maßnahme löschen?" : "Delete this action?");
        if(!ok) return;
        state.measures = state.measures.filter(x=>x.id !== id);
      }

      persist();
      renderMeasures();
    }

    function saveDraftToList(){
      const text = ($("#draftMeasure").value || "").trim();
      const owner = ($("#draftOwner").value || "").trim();
      const due = ($("#draftDue").value || "").trim();
      const proof = ($("#draftProof").value || "").trim();

      if(!text){
        alert(currentLang==="de" ? "Bitte eine Maßnahme formulieren." : "Please enter an action.");
        $("#draftMeasure").focus();
        return;
      }
      state.measures.push({ id: uid(), text, owner, due, proof, status: "open", ts: new Date().toISOString() });

      state.draft = { text:"", owner:"", due:"", proof:"" };
      syncFields();

      persist();
      renderMeasures();
      $("#draftMeasure").focus();
    }

    // ---------- JSON ----------
    function downloadJson(){
      state.ts = new Date().toISOString();
      const blob = new Blob([JSON.stringify(state, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = t("jsonName");
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadJsonFile(file){
      file.text().then(txt=>{
        const parsed = JSON.parse(txt);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
        if(!restore()){
          alert(t("loadError"));
          return;
        }
        if(state.lang==="de" || state.lang==="en") currentLang = state.lang;
        localStorage.setItem(LANG_KEY, currentLang);
        buildAll();
      }).catch(()=> alert(t("loadError")));
    }

    // ---------- AI ASSISTANT (Premium) ----------
    async function sha256Hex(str){
      const data = new TextEncoder().encode(str);
      const digest = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(digest)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }
    const LICENSE_HASH = "07aa2015d482734372d4a9a1c07c8290198526b9ce1fd2e2dcff4d05f6792a29";
    let aiLastResult = null;

    function setAiState(kind, textKey){
      const pill = $("#aiStatePill");
      const txt = $("#aiStateText");
      if(!pill || !txt) return;

      pill.classList.remove("ok","warn","bad");
      if(kind==="ok") pill.classList.add("ok");
      else if(kind==="bad") pill.classList.add("bad");
      else pill.classList.add("warn");

      txt.textContent = t(textKey);
    }

    async function checkLicense(){
      const lic = ($("#aiLicense").value || "").trim();
      if(!lic) throw new Error(t("aiNeedLicense"));
      const h = await sha256Hex(lic);
      if(h !== LICENSE_HASH) throw new Error(t("aiBadLicense"));
      return true;
    }

    function normalizeAiResult(obj){
      const safe = EMPTY_STATE();
      safe.lang = currentLang;

      safe.processPurpose = String(obj.processPurpose ?? "");
      safe.processStart = String(obj.processStart ?? "");
      safe.processEnd = String(obj.processEnd ?? "");
      safe.riskExtra = String(obj.riskExtra ?? "");

      const boxes = obj.boxes || {};
      Object.keys(safe.boxes).forEach(k=>{
        const arr = Array.isArray(boxes[k]) ? boxes[k] : [];
        safe.boxes[k] = arr.slice(0, 12).map((x,i)=>({
          id: String(x.id || (k+"_"+(i+1))),
          text: String(x.text || "").trim()
        })).filter(x=>x.text);
      });

      const measures = Array.isArray(obj.measures) ? obj.measures : [];
      safe.measures = measures.slice(0, 30).map((m,i)=>({
        id: String(m.id || ("m_"+String(i+1).padStart(2,"0"))),
        text: String(m.text || "").trim(),
        owner: String(m.owner || "").trim(),
        due: String(m.due || "").trim(),
        proof: String(m.proof || "").trim(),
        status: (m.status==="done"||m.status==="drop"||m.status==="open") ? m.status : "open",
        ts: new Date().toISOString()
      })).filter(m=>m.text);

      safe.draft = { text:"", owner:"", due:"", proof:"" };
      safe.ts = new Date().toISOString();
      return safe;
    }

    async function aiGenerate(){
      try{
        setAiState("warn","aiStateWorking");
        $("#btnAiGenerate").disabled = true;
        $("#btnAiApply").disabled = true;
        $("#btnAiDownload").disabled = true;

        await checkLicense();

        const apiKey = ($("#aiApiKey").value || "").trim();
        if(!apiKey) throw new Error(t("aiNeedKey"));

        const processStep = ($("#aiProcessStep").value || "").trim();
        if(!processStep) throw new Error(t("aiNeedProcess"));

        const contextText = ($("#aiContext").value || "").trim();
        if(!contextText) throw new Error(t("aiNeedContext"));

        const langRule = (currentLang==="de")
  ? "Language: German. All text values MUST be German."
  : "Language: English. All text values MUST be English.";

const system = `
You are a quality management assistant. Return ONLY valid JSON (no markdown).
Create a filled Turtle diagram for the given process step and context.

Output JSON schema:
{
  "processPurpose": "short purpose/outcome",
  "processStart": "short trigger/start",
  "processEnd": "short end/hand-off",
  "riskExtra": "optional barriers/controls text",
  "boxes": {
    "people": [{"id":"p1","text":"..."}],
    "how": [{"id":"h1","text":"..."}],
    "with": [{"id":"w1","text":"..."}],
    "input": [{"id":"i1","text":"..."}],
    "output": [{"id":"o1","text":"..."}],
    "risk": [{"id":"r1","text":"..."}],
    "kpi": [{"id":"k1","text":"..."}],
    "doc": [{"id":"d1","text":"..."}]
  },
  "measures": [
    {"id":"m_01","text":"action","owner":"department or role","due":"YYYY-MM-DD or empty","proof":"evidence/effectiveness verification","status":"open"}
  ]
}

Guidelines:
- Provide 5–9 entries per box where meaningful; keep each entry concise.
- Measures: 8–16 actions; include realistic due dates (next 2–12 weeks) where useful; else empty.
- proof: suggested verification (audit, KPI, test, trial, short-term capability, checklists, etc.)
- ${langRule}
`.trim();

        const user = (currentLang==="de")
          ? `Prozessschritt: ${processStep}\nKontext: ${contextText}`
          : `Process step: ${processStep}\nContext: ${contextText}`;

        const payload = {
          model: "gpt-4.1-mini",
          input: [
            { role: "system", content: system },
            { role: "user", content: user }
          ],
          temperature: 0.4
        };

        const res = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: {
            "Content-Type":"application/json",
            "Authorization":"Bearer " + apiKey
          },
          body: JSON.stringify(payload)
        });

        if(!res.ok){
          const txt = await res.text().catch(()=> "");
          throw new Error("OpenAI error: " + res.status + " " + txt);
        }
        const data = await res.json();

        // Responses API: output_text is not guaranteed in raw REST responses.
        // Robustly extract concatenated output text from the response shape.
        function extractOutputText(resp){
          try{
            if(resp && typeof resp.output_text === "string" && resp.output_text.trim()){
              return resp.output_text;
            }
            let out = "";
            const arr = (resp && Array.isArray(resp.output)) ? resp.output : [];
            for(const item of arr){
              const content = item && Array.isArray(item.content) ? item.content : [];
              for(const c of content){
                if(c && c.type === "output_text" && typeof c.text === "string"){
                  out += c.text;
                }
              }
            }
            return out.trim();
          }catch(e){
            return "";
          }
        }

        const text = extractOutputText(data);

        if(!text) throw new Error("No output text from API");
        let parsed = null;
        try{
          parsed = JSON.parse(text);
        }catch(e){
          // fallback: try to recover JSON block from surrounding text
          const mm = text.match(/\{[\s\S]*\}/);
          if(mm) parsed = JSON.parse(mm[0]);
          else throw e;
        }

        aiLastResult = normalizeAiResult(parsed);

        setAiState("ok","aiStateOk");
        $("#btnAiApply").disabled = false;
        $("#btnAiDownload").disabled = false;

      }catch(err){
        setAiState("bad","aiStateBad");
        alert(String(err.message || err));
      }finally{
        $("#btnAiGenerate").disabled = false;
      }
    }

    function aiApply(){
      if(!aiLastResult) return;
      state = aiLastResult;
      persist();
      buildAll();
    }

    function aiDownload(){
      if(!aiLastResult) return;
      const blob = new Blob([JSON.stringify(aiLastResult, null, 2)], {type:"application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (currentLang==="de") ? "Turtle_KI_Export.json" : "Turtle_AI_Export.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    // ---------- Build ----------
    function buildAll(){
      syncFields();
      Object.keys(state.boxes).forEach(renderBox);
      renderMeasures();
      applyI18n();

      const yEl = $("#copyrightYear");
      if(yEl) yEl.textContent = String(new Date().getFullYear());
    }

    // ---------- Events ----------
    $("#btnLangDE").addEventListener("click", ()=> setLanguage("de"));
    $("#btnLangEN").addEventListener("click", ()=> setLanguage("en"));

    $$(".add-entry").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const key = btn.getAttribute("data-box");
        addEntry(key);
      });
    });

    $("#processPurpose").addEventListener("input", (e)=>{ state.processPurpose = e.target.value; persist(); });
    $("#processStart").addEventListener("input", (e)=>{ state.processStart = e.target.value; persist(); });
    $("#processEnd").addEventListener("input", (e)=>{ state.processEnd = e.target.value; persist(); });
    $("#riskExtra").addEventListener("input", (e)=>{ state.riskExtra = e.target.value; persist(); });

    $("#draftMeasure").addEventListener("input", (e)=>{ state.draft.text = e.target.value; persist(); });
    $("#draftOwner").addEventListener("input", (e)=>{ state.draft.owner = e.target.value; persist(); });
    $("#draftDue").addEventListener("input", (e)=>{ state.draft.due = e.target.value; persist(); });
    $("#draftProof").addEventListener("input", (e)=>{ state.draft.proof = e.target.value; persist(); });

    $("#btnSaveDraft").addEventListener("click", saveDraftToList);
    $("#btnClearDraft").addEventListener("click", ()=>{
      state.draft = { text:"", owner:"", due:"", proof:"" };
      syncFields();
      persist();
      $("#draftMeasure").focus();
    });

    $$(".chip[data-filter]").forEach(ch=>{
      ch.addEventListener("click", ()=>{
        filter = ch.getAttribute("data-filter");
        $$(".chip[data-filter]").forEach(x=>x.classList.toggle("active", x.getAttribute("data-filter")===filter));
        renderMeasures();
      });
    });

    $("#btnPrint").addEventListener("click", ()=> window.print());
    $("#btnSaveJson").addEventListener("click", downloadJson);
    $("#btnLoadJson").addEventListener("click", ()=> $("#jsonFile").click());
    $("#jsonFile").addEventListener("change", (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      loadJsonFile(f);
      ev.target.value = "";
    });

    $("#btnResetAll").addEventListener("click", ()=>{
      if(!confirm(t("confirmReset"))) return;
      localStorage.removeItem(STORAGE_KEY);
      state = EMPTY_STATE();
      buildAll();
    });

    // AI buttons
    $("#btnAiGenerate").addEventListener("click", aiGenerate);
    $("#btnAiApply").addEventListener("click", aiApply);
    $("#btnAiDownload").addEventListener("click", aiDownload);

    // ---------- Init ----------
    restore();
    if(state.lang==="de" || state.lang==="en") currentLang = state.lang;
    localStorage.setItem(LANG_KEY, currentLang);

    buildAll();
    persist();
  })();
  </script>
</body>
</html>
