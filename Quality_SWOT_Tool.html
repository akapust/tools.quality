<style>
  /* Add-on Styles (scoped via .qm-swot-addon-*) */
  .qm-swot-addon-duewrap{
    display:flex;
    gap:10px;
    align-items:center;
    flex-wrap:wrap;
    margin-top:8px;
    padding-top:8px;
    border-top:1px dashed rgba(0,0,0,.08);
  }
  .qm-swot-addon-duewrap label{
    font-size:12px;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.2px;
    color:#334155;
  }
  .qm-swot-addon-duewrap input[type="date"]{
    padding:8px 10px;
    border:1px solid rgba(17,85,178,.15);
    border-radius:4px;
    font-size:13px;
  }
  .qm-swot-addon-overview{
    margin-top:16px;
    border:1px solid rgba(17,85,178,.15);
    border-radius:4px;
    background:#fff;
    box-shadow: 0 4px 12px rgba(27,51,92,.08);
    overflow:hidden;
  }
  .qm-swot-addon-overview-head{
    background:#f8fafc;
    padding:14px 16px;
    border-bottom:2px solid #1155b2;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:10px;
    flex-wrap:wrap;
  }
  .qm-swot-addon-overview-title{
    margin:0;
    font-size:13px;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.3px;
    color:#09387a;
  }
  .qm-swot-addon-overview-sub{
    margin:2px 0 0;
    font-size:12px;
    color:#64748b;
  }
  .qm-swot-addon-overview-body{ padding:14px 16px; }
  .qm-swot-addon-table{
    width:100%;
    border-collapse:collapse;
    font-size:13px;
  }
  .qm-swot-addon-table th,
  .qm-swot-addon-table td{
    border-bottom:1px solid rgba(0,0,0,.06);
    padding:10px 8px;
    vertical-align:top;
  }
  .qm-swot-addon-table th{
    text-align:left;
    font-size:12px;
    font-weight:900;
    text-transform:uppercase;
    letter-spacing:.2px;
    color:#334155;
    background: rgba(17,85,178,.04);
  }
  .qm-swot-addon-muted{ color:#64748b; font-size:12px; }
  .qm-swot-addon-actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }
  .qm-swot-addon-btn{
    background:#fff;
    border: 1px solid rgba(17,85,178,.15);
    color:#09387a;
    padding:10px 14px;
    border-radius:4px;
    font-weight:900;
    cursor:pointer;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.3px;
    user-select:none;
  }
  .qm-swot-addon-btn.primary{
    background:#1155b2;
    border-color:#1155b2;
    color:#fff;
  }
  .qm-swot-addon-btn:hover{ transform: translateY(-1px); }
  .qm-swot-addon-btn:active{ transform: translateY(1px); }

  /* Print */
  @media print{
    .qm-no-print{ display:none !important; }
    .qm-swot-addon-overview{ box-shadow:none; }
    input[type="date"]{ border:1px solid #ccc !important; }
  }
</style>

<script>
(function(){
  // -------- Settings / keys --------
  const LANG_KEY = "qmLang"; // same key like your other tools
  const DUE_KEY_PREFIX = "qm_swot_due_"; // localStorage per measure

  // -------- i18n --------
  const TXT = {
    de: {
      renameTitle: "Ableitung von Maßnahmen",
      dueLabel: "Termin / Datum",
      overviewTitle: "Maßnahmenübersicht",
      overviewSub: "Alle Maßnahmen gesammelt (inkl. Termin).",
      colMeasure: "Maßnahme",
      colDue: "Termin",
      colSource: "Quelle",
      colIndex: "#",
      print: "Drucken",
      printHint: "Print: nutzt den aktuellen Stand."
    },
    en: {
      renameTitle: "Derivation of actions",
      dueLabel: "Due date",
      overviewTitle: "Action overview",
      overviewSub: "All actions in one place (including due date).",
      colMeasure: "Action",
      colDue: "Due",
      colSource: "Source",
      colIndex: "#",
      print: "Print",
      printHint: "Print uses the current state."
    }
  };

  function getLang(){
    const l = (localStorage.getItem(LANG_KEY) || "de").toLowerCase();
    return (l === "en") ? "en" : "de";
  }
  function t(k){
    return TXT[getLang()][k] || k;
  }

  // -------- helpers --------
  function norm(s){ return (s||"").toLowerCase().replace(/\s+/g," ").trim(); }
  function hash(str){
    // small stable hash (not crypto) for localStorage keys
    let h = 0;
    const s = String(str||"");
    for(let i=0;i<s.length;i++){
      h = ((h<<5) - h) + s.charCodeAt(i);
      h |= 0;
    }
    return String(Math.abs(h));
  }

  // Find the "actions derived from SWOT" heading by text
  function findSwotDerivationHeading(){
    const headings = Array.from(document.querySelectorAll("h1,h2,h3,h4"));
    const deNeedle = "aus swot entstehen maßnahmen";
    const enNeedle = "actions"; // fallback heuristic
    for(const h of headings){
      const tx = norm(h.textContent);
      if(tx.includes(deNeedle)) return h;
      // if user had "Highlight: Aus SWOT entstehen Maßnahmen"
      if(tx.includes("highlight") && tx.includes("swot") && tx.includes("maßnahmen")) return h;
    }
    // fallback: look for a heading containing "swot" + "maßnahmen"
    for(const h of headings){
      const tx = norm(h.textContent);
      if(tx.includes("swot") && (tx.includes("maßnahmen") || tx.includes("measures") || tx.includes("actions"))) return h;
    }
    return null;
  }

  // Locate the container that actually holds the measures list near the heading
  function findMeasuresHost(heading){
    if(!heading) return null;

    const card = heading.closest("section, .card, .swot-card, .vuca-card, .ishikawa-card") || heading.parentElement;
    if(!card) return null;

    // heuristic: first list after heading
    // try: within the same card, find a UL/OL with LI items
    const lists = Array.from(card.querySelectorAll("ul,ol")).filter(l => l.querySelector("li"));
    if(lists.length) return lists[0];

    // fallback: any container with measure-ish class names
    const maybe = card.querySelector('[class*="measure"],[class*="massnah"],[class*="action"]');
    return maybe || null;
  }

  // Extract measure text from a list item (robust)
  function getMeasureText(li){
    // try to ignore our injected duewrap text
    const clone = li.cloneNode(true);
    clone.querySelectorAll(".qm-swot-addon-duewrap").forEach(x=>x.remove());
    return norm(clone.textContent).replace(/\s+/g," ").trim();
  }

  // Inject date picker into each measure item
  function enhanceMeasuresWithDueDates(measuresHost){
    if(!measuresHost) return [];

    const items = Array.from(measuresHost.querySelectorAll("li"));
    const rows = [];

    items.forEach((li, idx)=>{
      if(li.querySelector(".qm-swot-addon-duewrap")) {
        // still collect row
        const text = getMeasureText(li);
        const key = DUE_KEY_PREFIX + hash(text || ("idx_"+idx));
        const due = localStorage.getItem(key) || "";
        rows.push({ idx: idx+1, text, due, key, source: "" });
        return;
      }

      const text = getMeasureText(li);
      const key = DUE_KEY_PREFIX + hash(text || ("idx_"+idx));
      const dueSaved = localStorage.getItem(key) || "";

      const wrap = document.createElement("div");
      wrap.className = "qm-swot-addon-duewrap";

      const lab = document.createElement("label");
      lab.textContent = t("dueLabel");

      const input = document.createElement("input");
      input.type = "date";
      input.value = dueSaved;
      input.className = "qm-swot-addon-due";

      input.addEventListener("change", ()=>{
        localStorage.setItem(key, input.value || "");
        buildOverview(); // refresh overview when due date changes
      });

      wrap.appendChild(lab);
      wrap.appendChild(input);

      li.appendChild(wrap);

      rows.push({ idx: idx+1, text, due: input.value || "", key, source: "" });
    });

    return rows;
  }

  // Create (or reuse) overview section after the derivation card
  function ensureOverviewSection(heading){
    const card = heading.closest("section, .card, .swot-card, .vuca-card, .ishikawa-card") || heading.parentElement;
    if(!card) return null;

    let ov = card.querySelector(".qm-swot-addon-overview");
    if(ov) return ov;

    ov = document.createElement("div");
    ov.className = "qm-swot-addon-overview";

    ov.innerHTML = `
      <div class="qm-swot-addon-overview-head">
        <div>
          <h3 class="qm-swot-addon-overview-title">${t("overviewTitle")}</h3>
          <p class="qm-swot-addon-overview-sub">${t("overviewSub")}</p>
        </div>
        <div class="qm-swot-addon-actions qm-no-print">
          <button type="button" class="qm-swot-addon-btn primary" id="qmSwotPrintBtn">${t("print")}</button>
          <span class="qm-swot-addon-muted">${t("printHint")}</span>
        </div>
      </div>
      <div class="qm-swot-addon-overview-body">
        <div id="qmSwotOverviewTableWrap"></div>
      </div>
    `;

    // Insert right AFTER the card content (below the measures derivation area)
    card.appendChild(ov);

    // Wire print
    const pb = ov.querySelector("#qmSwotPrintBtn");
    if(pb){
      pb.addEventListener("click", ()=> window.print());
    }

    return ov;
  }

  // Rename heading: remove "Highlight" and set new title
  function renameDerivationHeading(heading){
    if(!heading) return;

    // If it contains "Highlight:" -> replace fully
    const tx = heading.textContent || "";
    if(/highlight/i.test(tx) || /aus swot entstehen maßnahmen/i.test(tx)){
      heading.textContent = t("renameTitle");
    }
  }

  // Build overview table from current measures list
  function buildOverview(){
    const heading = findSwotDerivationHeading();
    if(!heading) return;

    const host = findMeasuresHost(heading);
    if(!host) return;

    // ensure due inputs exist and collect rows
    const rows = enhanceMeasuresWithDueDates(host);

    const ov = ensureOverviewSection(heading);
    if(!ov) return;

    // update overview texts on language switch
    ov.querySelector(".qm-swot-addon-overview-title").textContent = t("overviewTitle");
    ov.querySelector(".qm-swot-addon-overview-sub").textContent = t("overviewSub");
    const pb = ov.querySelector("#qmSwotPrintBtn");
    if(pb) pb.textContent = t("print");
    const hint = ov.querySelector(".qm-swot-addon-muted");
    if(hint) hint.textContent = t("printHint");

    // table
    const wrap = ov.querySelector("#qmSwotOverviewTableWrap");
    if(!wrap) return;

    if(!rows.length){
      wrap.innerHTML = `<div class="qm-swot-addon-muted">—</div>`;
      return;
    }

    const bodyRows = rows.map(r=>{
      const due = r.due ? r.due : "—";
      return `
        <tr>
          <td>${r.idx}</td>
          <td>${(r.text || "—")}</td>
          <td>${due}</td>
          <td>${r.source || "—"}</td>
        </tr>
      `;
    }).join("");

    wrap.innerHTML = `
      <table class="qm-swot-addon-table">
        <thead>
          <tr>
            <th style="width:52px">${t("colIndex")}</th>
            <th>${t("colMeasure")}</th>
            <th style="width:150px">${t("colDue")}</th>
            <th style="width:140px">${t("colSource")}</th>
          </tr>
        </thead>
        <tbody>
          ${bodyRows}
        </tbody>
      </table>
    `;
  }

  // Observe dynamic changes (if measures are generated live)
  let pending = false;
  function schedule(){
    if(pending) return;
    pending = true;
    requestAnimationFrame(()=>{
      pending = false;
      const heading = findSwotDerivationHeading();
      if(!heading) return;
      renameDerivationHeading(heading);
      buildOverview();
    });
  }

  // React to language changes (buttons or storage)
  window.addEventListener("storage", (e)=>{
    if(e.key === LANG_KEY) schedule();
  });

  // Mutation observer catches rerenders
  const mo = new MutationObserver(()=> schedule());
  mo.observe(document.body, { childList:true, subtree:true });

  // Initial run
  schedule();

})();
</script>
