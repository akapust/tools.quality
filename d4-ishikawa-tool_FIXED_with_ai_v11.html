<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- optional: html2canvas (falls du PNG doch behalten willst) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <title>Ishikawa Tool (6M) – Ursachenanalyse</title>

  <style>
    :root {
      --blue: #1155b2;
      --dark: #09387a;
      --light-bg: #f8fafc;
      --note: #fff9c4;

      --border:#d1d9e6;
      --text:#27304d;
      --muted:#64748b;

      --green:#16a34a;
      --yellow:#f59e0b;
      --red:#e53e3e;

      --radius: 6px;
      --shadow: 0 4px 12px rgba(0,0,0,0.10);
    }

    body { margin:0; background:#fff; color: var(--text); }

    .ishikawa-app {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 12px;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      color: #27304d;
    }
    .ishikawa-card { background: #fff; border: 1px solid var(--border); border-radius: 6px; box-shadow: var(--shadow); overflow:hidden; }

    /* Intro */
    .tool-intro { padding: 22px 25px; border-bottom: 3px solid var(--blue); background: var(--light-bg); }
    .tool-intro-top { display:flex; align-items:flex-start; justify-content:space-between; gap: 15px; flex-wrap: wrap; }
    .tool-title { margin: 0; color: var(--dark); font-size: 20px; text-transform: uppercase; font-weight: 900; letter-spacing:.4px; }
    .tool-sub { margin: 6px 0 0; font-size: 13px; color: var(--muted); max-width: 75ch; }
    .tool-grid { margin-top: 16px; display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .tool-box { background:#fff; border: 1px solid var(--border); border-radius: 6px; padding: 12px 14px; }
    .tool-box h3 { margin: 0 0 6px 0; font-size: 13px; color: var(--dark); text-transform: uppercase; font-weight: 900; letter-spacing:.25px; }
    .tool-box p, .tool-box ol { margin: 0; font-size: 13px; color:#334155; }
    .tool-box ol { padding-left: 18px; }
    
    /* Info box split headings */
    .subhead {
      margin: 12px 0 6px;
      font-size: 12px;
      letter-spacing: .10em;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 900;
    }
    .divider-mini {
      height: 1px;
      background: var(--border);
      margin: 12px 0;
      opacity: .9;
    }
    .pill-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      letter-spacing: .12em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: var(--light-bg);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 900;
      color: var(--text);
      margin-bottom: 8px;
    }
    .how-split {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 8px;
    }
    @media(min-width: 900px){
      .how-split { grid-template-columns: 1fr 1fr; }
    }
.tool-privacy { border-left: 3px solid var(--blue); }
    .tool-box a { color: var(--blue); text-decoration: none; font-weight: 800; }
    .tool-box a:hover { text-decoration: underline; }

    /* Buttons */
    .ishikawa-actions {
      margin-top: 18px;
      padding-top: 16px;
      border-top: 2px solid var(--blue);
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content: space-between;
    }
    .actions-left, .actions-right { display:flex; gap: 10px; flex-wrap: wrap; align-items:center; }

    .i-btn {
      padding: 10px 16px;
      font-size: 12px;
      font-weight: 900;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid var(--border);
      background: #fff;
      text-transform: uppercase;
      letter-spacing:.3px;
      text-decoration: none;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
      color: var(--dark);
    }
    .i-btn:hover { background: #f1f5f9; border-color: rgba(17,85,178,.35); }
    .i-btn.primary { background: var(--blue); color: #fff; border-color: var(--blue); }
    .i-btn.primary:hover { background: var(--dark); border-color: var(--dark); }
    .i-btn.danger { color: #e53e3e; border-color: rgba(229,62,62,.35); }
    .i-btn.small { padding: 8px 10px; font-size: 11px; }

    .lang-switch { display:flex; gap: 8px; align-items:center; }
    .lang-switch .i-btn { padding: 8px 12px; font-size: 12px; }

    /* Diagram */
    .ishikawa-body { padding: 22px 25px; }
    .ishikawa-drawing-area { padding: 50px 20px; background: white; border: 1px solid #edf2f7; position: relative; border-radius: 10px; }

    .ishikawa-row { display: grid; grid-template-columns: repeat(3, 1fr); gap: 30px; margin-right: 200px; }
    .graete { border-left: 3px solid var(--blue); padding-left: 15px; min-height: 120px; display: flex; flex-direction: column; }
    .bottom .graete { margin-top: 30px; }

    .m-label { font-weight: 900; color: var(--dark); text-transform: uppercase; font-size: 13px; margin-bottom: 10px; border-bottom: 1px solid #eee; letter-spacing:.25px; }
    .notes-container { display: flex; flex-direction: column; gap: 8px; flex-grow: 1; }

    .note-item {
      background: var(--note);
      padding: 8px;
      font-size: 12px;
      border-left: 3px solid #fbc02d;
      box-shadow: 2px 2px 4px rgba(0,0,0,0.05);
      position: relative;
      padding-right: 34px; /* Platz für Löschen-Button */
      border-radius: 6px;
    }
    .note-item textarea { width: 100%; border: none; background: transparent; resize: none; font-family: inherit; outline: none; color:#0f172a; }
    .note-item textarea::placeholder{ color:#64748b; }

    /* delete */
    .note-delete {
      position: absolute;
      top: 6px;
      right: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 18px;
      line-height: 1;
      color: #94a3b8;
    }
    .note-delete:hover { color: #e53e3e; }

    /* rating dot (shows current triage) */
    .rate-dot{
      position:absolute;
      top: 8px;
      left: 8px;
      width: 10px; height: 10px;
      border-radius: 999px;
      border: 1px solid rgba(15,23,42,.15);
      background: rgba(100,116,139,.25);
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
    }
    .rate-dot.red{ background: var(--red); border-color: rgba(229,62,62,.45); }
    .rate-dot.yellow{ background: var(--yellow); border-color: rgba(245,158,11,.55); }
    .rate-dot.green{ background: var(--green); border-color: rgba(22,163,74,.55); }

    .btn-add { background: none; border: 1px dashed #cbd5e1; color: #94a3b8; cursor: pointer; font-size: 11px; margin-top: 10px; padding: 6px; border-radius: 6px; font-weight: 900; text-transform: uppercase; letter-spacing:.25px; }
    .btn-add:hover { background: #f1f5f9; color: var(--blue); border-color: rgba(17,85,178,.45); }

    /* Spine & head */
    .ishikawa-spine { height: 4px; background: var(--blue); margin: 15px 0; position: relative; display: flex; align-items: center; justify-content: flex-end; border-radius: 999px; }
    .fish-head {
      width: 220px; height: 120px; background: var(--blue);
      clip-path: polygon(0% 50%, 20% 0%, 100% 0%, 100% 100%, 20% 100%);
      display: flex; align-items: center; justify-content: center; padding: 15px; margin-right: -20px;
      border-radius: 10px;
    }
    .fish-head textarea {
      width: 85%; height: 75%; background: white; border: none; border-radius: 6px;
      padding: 10px; font-weight: 900; font-size: 14px; text-align: center; color: var(--dark);
      outline:none;
    }

    /* NEW: Bewertung & Maßnahmen sections */
    .section{
      margin-top: 18px;
      padding-top: 16px;
      border-top: 2px solid var(--blue);
    }
    .section-title{
      margin:0 0 6px;
      font-size: 13px;
      color: var(--dark);
      text-transform: uppercase;
      font-weight: 900;
      letter-spacing:.25px;
    }
    .section-sub{
      margin:0 0 12px;
      font-size: 13px;
      color: var(--muted);
    }

    .triage-box{
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
      overflow:hidden;
    }
    .triage-head{
      padding: 10px 14px;
      background: var(--light-bg);
      border-bottom: 1px solid rgba(15,23,42,.08);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .triage-meta{ font-size: 12px; color: var(--muted); font-weight: 800; }

    .triage-table{
      width: 100%;
      border-collapse: collapse;
    }
    .triage-table th, .triage-table td{
      padding: 10px 14px;
      border-bottom: 1px solid rgba(15,23,42,.06);
      vertical-align: top;
      font-size: 13px;
    }
    .triage-table th{
      text-align:left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing:.2px;
      color:#334155;
      background: rgba(248,250,252,.8);
    }

    .chips{ display:flex; gap: 8px; flex-wrap: wrap; }
    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .chip.active{ border-color: rgba(17,85,178,.45); color: var(--blue); background: rgba(17,85,178,.06); }

    .rate-chips{ display:flex; gap: 8px; flex-wrap: wrap; }
    .rate{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 10px;
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      font-size: 12px;
      font-weight: 900;
      cursor:pointer;
      user-select:none;
      white-space: nowrap;
    }
    .dot{ width: 10px; height: 10px; border-radius: 999px; display:inline-block; }
    .rate.red .dot{ background: var(--red); }
    .rate.yellow .dot{ background: var(--yellow); }
    .rate.green .dot{ background: var(--green); }
    .rate.selected{
      box-shadow: 0 8px 18px rgba(0,0,0,.10);
      transform: translateY(-1px);
      border-color: rgba(15,23,42,.18);
    }
    .rate.red.selected{ background: rgba(229,62,62,.08); border-color: rgba(229,62,62,.40); }
    .rate.yellow.selected{ background: rgba(245,158,11,.10); border-color: rgba(245,158,11,.45); }
    .rate.green.selected{ background: rgba(22,163,74,.08); border-color: rgba(22,163,74,.45); }

    .mini-btn{
      border: 1px solid rgba(15,23,42,.12);
      background:#fff;
      border-radius: 6px;
      padding: 8px 10px;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
    }
    .mini-btn:hover{ border-color: rgba(17,85,178,.45); color: var(--blue); background: rgba(17,85,178,.06); }
    .mini-btn.danger{ border-color: rgba(239,68,68,.30); color:#b91c1c; }
    .mini-btn.danger:hover{ background: rgba(239,68,68,.08); border-color: rgba(239,68,68,.45); color:#b91c1c; }

    /* Measures draft + list (same logic as Prozessanalyse) */
    .measure-draft{
      border: 1px solid var(--border);
      border-radius: 10px;
      background:#fff;
      padding: 12px 14px;
    }
    .draft-grid{
      display:grid;
      grid-template-columns: 1.2fr .6fr .6fr;
      gap: 10px;
      align-items:end;
    }
    @media(max-width: 900px){ .draft-grid{ grid-template-columns: 1fr; } }

    .field label{
      display:block;
      font-size: 12px;
      font-weight: 900;
      text-transform: uppercase;
      color:#334155;
      letter-spacing:.2px;
      margin-bottom: 6px;
    }
    .field input, .field textarea{
      width: 100%;
      padding: 10px 12px;
      border:1px solid rgba(15,23,42,.14);
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
      outline:none;
      background:#fff;
    }
    .field textarea{ min-height: 84px; resize: vertical; }

    .draft-actions{
      margin-top: 10px;
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content:flex-end;
      border-top: 1px solid rgba(15,23,42,.08);
      padding-top: 10px;
    }
    .hint-mini{ font-size: 12px; color: var(--muted); margin-top: 8px; }

    .measures-list{
      margin-top: 12px;
      border:1px solid var(--border);
      border-radius: 10px;
      background:#fff;
      overflow:hidden;
    }
    .measures-head{
      padding: 10px 14px;
      background: var(--light-bg);
      border-bottom: 1px solid rgba(15,23,42,.08);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .measures-sub{ font-size: 12px; color: var(--muted); font-weight: 800; margin-top: 4px; }

    .measures-table{
      width:100%;
      border-collapse: collapse;
    }
    .measures-table th, .measures-table td{
      padding: 10px 14px;
      border-bottom: 1px solid rgba(15,23,42,.06);
      vertical-align: top;
      font-size: 13px;
    }
    .measures-table th{
      text-align:left;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing:.2px;
      color:#334155;
      background: rgba(248,250,252,.8);
    }
    .status-pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 5px 10px;
      border: 1px solid rgba(15,23,42,.12);
      font-size: 12px;
      font-weight: 900;
      white-space: nowrap;
      background:#fff;
    }
    .status-open{ border-color: rgba(37,99,235,.30); background: rgba(37,99,235,.06); color: #1d4ed8; }
    .status-done{ border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.08); color: #15803d; }
    .status-drop{ border-color: rgba(239,68,68,.28); background: rgba(239,68,68,.08); color: #b91c1c; }

    .row-actions{ display:flex; gap: 8px; flex-wrap: wrap; justify-content:flex-end; }

    .muted{ color: var(--muted); }

    /* AI Assistant (slim section below JSON save/load) */
    .ai-assistant{
      margin-top: 18px;
      padding-top: 16px;
      border-top: 2px solid var(--blue);
    }
    .ai-grid{
      margin-top: 12px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .ai-grid{ grid-template-columns: 1fr; }
    }
    .ai-card{
      border: 1px solid var(--border);
      border-radius: 10px;
      background:#fff;
      overflow:hidden;
    }
    .ai-card-head{
      padding: 10px 14px;
      background: var(--light-bg);
      border-bottom: 1px solid rgba(15,23,42,.08);
      display:flex;
      justify-content: space-between;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .ai-card-body{ padding: 12px 14px; }
    .ai-actions{ display:flex; gap: 10px; flex-wrap: wrap; align-items:center; justify-content:flex-end; margin-top: 10px; }
    .ai-status{ margin-top: 10px; font-size: 12px; color: var(--muted); white-space: pre-wrap; }
    .ai-preview{
      margin:0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(248,250,252,.9);
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 10px;
      padding: 12px;
      overflow: auto;
      max-height: 420px;
    }
    .ai-mini-row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .ai-checkbox{ display:flex; gap:8px; align-items:center; font-size: 12px; color:#334155; font-weight: 900; text-transform: uppercase; letter-spacing:.2px; }


    .type-pill{
      display:inline-flex;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
      text-transform: uppercase;
      letter-spacing:.2px;
      border: 1px solid rgba(15,23,42,.12);
      background: rgba(248,250,252,.9);
      color:#0f172a;
      white-space:nowrap;
    }
    .type-pill.avoid{ border-color: rgba(17,85,178,.25); background: rgba(17,85,178,.06); color: var(--dark); }
    .type-pill.validate{ border-color: rgba(245,158,11,.30); background: rgba(245,158,11,.10); }
    .type-pill.secure{ border-color: rgba(22,163,74,.30); background: rgba(22,163,74,.10); }
    .type-pill.lessons{ border-color: rgba(100,116,139,.28); background: rgba(100,116,139,.10); }

    .subline{
      margin-top: 6px;
      font-size: 12px;
      color: var(--muted);
      white-space: pre-wrap;
    }

    .code-snippet{
      margin: 10px 0 0;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 12px;
      background: rgba(248,250,252,.9);
      border: 1px solid rgba(15,23,42,.12);
      border-radius: 10px;
      padding: 12px;
      overflow:auto;
      max-height: 320px;
    }

    /* More info + footer */
    .tool-more { margin-top: 22px; padding-top: 18px; border-top: 2px solid var(--blue); }
    .more-title { margin: 0 0 6px 0; font-size: 13px; color: var(--dark); text-transform: uppercase; font-weight: 900; }
    .more-sub { margin: 0 0 10px 0; font-size: 13px; color: var(--muted); }
    .more-list { margin: 8px 0 0; padding-left: 18px; font-size: 13px; color:#334155; }
    .more-list li { margin: 4px 0; }

    .ishikawa-footer {
      padding: 12px 25px;
      background: var(--light-bg);
      border-top: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .ishikawa-footer a{ color: var(--dark); font-weight: 900; text-decoration:none; }
    .ishikawa-footer a:hover{ text-decoration: underline; }

    @media (max-width: 900px) {
      .ishikawa-row { margin-right: 0; grid-template-columns: 1fr; }
      .fish-head { width: 100%; margin: 20px 0; clip-path: none; border-radius: 10px; }
      .ishikawa-spine { justify-content: center; }
      .tool-grid { grid-template-columns: 1fr; }
      .triage-table{ display:block; overflow:auto; }
      .measures-table{ display:block; overflow:auto; }
    }

    /* Print */
    @media print {
      .lang-switch, .tool-intro-top .i-btn, .ishikawa-actions, .ai-assistant, .tool-more a, .note-delete,
      .btn-add, .rate-chips, .row-actions, .chips, .mini-btn { display:none !important; }
      .ishikawa-card{ box-shadow:none; border:none; }
      .ishikawa-drawing-area{ border:none; }
      .tool-intro{ border-bottom:none; }
      .tool-more{ border-top:none; }
      .ishikawa-footer{ background:#fff; }
    }
  
    /* --- AI assistant tweaks (v3) --- */
    .ai-card.ai-wide{ grid-column: 1 / -1; }
    .ai-assistant .ai-grid{ display:block; }
    .ai-credentials{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 860px){ .ai-credentials{ grid-template-columns: 1fr; } }
    .api-field{ position:relative; }
    .api-field:before{
      content: "API";
      position:absolute;
      top:-10px;
      right:10px;
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(15,23,42,.08);
      color: #3d3a35;
      letter-spacing:.14em;
    }
    .api-field input{ letter-spacing: .2px; border-style:dashed; background: rgba(250,249,246,.6); }
    .license-field{ position:relative; }
    .license-field:before{
      content: "LIZENZ";
      position:absolute;
      top:-10px;
      right:10px;
      font-size:10px;
      padding:4px 8px;
      border-radius:999px;
      background: rgba(181,164,139,.18);
      color: #3d3a35;
      letter-spacing:.14em;
    }

</style>
</head>

<body>
  <div id="qm-ishikawa-app" class="ishikawa-app">
    <section class="ishikawa-card">

      <!-- Intro -->
      <section class="tool-intro">
        <div class="tool-intro-top">
          <div>
            <h2 class="tool-title" data-i18n="title">Ishikawa Tool (6M) – Ursachenanalyse</h2>
            <p class="tool-sub" data-i18n="subtitle">
              Systematische Ursachenanalyse im Fischgräten-Diagramm – inkl. Ursachen-Bewertung (Rot/Gelb/Grün) und Ableitung von Maßnahmen mit Bezug zur Fehlerursache.
            </p>
          </div>

          <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:flex-end;">
            <div class="lang-switch" aria-label="Language switch">
              <button type="button" class="i-btn" id="btnLangDE">DE</button>
              <button type="button" class="i-btn" id="btnLangEN">EN</button>
            </div>
            <a class="i-btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
          </div>
        </div>

        <div class="tool-grid">
          <div class="tool-box">
            <h3 data-i18n="boxToolNameTitle">Name Tool</h3>
            <p data-i18n="boxToolNameText">Ishikawa-Diagramm (Fischgräte) – 6M</p>
          </div>

          <div class="tool-box">
            <h3 data-i18n="boxGoalTitle">Ziel</h3>
            <p data-i18n="boxGoalText">
              Ursachen strukturiert sammeln, bewerten (Rot/Gelb/Grün) und aus den relevanten Ursachen (Rot/Gelb) Maßnahmen ableiten.
            </p>
          </div>

          <div class="tool-box">
            <h3 data-i18n="boxHowTitle">So benutzt du das Tool</h3>
            <ol>
              <li data-i18n="step1">Effekt / Problem rechts im Kopf eintragen.</li>
              <li data-i18n="step2">Pro 6M-Kategorie Ursachen hinzufügen.</li>
              <li data-i18n="step3">Ursachen unten bewerten: <strong>Rot</strong>=wahrscheinliche Ursache, <strong>Gelb</strong>=schnell prüfbar, <strong>Grün</strong>=aktuell ausgeschlossen.</li>
              <li data-i18n="step4">Aus Rot/Gelb Maßnahmen ableiten (mit Termin) → Maßnahmenliste.</li>
              <li data-i18n="step5">Print oder JSON speichern/laden.</li>
            </ol>
          </div>

          <div class="tool-box tool-privacy">
            <h3 data-i18n="boxPrivacyTitle">Datenschutz</h3>

            <h4 class="subhead" data-i18n="privacyNoApiTitle">Datenschutz (ohne API/KI)</h4>
            <p data-i18n="privacyNoApiText">
              Dieses Tool arbeitet vollständig in deinem Browser. Inhalte werden nicht automatisch an unsere Server übertragen.
              Der aktuelle Stand kann lokal im Browser gespeichert werden (Autosave) und zusätzlich als JSON exportiert/importiert werden.
            </p>

            <div class="divider-mini"></div>

            <h4 class="subhead" data-i18n="privacyApiTitle">Datenschutz (mit API/KI – Premium)</h4>
            <p data-i18n="privacyApiText">
              Wenn du den KI-Assistenten nutzt, werden nur die von dir zur Anfrage ausgewählten Inhalte direkt aus deinem Browser an die OpenAI API übertragen,
              um Vorschläge zu generieren (z. B. Problemtext, Kontext sowie ausgewählte Ursachen/Maßnahmen). Der API-Key wird dabei nicht serverseitig gespeichert.
              Die Premium-Funktion ist ausschließlich für berechtigte Kunden der Quality Services &amp; Wissen GmbH vorgesehen; der Lizenzschlüssel dient als Freischaltung.
              Bitte übermittle keine personenbezogenen oder vertraulichen Inhalte, die nicht in externe Systeme gehören.
            </p>
          </div>
        </div>
      </section>

      <div class="ishikawa-body">
        <div id="capture-area" class="ishikawa-drawing-area">
          <div class="ishikawa-skeleton">
            <div class="ishikawa-row top">
              <div class="graete" data-m="Mensch">
                <div class="m-label" data-i18n="catMensch">Mensch</div>
                <div class="notes-container" id="notes-Mensch"></div>
                <button class="btn-add" type="button" data-cat="Mensch" data-i18n="addCause">+ Ursache</button>
              </div>
              <div class="graete" data-m="Maschine">
                <div class="m-label" data-i18n="catMaschine">Maschine</div>
                <div class="notes-container" id="notes-Maschine"></div>
                <button class="btn-add" type="button" data-cat="Maschine" data-i18n="addCause">+ Ursache</button>
              </div>
              <div class="graete" data-m="Material">
                <div class="m-label" data-i18n="catMaterial">Material</div>
                <div class="notes-container" id="notes-Material"></div>
                <button class="btn-add" type="button" data-cat="Material" data-i18n="addCause">+ Ursache</button>
              </div>
            </div>

            <div class="ishikawa-spine">
              <div class="fish-head">
                <textarea id="problemInput" data-i18n-placeholder="problemPlaceholder" placeholder="HAUPTPROBLEM / EFFEKT HIER EINTRAGEN..."></textarea>
              </div>
            </div>

            <div class="ishikawa-row bottom">
              <div class="graete" data-m="Methode">
                <div class="m-label" data-i18n="catMethode">Methode</div>
                <div class="notes-container" id="notes-Methode"></div>
                <button class="btn-add" type="button" data-cat="Methode" data-i18n="addCause">+ Ursache</button>
              </div>
              <div class="graete" data-m="Mitwelt">
                <div class="m-label" data-i18n="catMitwelt">Mitwelt</div>
                <div class="notes-container" id="notes-Mitwelt"></div>
                <button class="btn-add" type="button" data-cat="Mitwelt" data-i18n="addCause">+ Ursache</button>
              </div>
              <div class="graete" data-m="Messung">
                <div class="m-label" data-i18n="catMessung">Messung</div>
                <div class="notes-container" id="notes-Messung"></div>
                <button class="btn-add" type="button" data-cat="Messung" data-i18n="addCause">+ Ursache</button>
              </div>
            </div>
          </div>
        </div>

        <!-- NEW: Ursachen-Bewertung -->
        <section class="section" aria-label="Ursachen bewerten">
          <h3 class="section-title" data-i18n="triageTitle">Ursachen bewerten (Rot / Gelb / Grün)</h3>
          <p class="section-sub" data-i18n="triageSub">
            Bewerte jede Ursache: <strong>Rot</strong> = sehr wahrscheinlich, <strong>Gelb</strong> = schnell prüfbar, <strong>Grün</strong> = momentan ausgeschlossen. Bewertungen können sich ändern.
          </p>

          <div class="triage-box">
            <div class="triage-head">
              <div>
                <div class="section-title" style="margin:0" data-i18n="triageListTitle">Ursachenliste</div>
                <div class="triage-meta" id="triageMeta">—</div>
              </div>
              <div class="chips" aria-label="Filter">
                <span class="chip active" data-filter="all" data-i18n="filterAll">Alle</span>
                <span class="chip" data-filter="red" data-i18n="filterRed">Rot</span>
                <span class="chip" data-filter="yellow" data-i18n="filterYellow">Gelb</span>
                <span class="chip" data-filter="green" data-i18n="filterGreen">Grün</span>
                <span class="chip" data-filter="ry" data-i18n="filterRY">Rot+Gelb</span>
              </div>
            </div>

            <table class="triage-table" aria-label="Ursachen Tabelle">
              <thead>
                <tr>
                  <th style="width:160px" data-i18n="thCategory">Kategorie</th>
                  <th data-i18n="thCause">Ursache</th>
                  <th style="width:340px" data-i18n="thTriage">Bewertung</th>
                  <th style="width:240px; text-align:right" data-i18n="thActions">Aktion</th>
                </tr>
              </thead>
              <tbody id="triageTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- NEW: Ableitung von Maßnahmen (mit Bezug zur Ursache) -->
        <section class="section" aria-label="Ableitung von Maßnahmen">
          <h3 class="section-title" data-i18n="measuresTitle">Ableitung von Maßnahmen</h3>
          <p class="section-sub" data-i18n="measuresSub">
            Aus <strong>roten</strong> und <strong>gelben</strong> Ursachen werden Maßnahmen abgeleitet. Jede Maßnahme bleibt mit der Ursache verknüpft.
          </p>

          <div class="measure-draft">
            <div class="draft-grid">
              <div class="field">
                <label data-i18n="draftCauseRefLabel">Bezug (Ursache)</label>
                <input id="draftCauseRef" type="text" readonly value="—" />
                <div class="hint-mini" data-i18n="draftCauseHint">Wähle eine Ursache in der Ursachenliste (Aktion: „Als Maßnahme übernehmen“).</div>
              </div>
            </div>

            <div class="draft-grid2" style="margin-top:10px;">
              <div class="field">
                <label for="draftType" data-i18n="draftTypeLabel">Maßnahmenart</label>
                <select id="draftType" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px; font-size:14px; font-family:inherit; outline:none; background:#fff;">
                  <option value="avoid" data-i18n="typeAvoid">Fehlervermeidung</option>
                  <option value="validate" data-i18n="typeValidate">Validierung / Wirksamkeitsnachweis</option>
                  <option value="secure" data-i18n="typeSecure">Absicherungsmaßnahmen</option>
                  <option value="lessons" data-i18n="typeLessons">Lessons Learned</option>
                </select>
              </div>

              <div class="field">
                <label for="draftOwner" data-i18n="draftOwnerLabel">Owner (Bereich)</label>
                <input id="draftOwner" type="text" data-i18n-placeholder="draftOwnerPh" placeholder="z.B. Qualität / Produktion" />
              </div>

              <div class="field">
                <label for="draftResp" data-i18n="draftRespLabel">Verantwortung</label>
                <input id="draftResp" type="text" data-i18n-placeholder="draftRespPh" placeholder="z.B. Max Mustermann / Rolle" />
              </div>

              <div class="field">
                <label for="draftDue" data-i18n="draftDueLabel">Termin</label>
                <input id="draftDue" type="date" />
              </div>
            </div>

            <div class="field" style="margin-top:10px;">
              <label for="draftMeasure" data-i18n="draftMeasureLabel">Maßnahme</label>
              <textarea id="draftMeasure" data-i18n-placeholder="draftMeasurePh" placeholder="Welche Maßnahme reduziert/prüft diese Ursache?"></textarea>
            </div>

            <div class="field" style="margin-top:10px;">
              <label for="draftEvidence" data-i18n="draftEvidenceLabel">Nachweis / Wirksamkeit</label>
              <textarea id="draftEvidence" data-i18n-placeholder="draftEvidencePh" placeholder="Dummy-Prüfung, Versuche, Kurzzeitfähigkeit, Kennzahlen, Audit, etc." style="min-height:72px;"></textarea>
            </div>

            <div class="draft-actions">
              <button type="button" class="i-btn primary" id="btnSaveDraft" data-i18n="btnSaveDraft">In Maßnahmenliste speichern</button>
              <button type="button" class="i-btn" id="btnClearDraft" data-i18n="btnClearDraft">Eingabe leeren</button>
              <button type="button" class="i-btn" id="btnSeedFromRY" data-i18n="btnSeedFromRY">Rote/Gelbe als Vorschläge anlegen</button>
            </div>
            <div class="hint-mini" data-i18n="draftHint">
              Tipp: „Rote/Gelbe als Vorschläge“ erstellt pro Rot/Gelb-Ursache (falls noch nicht vorhanden) einen Maßnahmen-Entwurf in der Liste (Status: Offen).
            </div>
          </div>

          <div class="measures-list" aria-label="Maßnahmenliste">
            <div class="measures-head">
              <div>
                <div class="section-title" style="margin:0" data-i18n="listTitle">Maßnahmenliste</div>
                <div class="measures-sub" id="measuresMeta">—</div>
              </div>
              <div class="chips" aria-label="Filter">
                <span class="chip active" data-mfilter="all" data-i18n="filterAll">Alle</span>
                <span class="chip" data-mfilter="open" data-i18n="mFilterOpen">Offen</span>
                <span class="chip" data-mfilter="done" data-i18n="mFilterDone">Abgeschlossen</span>
                <span class="chip" data-mfilter="drop" data-i18n="mFilterDrop">Verworfen</span>
              </div>
            </div>

            <table class="measures-table" aria-label="Maßnahmen Tabelle">
              <thead>
                <tr>
                  <th style="width:220px" data-i18n="thRef">Bezug (Ursache)</th>
                  <th style="width:170px" data-i18n="thType">Art</th>
                  <th data-i18n="thMeasure">Maßnahme</th>
                  <th style="width:260px" data-i18n="thEvidence">Nachweis / Wirksamkeit</th>
                  <th style="width:200px" data-i18n="thOwner">Owner / Verantwortung</th>
                  <th style="width:120px" data-i18n="thDue">Termin</th>
                  <th style="width:160px" data-i18n="thStatus">Status</th>
                  <th style="width:260px; text-align:right" data-i18n="thActions">Aktionen</th>
                </tr>
              </thead>
              <tbody id="measuresTbody"></tbody>
            </table>
          </div>
        </section>

        <!-- Actions -->
        <div class="ishikawa-actions">
          <div class="actions-left">
            <a class="i-btn" href="https://tools.quality.de/" data-i18n="backHome">Zurück zur Startseite</a>
            <button type="button" class="i-btn primary" id="btnPrint" data-i18n="btnPrint">Drucken</button>
            <button type="button" class="i-btn" id="btnExportPng" data-i18n="btnExportPng">PNG Export</button>
            <button type="button" class="i-btn" id="btnExportSvg" data-i18n="btnExportSvg">SVG Export</button>
          </div>

          <div class="actions-right">
            <button type="button" class="i-btn" id="btnSaveJson" data-i18n="btnSaveJson">JSON Speichern</button>
            <button type="button" class="i-btn" id="btnLoadJson" data-i18n="btnLoadJson">JSON Laden</button>
            <input type="file" id="jsonFile" accept="application/json" style="display:none" />
            <button type="button" class="i-btn danger" id="btnReset" data-i18n="btnReset">Reset</button>
          </div>
        </div>

        <!-- NEW: KI Assistent (unterhalb Download/Upload) -->
        <section class="ai-assistant" aria-label="KI Assistent">
          <h3 class="section-title" data-i18n="aiTitle">KI Assistent</h3>
          <p class="section-sub" data-i18n="aiSub">NLP-gestützte Unterstützung: Der Assistent strukturiert aus Fehlerbild + Kontext mögliche 6M-Ursachen und passende Maßnahmen-Typen (inkl. Nachweis/Wirksamkeit). Hinweis: Diese Funktion steht nur Kunden der Quality Services &amp; Wissen GmbH zur Verfügung.</p>

          <div class="ai-card ai-wide">
            <div class="ai-card-head">
              <div class="section-title" style="margin:0" data-i18n="aiInputTitle">Eingabe</div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; align-items:center;">
                <button type="button" class="mini-btn" id="btnAiTakeProblem" data-i18n="aiTakeProblem">Fehlerbild übernehmen</button>
                <button type="button" class="mini-btn" id="btnAiContextFromTool" data-i18n="aiContextFromTool">Kontext aus Tool</button>
              </div>
            </div>
            <div class="ai-card-body">

              <div class="ai-credentials">
                <div class="field api-field">
                  <label for="aiApiKey" data-i18n="aiApiKeyLabel">OpenAI API Key</label>
                  <input id="aiApiKey" type="password" autocomplete="off" placeholder="sk-..." />
                  <div class="hint-mini" data-i18n="aiPrivacyHint">Hinweis: Für Produktion besser Server-Proxy nutzen.</div>
                </div>

                <div class="field license-field">
                  <label for="aiLicense" data-i18n="aiLicenseLabel">Lizenzschlüssel</label>
                  <input id="aiLicense" type="password" autocomplete="off" data-i18n-placeholder="aiLicensePh" placeholder="••••" />
                  <div class="hint-mini" data-i18n="aiLicenseHint">Kunden von Quality Services &amp; Wissen erhalten einen Lizenzschlüssel.</div>
                </div>

                <div class="ai-mini-row" style="margin-top:10px; justify-content:flex-start;">
                  <label class="ai-checkbox">
                    <input id="aiRemember" type="checkbox" />
                    <span data-i18n="aiRemember">Key lokal speichern</span>
                  </label>
                </div>
              </div>

              <div class="field" style="margin-top:10px;">
                <label for="aiProblem" data-i18n="aiProblemLabel">Fehlerbild (kurz)</label>
                <input id="aiProblem" type="text" />
              </div>

              <div class="field" style="margin-top:10px;">
                <label for="aiContext" style="margin:0" data-i18n="aiContextLabel">Kontext (Details)</label>
                <textarea id="aiContext" placeholder="" style="min-height: 140px;"></textarea>
                <div class="hint-mini" data-i18n="aiContextHint">Tipp: Prozess, Maschine/Anlage, Material, Messmittel, Schicht, Umgebungsbedingungen, Änderungen, Häufigkeit.</div>
              </div>

              <div class="ai-actions">
                <button type="button" class="i-btn primary" id="btnAiGenerate" data-i18n="aiGenerate" disabled>Ursachen generieren</button>
                <button type="button" class="i-btn" id="btnAiApply" data-i18n="aiApply" disabled>Ins Tool übernehmen</button>
                <button type="button" class="i-btn" id="btnAiDownload" data-i18n="aiDownload" disabled>JSON Download</button>
                <button type="button" class="i-btn" id="btnAiClear" data-i18n="aiClear">Zurücksetzen</button>
              </div>

              <div id="aiStatus" class="ai-status"></div>
            </div>
          </div>
        </section>

        <!-- More -->
        <section class="tool-more">
          <h3 class="more-title" data-i18n="moreTitle">Weiterführende Infos</h3>
          <p class="more-sub" data-i18n="moreSub">Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).</p>

          <div class="tool-grid">
            <div class="tool-box">
              <h3 data-i18n="lexTitle">Lexikon</h3>
              <p data-i18n="lexText">Hintergrund, Nutzen & Anwendung des Ishikawa-Diagramms.</p>
              <p style="margin-top:8px;">
                <a href="https://www.quality.de/lexikon/ishikawa/" target="_blank" rel="noopener" data-i18n="lexLink">Zum Lexikonartikel: Ishikawa</a>
              </p>
            </div>

            <div class="tool-box">
              <h3 data-i18n="trainTitle">Ausbildungen &amp; Seminare</h3>
              <p data-i18n="trainText">Vertiefe deine Methodenkompetenz im Qualitätsmanagement:</p>
              <ul class="more-list">
                <li><a href="https://www.quality.de/weiterbildung/kvp/" target="_blank" rel="noopener" data-i18n="trainKvp">KVP Seminare</a></li>
                <li><a href="https://www.quality.de/weiterbildung/8d-seminare-8d-schulungen/" target="_blank" rel="noopener" data-i18n="train8d">8D Schulungen</a></li>
                <li><a href="https://www.quality.de/weiterbildung/qualitaetsmanagement/" target="_blank" rel="noopener" data-i18n="trainQm">Qualitätsmanagement</a></li>
              </ul>
            </div>


            <div class="tool-box">
              <h3 data-i18n="embedTitle">Tool auf der eigenen Homepage einbinden</h3>
              <p data-i18n="embedText">Du kannst das Tool professionell per <strong>iframe</strong> auf deiner Website einbinden – auch wenn sie öffentlich im Internet erreichbar ist. Dabei wird immer die aktuelle Version von <strong>tools.quality.de</strong> geladen (inkl. automatischer Updates).</p>
              <div style="margin-top:8px; display:flex; justify-content:flex-end;">
                <button type="button" class="mini-btn" id="btnCopyIframe" data-i18n="embedCopy">Code kopieren</button>
              </div>
              <pre class="code-snippet" id="iframeSnippet">&lt;div style="position:relative; width:100%; height:2800px; border-radius:16px; overflow:hidden;"&gt;
  &lt;iframe
    src="https://tools.quality.de/d4-ishikawa-tool.html"
    style="width:100%; height:100%; border:0;"
    loading="lazy"&gt;
  &lt;/iframe&gt;
&lt;/div&gt;</pre>
              <div class="hint-mini" id="embedStatus" aria-live="polite"></div>
            </div>
          </div>
        </section>
      </div>

      <footer class="ishikawa-footer">
        <div>Copyright 2026 Quality Services &amp; Wissen GmbH</div>
        <div>
          © 2026 <a href="https://www.quality.de/" target="_blank" rel="noopener">Quality Services &amp; Wissen GmbH</a> |
          Made with Love (Her) in Germany – betreut durch <a href="https://webseitendoktor.de/" target="_blank" rel="noopener">Webseitendoktor.de</a>
        </div>
      </footer>
    </section>
  </div>

  <script>
  (function(){
    const ROOT = document.getElementById("qm-ishikawa-app");
    if(!ROOT) return;

    const CATS = ["Mensch","Maschine","Material","Methode","Mitwelt","Messung"];
    const STORAGE_KEY = "qm_ishikawa_triage_measures_v1";
    const LANG_KEY = "qmLang";
    const $ = (sel) => ROOT.querySelector(sel);
    const $$ = (sel) => Array.from(ROOT.querySelectorAll(sel));

    // ---------- i18n ----------
    const I18N = {
      de: {
        title: "Ishikawa Tool (6M) – Ursachenanalyse",
        subtitle: "Systematische Ursachenanalyse im Fischgräten-Diagramm – inkl. Ursachen-Bewertung (Rot/Gelb/Grün) und Ableitung von Maßnahmen mit Bezug zur Fehlerursache.",
        backHome: "Zurück zur Startseite",

        boxToolNameTitle: "Name Tool",
        boxToolNameText: "Ishikawa-Diagramm (Fischgräte) – 6M",
        boxGoalTitle: "Ziel",
        boxGoalText: "Ursachen strukturiert sammeln, bewerten (Rot/Gelb/Grün) und aus den relevanten Ursachen (Rot/Gelb) Maßnahmen ableiten.",
        boxHowTitle: "So benutzt du das Tool",

        howWithoutTitle: "Ohne KI",
        howWithTitle: "Mit KI (Premium)",
        kiStep1: "Effekt / Problem eintragen (oder später).",
        kiStep2: "OpenAI API-Key + Lizenz eingeben.",
        kiStep3: "Fehlerursachen-Vorschläge (6M) generieren.",
        kiStep4: "Vorschläge ins Ishikawa übernehmen.",
        kiStep5: "Ursachen bewerten (Rot/Gelb/Grün).",
        kiStep6: "Ursachen ergänzen, verändern oder löschen; bei Bedarf erneut generieren.",
        kiStep7: "Danach wie ohne KI weiterarbeiten: Maßnahmen ableiten, Export/Print.",

        step1: "Effekt / Problem rechts im Kopf eintragen.",
        step2: "Pro 6M-Kategorie Ursachen hinzufügen.",
        step3: "Ursachen unten bewerten: Rot=wahrscheinliche Ursache, Gelb=schnell prüfbar, Grün=aktuell ausgeschlossen.",
        step4: "Aus Rot/Gelb Maßnahmen ableiten (mit Termin) → Maßnahmenliste.",
        step5: "Print oder JSON speichern/laden.",
        boxPrivacyTitle: "Datenschutz",
        privacyNoApiTitle: "Datenschutz (ohne API/KI)",
        privacyNoApiText: "Dieses Tool arbeitet vollständig in deinem Browser. Inhalte werden nicht automatisch an unsere Server übertragen. Der aktuelle Stand kann lokal im Browser gespeichert werden (Autosave) und zusätzlich als JSON exportiert/importiert werden.",
        privacyApiTitle: "Datenschutz (mit API/KI – Premium)",
        privacyApiText: "Wenn du den KI-Assistenten nutzt, werden nur die von dir zur Anfrage ausgewählten Inhalte direkt aus deinem Browser an die OpenAI API übertragen, um Vorschläge zu generieren (z. B. Problemtext, Kontext sowie ausgewählte Ursachen/Maßnahmen). Der API-Key wird dabei nicht serverseitig gespeichert. Die Premium-Funktion ist ausschließlich für berechtigte Kunden der Quality Services & Wissen GmbH vorgesehen; der Lizenzschlüssel dient als Freischaltung. Bitte übermittle keine personenbezogenen Daten oder vertraulichen Inhalte, die nicht in externe Systeme gehören.",
        boxPrivacyText: "Dieses Tool arbeitet vollständig im Browser. Es werden keine Inhalte (Problembeschreibung, Ursachen, Maßnahmen) auf einem Server von Quality Services & Wissen GmbH gespeichert. Der aktuelle Stand wird lokal im Browser gespeichert (Autosave) und kann zusätzlich als JSON exportiert/importiert werden. Premium/KI-Funktion (für Kunden): Wenn du den KI-Assistenten nutzt, werden die von dir eingegebenen Inhalte (z. B. Problemtext, ausgewählte Ursachen/Maßnahmen und deine Anfrage) direkt aus deinem Browser an den von dir konfigurierten OpenAI‑API‑Endpunkt übertragen, um eine Antwort zu generieren. Der API‑Schlüssel wird nur in deinem Browser verwendet; wir speichern ihn nicht serverseitig. Bitte gib keine sensiblen personenbezogenen Daten oder vertrauliche Informationen ein, die nicht übertragen werden sollen. Die Verarbeitung bei OpenAI erfolgt gemäß deren Datenschutzbestimmungen und Nutzungsbedingungen. Der Lizenzschlüssel dient ausschließlich der Freischaltung für berechtigte Kunden und wird nicht an Dritte übermittelt.",

        catMensch:"Mensch", catMaschine:"Maschine", catMaterial:"Material", catMethode:"Methode", catMitwelt:"Mitwelt", catMessung:"Messung",
        addCause:"+ Ursache",
        problemPlaceholder:"HAUPTPROBLEM / EFFEKT HIER EINTRAGEN...",
        causePlaceholder:"Ursache eingeben...",
        deleteCause:"Ursache löschen",

        triageTitle:"Ursachen bewerten (Rot / Gelb / Grün)",
        triageSub:"Bewerte jede Ursache: Rot = sehr wahrscheinlich, Gelb = schnell prüfbar, Grün = momentan ausgeschlossen. Bewertungen können sich ändern.",
        triageListTitle:"Ursachenliste",
        filterAll:"Alle",
        filterRed:"Rot",
        filterYellow:"Gelb",
        filterGreen:"Grün",
        filterRY:"Rot+Gelb",
        thCategory:"Kategorie",
        thCause:"Ursache",
        thTriage:"Bewertung",
        thActions:"Aktion",
        rateRed:"Rot",
        rateYellow:"Gelb",
        rateGreen:"Grün",
        takeAsMeasure:"Als Maßnahme übernehmen",

        measuresTitle:"Ableitung von Maßnahmen",
        measuresSub:"Aus roten und gelben Ursachen werden Maßnahmen abgeleitet. Jede Maßnahme bleibt mit der Ursache verknüpft.",
        draftCauseRefLabel:"Bezug (Ursache)",
        draftCauseHint:"Wähle eine Ursache in der Ursachenliste (Aktion: „Als Maßnahme übernehmen“).",
        draftOwnerLabel:"Owner (Bereich)",
        draftOwnerPh:"z.B. Qualität / Produktion",
        draftDueLabel:"Termin",
        draftTypeLabel:"Maßnahmenart",
        typeAvoid:"Fehlervermeidung",
        typeValidate:"Validierung / Wirksamkeitsnachweis",
        typeSecure:"Absicherungsmaßnahmen",
        typeLessons:"Lessons Learned",
        draftRespLabel:"Verantwortung",
        draftRespPh:"z.B. Max Mustermann / Rolle",
        draftEvidenceLabel:"Nachweis / Wirksamkeit",
        draftEvidencePh:"Dummy-Prüfung, Versuche, Kurzzeitfähigkeit, Kennzahlen, Audit, etc.",
        draftMeasureLabel:"Maßnahme",
        draftMeasurePh:"Welche Maßnahme reduziert/prüft diese Ursache?",
        btnSaveDraft:"In Maßnahmenliste speichern",
        btnClearDraft:"Eingabe leeren",
        btnSeedFromRY:"Rote/Gelbe als Vorschläge anlegen",
        draftHint:"Tipp: „Rote/Gelbe als Vorschläge“ erstellt pro Rot/Gelb-Ursache (falls noch nicht vorhanden) einen Maßnahmen-Entwurf in der Liste (Status: Offen).",

        listTitle:"Maßnahmenliste",
        mFilterOpen:"Offen",
        mFilterDone:"Abgeschlossen",
        mFilterDrop:"Verworfen",
        thRef:"Bezug (Ursache)",
        thMeasure:"Maßnahme",
        thEvidence:"Nachweis / Wirksamkeit",
        thOwner:"Owner / Verantwortung",
        thType:"Art",
        thDue:"Termin",
        thStatus:"Status",
        statusOpen:"Offen",
        statusDone:"Abgeschlossen",
        statusDrop:"Verworfen",
        btnOpen:"Offen",
        btnDone:"Abschließen",
        btnDrop:"Verwerfen",
        btnEdit:"Bearbeiten",
        btnSaveRow:"Speichern",
        btnDelete:"Löschen",
        cancel:"Abbrechen",

        btnPrint:"Drucken",
        btnExportPng:"PNG Export",
        btnExportSvg:"SVG Export",
        btnSaveJson:"JSON Speichern",
        btnLoadJson:"JSON Laden",
        btnReset:"Reset",
        confirmReset:"Alles löschen (inkl. Autosave)?",
        pngName:"Quality_Ishikawa.png",
        svgName:"Quality_Ishikawa.svg",
        jsonName:"Ishikawa_Export.json",
        loadError:"Fehler beim Laden der Datei.",

        aiTitle:"KI Assistent",
        aiSub:"NLP-gestützte Unterstützung: Der Assistent strukturiert aus Fehlerbild + Kontext mögliche 6M-Ursachen und passende Maßnahmen-Typen (inkl. Nachweis/Wirksamkeit). Hinweis: Diese Funktion steht nur Kunden der Quality Services & Wissen GmbH zur Verfügung.",
        aiInputTitle:"Eingabe",
        aiTakeProblem:"Fehlerbild übernehmen",
        aiApiKeyLabel:"OpenAI API Key",
        aiLicenseLabel:"License key",
        aiLicensePh:"••••",
        aiLicenseHint:"Customers of Quality Services & Wissen receive a license key.",
        aiNeedLicense:"Please enter the license key.",
        aiBadLicense:"License key is invalid.",
        aiLicenseLabel:"Lizenzschlüssel",
        aiLicensePh:"••••",
        aiLicenseHint:"Kunden von Quality Services & Wissen erhalten einen Lizenzschlüssel.",
        aiNeedLicense:"Bitte Lizenzschlüssel eingeben.",
        aiBadLicense:"Lizenzschlüssel ist ungültig.",
        aiRemember:"Key lokal speichern",
        aiPrivacyHint:"Hinweis: Client-seitige Keys sind praktisch, aber nicht ideal für öffentliche Seiten. Für Produktion ist ein Server-Proxy sicherer.",
        aiProblemLabel:"Fehlerbild (kurz)",
        aiContextLabel:"Kontext (Details)",
        aiContextFromTool:"Kontext aus Tool",
        aiContextHint:"Tipp: Prozess, Maschine/Anlage, Material, Messmittel, Schicht, Umgebungsbedingungen, Änderungen, Häufigkeit.",
        aiGenerate:"Ursachen generieren",
        aiApply:"Ins Tool übernehmen",
        aiDownload:"JSON Download",
        aiPng:"Als Bild (PNG)",
        aiClear:"Zurücksetzen",
        aiPreviewTitle:"Vorschau (JSON)",
        aiPreviewHint:"Schema kompatibel mit JSON Speichern/Laden (lang/problem/matrix/measures/draft/ts).",
        aiConfirmApply:"Aktuelle Inhalte (Ursachen & Maßnahmen) werden überschrieben. Fortfahren?",
        aiNeedKey:"Bitte API-Key eingeben.",
        aiNeedProblem:"Bitte ein Fehlerbild eingeben.",
        aiSending:"Sende Prompt an OpenAI ...",
        aiDone:"Fertig. Du kannst den Entwurf übernehmen oder als JSON herunterladen.",
        aiParseError:"Konnte kein JSON aus der Antwort parsen.",
        aiPngHint:"Hinweis: Das PNG kommt aus dem aktuellen Diagramm (oben).",

        moreTitle:"Weiterführende Infos",
        moreSub:"Lexikonartikel & passende Weiterbildungen (öffnet in neuem Tab).",
        embedTitle:"Einbindung des Tools in Ihre Umgebung",
        embedText:"Das Tool kann per iframe in bestehende Web-Umgebungen integriert werden (z. B. Website, Intranet oder internes Wiki). Dabei wird stets die aktuelle Version von tools.quality.de geladen (automatische Updates).",
        embedCopy:"Code kopieren",
        embedCopied:"Code kopiert.",
        embedCopyFail:"Kopieren nicht möglich – bitte manuell markieren.",
        lexTitle:"Lexikon",
        lexText:"Hintergrund, Nutzen & Anwendung des Ishikawa-Diagramms.",
        lexLink:"Zum Lexikonartikel: Ishikawa",
        trainTitle:"Ausbildungen & Seminare",
        trainText:"Vertiefe deine Methodenkompetenz im Qualitätsmanagement:",
        trainKvp:"KVP Seminare",
        train8d:"8D Schulungen",
        trainQm:"Qualitätsmanagement",
      },

      en: {
        title: "Ishikawa Tool (6M) – Root Cause Analysis",
        subtitle: "Systematic fishbone analysis – including cause triage (Red/Yellow/Green) and action derivation with a clear link to each cause.",
        backHome: "Back to home",

        boxToolNameTitle: "Tool name",
        boxToolNameText: "Ishikawa (Fishbone) Diagram – 6M",
        boxGoalTitle: "Goal",
        boxGoalText: "Collect causes, triage them (Red/Yellow/Green), and derive actions from the relevant causes (Red/Yellow).",
        boxHowTitle: "How to use this tool",
        step1: "Enter the effect / problem in the head on the right.",
        step2: "Add causes for each 6M category.",
        step3: "Triage causes below: Red=very likely, Yellow=quick to check, Green=excluded for now.",
        step4: "Derive actions from Red/Yellow (with due date) → action list.",
        step5: "Print or save/load JSON.",
        boxPrivacyTitle: "Privacy",
        boxPrivacyText: "This tool runs entirely in your browser. No content (problem description, causes, actions) is stored on any Quality Services & Wissen GmbH server. The current state is saved locally in your browser (autosave) and can also be exported/imported as JSON. Premium/AI feature (for customers): If you use the AI assistant, the content you submit (e.g., problem text, selected causes/actions, and your request) is sent directly from your browser to your configured OpenAI API endpoint to generate a response. Your API key is used only in your browser; we do not store it server-side. Please avoid entering sensitive personal data or confidential information you do not want to transmit. Processing at OpenAI is governed by their privacy policy and terms. The license key is only used to unlock the feature for eligible customers and is not shared with third parties.",

        catMensch:"People", catMaschine:"Machine", catMaterial:"Material", catMethode:"Method", catMitwelt:"Environment", catMessung:"Measurement",
        addCause:"+ Cause",
        problemPlaceholder:"ENTER MAIN PROBLEM / EFFECT HERE...",
        causePlaceholder:"Enter cause...",
        deleteCause:"Delete cause",

        triageTitle:"Triage causes (Red / Yellow / Green)",
        triageSub:"Triage every cause: Red = very likely, Yellow = quick to check, Green = excluded for now. Ratings can change.",
        triageListTitle:"Cause list",
        filterAll:"All",
        filterRed:"Red",
        filterYellow:"Yellow",
        filterGreen:"Green",
        filterRY:"Red+Yellow",
        thCategory:"Category",
        thCause:"Cause",
        thTriage:"Triage",
        thActions:"Action",
        rateRed:"Red",
        rateYellow:"Yellow",
        rateGreen:"Green",
        takeAsMeasure:"Use as action",

        measuresTitle:"Action derivation",
        measuresSub:"Actions are derived from red and yellow causes. Each action stays linked to its cause.",
        draftCauseRefLabel:"Reference (cause)",
        draftCauseHint:"Select a cause in the cause list (Action: “Use as action”).",
        draftOwnerLabel:"Owner (area)",
        draftOwnerPh:"e.g., Quality / Production",
        draftDueLabel:"Due date",
        draftTypeLabel:"Action type",
        typeAvoid:"Cause elimination",
        typeValidate:"Validation / effectiveness evidence",
        typeSecure:"Sustain / control measures",
        typeLessons:"Lessons learned",
        draftRespLabel:"Responsible",
        draftRespPh:"e.g., Name / role",
        draftEvidenceLabel:"Evidence / effectiveness",
        draftEvidencePh:"Trial runs, checks, capability, KPIs, audit, etc.",
        draftMeasureLabel:"Action",
        draftMeasurePh:"Which action reduces/checks this cause?",
        btnSaveDraft:"Save to action list",
        btnClearDraft:"Clear draft",
        btnSeedFromRY:"Create suggestions from Red/Yellow",
        draftHint:"Tip: “Create suggestions” creates one open action per Red/Yellow cause (if none exists yet).",

        listTitle:"Action list",
        mFilterOpen:"Open",
        mFilterDone:"Done",
        mFilterDrop:"Discarded",
        thRef:"Reference (cause)",
        thMeasure:"Action",
        thEvidence:"Evidence / Effectiveness",
        thOwner:"Owner / Responsible",
        thType:"Type",
        thDue:"Due",
        thStatus:"Status",
        statusOpen:"Open",
        statusDone:"Done",
        statusDrop:"Discarded",
        btnOpen:"Open",
        btnDone:"Mark done",
        btnDrop:"Discard",
        btnEdit:"Edit",
        btnSaveRow:"Save",
        btnDelete:"Delete",
        cancel:"Cancel",

        btnPrint:"Print",
        btnExportPng:"PNG export",
        btnExportSvg:"SVG export",
        btnSaveJson:"Save JSON",
        btnLoadJson:"Load JSON",
        btnReset:"Reset",
        confirmReset:"Delete everything (including autosave)?",
        pngName:"Quality_Ishikawa.png",
        svgName:"Quality_Ishikawa.svg",
        jsonName:"Ishikawa_Export.json",
        loadError:"Error loading the file.",

        aiTitle:"AI Assistant",
        aiSub:"NLP-assisted support: turn problem + context into a structured 6M cause set and action types (incl. evidence/effectiveness). Note: available only to customers of Quality Services & Wissen GmbH.",
        aiInputTitle:"Input",
        aiTakeProblem:"Use tool problem",
        aiApiKeyLabel:"OpenAI API Key",
        aiRemember:"Remember key locally",
        aiPrivacyHint:"Note: Client-side keys are convenient but not ideal for public pages. For production, use a server proxy.",
        aiProblemLabel:"Problem (short)",
        aiContextLabel:"Context (details)",
        aiContextFromTool:"Use tool context",
        aiContextHint:"Tip: process step, machine, material, gage, shift, environment, changes, frequency.",
        aiGenerate:"Generate causes",
        aiApply:"Apply to tool",
        aiDownload:"Download JSON",
        aiPng:"As image (PNG)",
        aiClear:"Reset",
        aiPreviewTitle:"Preview (JSON)",
        aiPreviewHint:"Schema compatible with Save/Load JSON (lang/problem/matrix/measures/draft/ts).",
        aiConfirmApply:"This will overwrite the current content (causes & actions). Continue?",
        aiNeedKey:"Please enter an API key.",
        aiNeedProblem:"Please enter a problem.",
        aiSending:"Sending prompt to OpenAI ...",
        aiDone:"Done. You can apply the draft or download it as JSON.",
        aiParseError:"Could not parse JSON from the response.",
        aiPngHint:"Note: The PNG is created from the current diagram (above).",

        moreTitle:"More information",
        moreSub:"Glossary article & relevant training (opens in a new tab).",
        embedTitle:"Embed this tool via iframe",
        embedText:"You can embed the tool professionally via an iframe on your website—even if it is publicly accessible. The iframe always loads the latest version from tools.quality.de (including automatic updates).",
        embedCopy:"Copy code",
        embedCopied:"Code copied.",
        embedCopyFail:"Copy failed – please select manually.",
        lexTitle:"Glossary",
        lexText:"Background, benefits & how to use the Ishikawa diagram.",
        lexLink:"Open glossary article: Ishikawa",
        trainTitle:"Training & courses",
        trainText:"Deepen your method skills in quality management:",
        trainKvp:"CIP / KVP training",
        train8d:"8D training",
        trainQm:"Quality management",
      }
    };

    let currentLang = (localStorage.getItem(LANG_KEY)
      || ((navigator.language||"").toLowerCase().startsWith("de") ? "de" : "en"));

    function t(key){
      const d = I18N[currentLang] || I18N.de;
      return (key in d) ? d[key] : key;
    }

    function applyI18n(){
      document.documentElement.lang = currentLang;

      $$("[data-i18n]").forEach(el => el.textContent = t(el.dataset.i18n));
      $$("[data-i18n-placeholder]").forEach(el => el.placeholder = t(el.dataset.i18nPlaceholder));

      // lang buttons active
      const deBtn = $("#btnLangDE"), enBtn = $("#btnLangEN");
      if(deBtn && enBtn){
        deBtn.classList.toggle("primary", currentLang==="de");
        enBtn.classList.toggle("primary", currentLang==="en");
      }

      // placeholders for existing notes
      $$(".note-item textarea").forEach(ta => {
        if(ta.dataset.i18nPlaceholder) ta.placeholder = t(ta.dataset.i18nPlaceholder);
      });
      $$(".note-delete").forEach(btn => {
        if(btn.dataset.i18nTitle) btn.title = t(btn.dataset.i18nTitle);
        if(btn.dataset.i18nAria) btn.setAttribute("aria-label", t(btn.dataset.i18nAria));
      });

      updateTriageMeta();
      updateMeasuresMeta();
      renderTriageTable();
      renderMeasures();
    }

    function setLanguage(lang){
      currentLang = (lang==="de"||lang==="en") ? lang : "de";
      localStorage.setItem(LANG_KEY, currentLang);
      applyI18n();
      persist();
    }

    // ---------- state ----------
    function uid(){
      try{ return crypto.randomUUID(); }catch{ return "id_" + Math.random().toString(16).slice(2); }
    }

    const EMPTY = () => ({
      lang: currentLang,
      problem: "",
      matrix: Object.fromEntries(CATS.map(c => [c, []])),
      // measures: {id, causeId, causeSnapshot, cat, triageAtCreate, type, text, evidence, owner, responsible, due, status, ts}
      measures: [],
      draft: { causeId: null, causeSnapshot:"", cat:"", triage:"", type:"avoid", text:"", evidence:"", owner:"", responsible:"", due:"" },
      ts: new Date().toISOString()
    });

    let state = EMPTY();
    let triageFilter = "all";     // all | red | yellow | green | ry
    let measuresFilter = "all";   // all | open | done | drop
    let editMeasureId = null;

    // ---------- persist ----------
    function persist(){
      state.lang = currentLang;
      state.problem = $("#problemInput").value || "";
      state.ts = new Date().toISOString();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    function restore(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return false;
      try{
        const p = JSON.parse(raw);
        if(!p || typeof p !== "object") return false;

        state = EMPTY();
        state.lang = (p.lang==="de"||p.lang==="en") ? p.lang : currentLang;
        state.problem = String(p.problem ?? "");
        $("#problemInput").value = state.problem;

        const m = p.matrix || {};
        CATS.forEach(cat=>{
          const arr = Array.isArray(m[cat]) ? m[cat] : [];
          state.matrix[cat] = arr.map(x=>({
            id: String(x.id || uid()),
            text: String(x.text || ""),
            triage: (x.triage==="red"||x.triage==="yellow"||x.triage==="green") ? x.triage : "yellow"
          }));
        });

        const meas = Array.isArray(p.measures) ? p.measures : [];
        state.measures = meas.map(x=>({
          id: String(x.id || uid()),
          causeId: x.causeId ? String(x.causeId) : null,
          causeSnapshot: String(x.causeSnapshot || ""),
          cat: String(x.cat || ""),
          triageAtCreate: (x.triageAtCreate==="red"||x.triageAtCreate==="yellow"||x.triageAtCreate==="green") ? x.triageAtCreate : "",
          type: (x.type in {"avoid":1,"validate":1,"secure":1,"lessons":1}) ? x.type : "avoid",
          text: String(x.text || ""),
          evidence: String(x.evidence || ""),
          owner: String(x.owner || ""),
          responsible: String(x.responsible || ""),
          due: String(x.due || ""),
          status: (x.status==="open"||x.status==="done"||x.status==="drop") ? x.status : "open",
          ts: String(x.ts || new Date().toISOString())
        }));

        const d = p.draft || {};
        state.draft = {
          causeId: d.causeId ? String(d.causeId) : null,
          causeSnapshot: String(d.causeSnapshot || ""),
          cat: String(d.cat || ""),
          triage: String(d.triage || ""),
          type: (d.type in {"avoid":1,"validate":1,"secure":1,"lessons":1}) ? d.type : "avoid",
          text: String(d.text || ""),
          evidence: String(d.evidence || ""),
          owner: String(d.owner || ""),
          responsible: String(d.responsible || ""),
          due: String(d.due || ""),
        };

        state.ts = String(p.ts || new Date().toISOString());
        return true;
      }catch(e){
        return false;
      }
    }

    // ---------- helpers ----------
    function esc(s){
      return String(s ?? "")
        .replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }

    function catLabel(cat){
      const map = {
        Mensch: t("catMensch"),
        Maschine: t("catMaschine"),
        Material: t("catMaterial"),
        Methode: t("catMethode"),
        Mitwelt: t("catMitwelt"),
        Messung: t("catMessung"),
      };
      return map[cat] || cat;
    }

    function triageLabel(k){
      if(k==="red") return t("rateRed");
      if(k==="yellow") return t("rateYellow");
      if(k==="green") return t("rateGreen");
      return "—";
    }

    function triageDotClass(k){
      if(k==="red") return "red";
      if(k==="yellow") return "yellow";
      if(k==="green") return "green";
      return "";
    }


    function measureTypeLabel(type){
      if(type==="validate") return t("typeValidate");
      if(type==="secure") return t("typeSecure");
      if(type==="lessons") return t("typeLessons");
      return t("typeAvoid");
    }

    function measureTypePill(type){
      const cls = (type==="validate") ? "validate" : (type==="secure") ? "secure" : (type==="lessons") ? "lessons" : "avoid";
      return `<span class="type-pill ${cls}">${esc(measureTypeLabel(type))}</span>`;
    }

    function statusPill(status){
      if(status==="done") return `<span class="status-pill status-done">${esc(t("statusDone"))}</span>`;
      if(status==="drop") return `<span class="status-pill status-drop">${esc(t("statusDrop"))}</span>`;
      return `<span class="status-pill status-open">${esc(t("statusOpen"))}</span>`;
    }

    function findCauseById(id){
      if(!id) return null;
      for(const cat of CATS){
        const c = state.matrix[cat].find(x=>x.id===id);
        if(c) return {cat, ...c};
      }
      return null;
    }

    function refTextFor(measure){
      const c = measure.causeId ? findCauseById(measure.causeId) : null;
      const cat = c ? c.cat : (measure.cat || "");
      const text = c ? c.text : (measure.causeSnapshot || "");
      const label = cat ? catLabel(cat) : "—";
      return `${label}: ${text || "—"}`;
    }

    function allCausesFlat(){
      const out = [];
      CATS.forEach(cat=>{
        state.matrix[cat].forEach(c=>{
          out.push({cat, ...c});
        });
      });
      return out;
    }

    // ---------- notes UI ----------
    function addNote(cat, val = "", triage = "yellow"){
      if(!state.matrix[cat]) state.matrix[cat] = [];
      const item = { id: uid(), text: String(val || ""), triage: triage };
      state.matrix[cat].push(item);
      renderCat(cat);
      persist();
    }

    function renderCat(cat){
      const container = document.getElementById(`notes-${cat}`);
      if(!container) return;
      container.innerHTML = "";

      state.matrix[cat].forEach(item=>{
        const div = document.createElement("div");
        div.className = "note-item";
        div.innerHTML = `
          <span class="rate-dot ${triageDotClass(item.triage)}" aria-hidden="true"></span>
          <button type="button" class="note-delete" data-i18nTitle="deleteCause" data-i18nAria="deleteCause" title="${esc(t("deleteCause"))}" aria-label="${esc(t("deleteCause"))}">&times;</button>
          <textarea rows="2" data-i18n-placeholder="causePlaceholder" placeholder="${esc(t("causePlaceholder"))}"></textarea>
        `;

        const ta = div.querySelector("textarea");
        const del = div.querySelector(".note-delete");

        ta.value = item.text || "";
        ta.addEventListener("input", ()=>{
          item.text = ta.value;
          persist();
          renderTriageTable();
          renderMeasures();
        });

        del.addEventListener("click", ()=>{
          // remove linked measures? keep measures with snapshot, but detach id if cause deleted
          state.measures.forEach(m=>{
            if(m.causeId === item.id){
              m.causeId = null;
              m.causeSnapshot = item.text || m.causeSnapshot;
              m.cat = cat;
              m.triageAtCreate = item.triage || m.triageAtCreate;
            }
          });

          state.matrix[cat] = state.matrix[cat].filter(x=>x.id !== item.id);
          renderCat(cat);
          persist();
          renderTriageTable();
          renderMeasures();
        });

        container.appendChild(div);
      });

      updateTriageMeta();
    }

    // ---------- triage ----------
    function updateTriageMeta(){
      const causes = allCausesFlat();
      const n = causes.length;
      const r = causes.filter(c=>c.triage==="red").length;
      const y = causes.filter(c=>c.triage==="yellow").length;
      const g = causes.filter(c=>c.triage==="green").length;

      const el = $("#triageMeta");
      if(!el) return;
      el.textContent = (currentLang==="de")
        ? `Gesamt: ${n} · Rot: ${r} · Gelb: ${y} · Grün: ${g}`
        : `Total: ${n} · Red: ${r} · Yellow: ${y} · Green: ${g}`;
    }

    function triageFilterFn(c){
      if(triageFilter==="all") return true;
      if(triageFilter==="ry") return (c.triage==="red" || c.triage==="yellow");
      return c.triage === triageFilter;
    }

    function renderTriageTable(){
      const tbody = $("#triageTbody");
      if(!tbody) return;
      tbody.innerHTML = "";

      const causes = allCausesFlat().filter(triageFilterFn);

      if(causes.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="4" class="muted">${currentLang==="de" ? "Keine Ursachen im aktuellen Filter." : "No causes in the current filter."}</td>`;
        tbody.appendChild(tr);
        return;
      }

      causes.forEach(c=>{
        const tr = document.createElement("tr");

        const canAction = (c.triage==="red" || c.triage==="yellow");

        tr.innerHTML = `
          <td><strong>${esc(catLabel(c.cat))}</strong></td>
          <td>${esc(c.text || "—")}</td>
          <td>
            <div class="rate-chips" role="group" aria-label="Triage">
              <span class="rate red ${c.triage==="red" ? "selected":""}" data-rate="red" data-id="${esc(c.id)}"><span class="dot"></span>${esc(t("rateRed"))}</span>
              <span class="rate yellow ${c.triage==="yellow" ? "selected":""}" data-rate="yellow" data-id="${esc(c.id)}"><span class="dot"></span>${esc(t("rateYellow"))}</span>
              <span class="rate green ${c.triage==="green" ? "selected":""}" data-rate="green" data-id="${esc(c.id)}"><span class="dot"></span>${esc(t("rateGreen"))}</span>
            </div>
          </td>
          <td style="text-align:right;">
            <button type="button" class="mini-btn" data-act="take" data-id="${esc(c.id)}" ${canAction ? "" : "disabled"}>${esc(t("takeAsMeasure"))}</button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      // wire triage buttons
      tbody.querySelectorAll("[data-rate]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          const rate = btn.getAttribute("data-rate");
          const c = findCauseById(id);
          if(!c) return;

          // update triage
          const item = state.matrix[c.cat].find(x=>x.id===id);
          if(item){
            item.triage = rate;
            // update dot in diagram by rerendering the category
            renderCat(c.cat);
          }
          persist();
          updateTriageMeta();
          renderTriageTable();
        });
      });

      // wire "take as measure"
      tbody.querySelectorAll('[data-act="take"]').forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-id");
          const c = findCauseById(id);
          if(!c) return;

          if(!(c.triage==="red" || c.triage==="yellow")){
            return;
          }

          // fill draft with cause reference
          state.draft.causeId = c.id;
          state.draft.causeSnapshot = c.text || "";
          state.draft.cat = c.cat;
          state.draft.triage = c.triage;
          state.draft.text = state.draft.text || (currentLang==="de"
            ? `Maßnahme zu: ${c.text}`
            : `Action for: ${c.text}`);
          syncDraftInputs();
          persist();
          $("#draftMeasure").focus();
        });
      });

    }

    // ---------- measures ----------
    function updateMeasuresMeta(){
      const total = state.measures.length;
      const open = state.measures.filter(m=>m.status==="open").length;
      const done = state.measures.filter(m=>m.status==="done").length;
      const drop = state.measures.filter(m=>m.status==="drop").length;

      const el = $("#measuresMeta");
      if(!el) return;
      el.textContent = (currentLang==="de")
        ? `Gesamt: ${total} · Offen: ${open} · Abgeschlossen: ${done} · Verworfen: ${drop}`
        : `Total: ${total} · Open: ${open} · Done: ${done} · Discarded: ${drop}`;
    }

    function measuresFilterFn(m){
      if(measuresFilter==="all") return true;
      return m.status === measuresFilter;
    }

    
    function syncDraftInputs(){
      const ref = $("#draftCauseRef");
      const cause = state.draft.causeId ? findCauseById(state.draft.causeId) : null;
      if(cause){
        ref.value = `${catLabel(cause.cat)}: ${cause.text || "—"} (${triageLabel(cause.triage)})`;
      }else if(state.draft.causeSnapshot){
        ref.value = `${catLabel(state.draft.cat || "")} : ${state.draft.causeSnapshot || "—"} (${triageLabel(state.draft.triage)})`;
        ref.value = ref.value.replace(/\s+:\s+/, ": ");
      }else{
        ref.value = "—";
      }

      $("#draftType").value = state.draft.type || "avoid";
      $("#draftMeasure").value = state.draft.text || "";
      $("#draftEvidence").value = state.draft.evidence || "";
      $("#draftOwner").value = state.draft.owner || "";
      $("#draftResp").value = state.draft.responsible || "";
      $("#draftDue").value = state.draft.due || "";
    }

    function saveDraftToMeasures(){
      const type = ($("#draftType").value || "avoid").trim();
      const text = ($("#draftMeasure").value || "").trim();
      const evidence = ($("#draftEvidence").value || "").trim();
      const owner = ($("#draftOwner").value || "").trim();
      const responsible = ($("#draftResp").value || "").trim();
      const due = ($("#draftDue").value || "").trim();

      if(!state.draft.causeId && !state.draft.causeSnapshot){
        alert(currentLang==="de"
          ? "Bitte zuerst eine Ursache auswählen (Als Maßnahme übernehmen)."
          : "Please select a cause first (Use as action).");
        return;
      }
      if(!text){
        alert(currentLang==="de" ? "Bitte eine Maßnahme formulieren." : "Please enter an action.");
        $("#draftMeasure").focus();
        return;
      }

      // for type=validate, encourage evidence
      if(type==="validate" && !evidence){
        const ok = confirm(currentLang==="de"
          ? "Für Validierung sollte ein Nachweis/Wirkungsnachweis ergänzt werden. Trotzdem speichern?"
          : "For validation actions, evidence is recommended. Save anyway?");
        if(!ok) return;
      }

      const cause = state.draft.causeId ? findCauseById(state.draft.causeId) : null;

      state.measures.push({
        id: uid(),
        causeId: cause ? cause.id : null,
        causeSnapshot: cause ? (cause.text||"") : (state.draft.causeSnapshot||""),
        cat: cause ? cause.cat : (state.draft.cat||""),
        triageAtCreate: cause ? cause.triage : (state.draft.triage||""),
        type: (type==="avoid"||type==="validate"||type==="secure"||type==="lessons") ? type : "avoid",
        text,
        evidence,
        owner,
        responsible,
        due,
        status: "open",
        ts: new Date().toISOString()
      });

      // clear draft for next action
      state.draft = { causeId:null, causeSnapshot:"", cat:"", triage:"", type:"avoid", text:"", evidence:"", owner:"", responsible:"", due:"" };
      syncDraftInputs();
      persist();
      renderMeasures();
      $("#draftMeasure").focus();
    }

    function clearDraft(){
      state.draft = { causeId:null, causeSnapshot:"", cat:"", triage:"", type:"avoid", text:"", evidence:"", owner:"", responsible:"", due:"" };
      syncDraftInputs();
      persist();
    }

    
    function seedFromRedYellow(){
      // For each red/yellow cause: create an "open" measure if none exists yet for that causeId
      const causes = allCausesFlat().filter(c => c.triage==="red" || c.triage==="yellow");
      let created = 0;

      causes.forEach(c=>{
        const exists = state.measures.some(m => m.causeId === c.id);
        if(exists) return;
        state.measures.push({
          id: uid(),
          causeId: c.id,
          causeSnapshot: c.text || "",
          cat: c.cat,
          triageAtCreate: c.triage,
          type: "avoid",
          text: (currentLang==="de" ? `Maßnahme zu: ${c.text}` : `Action for: ${c.text}`),
          evidence: "",
          owner: "",
          responsible: "",
          due: "",
          status: "open",
          ts: new Date().toISOString()
        });
        created++;
      });

      persist();
      renderMeasures();

      if(created === 0){
        alert(currentLang==="de"
          ? "Keine neuen Vorschläge: Für alle Rot/Gelb-Ursachen existiert bereits mindestens eine Maßnahme."
          : "No new suggestions: each Red/Yellow cause already has at least one action.");
      }
    }

        function renderMeasures(){
      updateMeasuresMeta();

      const tbody = $("#measuresTbody");
      tbody.innerHTML = "";

      const list = state.measures
        .filter(measuresFilterFn)
        .slice()
        .sort((a,b)=>{
          const da = a.due || "9999-12-31";
          const db = b.due || "9999-12-31";
          if(da < db) return -1;
          if(da > db) return 1;
          return String(a.ts).localeCompare(String(b.ts));
        });

      if(list.length === 0){
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="8" class="muted">${currentLang==="de" ? "Keine Maßnahmen im aktuellen Filter." : "No actions in the current filter."}</td>`;
        tbody.appendChild(tr);
        return;
      }

      list.forEach(m=>{
        const isEdit = (editMeasureId === m.id);
        const ref = refTextFor(m);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${esc(ref)}</td>
          <td>
            ${isEdit
              ? `<select data-edit="type" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px; font-size:14px; font-family:inherit; outline:none; background:#fff;">
                   <option value="avoid" ${m.type==="avoid"?"selected":""}>${esc(t("typeAvoid"))}</option>
                   <option value="validate" ${m.type==="validate"?"selected":""}>${esc(t("typeValidate"))}</option>
                   <option value="secure" ${m.type==="secure"?"selected":""}>${esc(t("typeSecure"))}</option>
                   <option value="lessons" ${m.type==="lessons"?"selected":""}>${esc(t("typeLessons"))}</option>
                 </select>`
              : `${measureTypePill(m.type || "avoid")}`
            }
          </td>
          <td>
            ${isEdit
              ? `<div class="field" style="margin:0;">
                   <textarea data-edit="text" style="min-height:74px;">${esc(m.text)}</textarea>
                 </div>`
              : `<div style="font-weight:900; color:#0f172a;">${esc(m.text || "—")}</div>`
            }
          </td>
          <td>
            ${isEdit
              ? `<div class="field" style="margin:0;">
                   <textarea data-edit="evidence" style="min-height:74px;">${esc(m.evidence || "")}</textarea>
                 </div>`
              : (m.evidence ? `<div class="subline">${esc(m.evidence)}</div>` : `<span class="muted">—</span>`)
            }
          </td>
          <td>
            ${isEdit
              ? `<div style="display:flex; flex-direction:column; gap:8px;">
                   <input data-edit="owner" type="text" value="${esc(m.owner)}" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px; font-size:14px; font-family:inherit; outline:none;" />
                   <input data-edit="responsible" type="text" value="${esc(m.responsible || "")}" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px; font-size:14px; font-family:inherit; outline:none;" />
                 </div>`
              : `<div><span class="muted">${esc(m.owner || "—")}</span></div>
                 ${m.responsible ? `<div class="subline">${esc(m.responsible)}</div>` : ``}`
            }
          </td>
          <td>
            ${isEdit
              ? `<input data-edit="due" type="date" value="${esc(m.due)}" style="width:100%; padding:10px 12px; border:1px solid rgba(15,23,42,.14); border-radius:6px; font-size:14px; font-family:inherit; outline:none;" />`
              : `${esc(m.due || "—")}`
            }
          </td>
          <td>${statusPill(m.status)}</td>
          <td style="text-align:right;">
            <div class="row-actions">
              ${isEdit
                ? `<button type="button" class="mini-btn" data-act="save" data-id="${esc(m.id)}">${esc(t("btnSaveRow"))}</button>
                   <button type="button" class="mini-btn" data-act="cancel" data-id="${esc(m.id)}">${esc(t("cancel"))}</button>`
                : `<button type="button" class="mini-btn" data-act="edit" data-id="${esc(m.id)}">${esc(t("btnEdit"))}</button>
                   <button type="button" class="mini-btn" data-act="open" data-id="${esc(m.id)}">${esc(t("btnOpen"))}</button>
                   <button type="button" class="mini-btn" data-act="done" data-id="${esc(m.id)}">${esc(t("btnDone"))}</button>
                   <button type="button" class="mini-btn" data-act="drop" data-id="${esc(m.id)}">${esc(t("btnDrop"))}</button>
                   <button type="button" class="mini-btn danger" data-act="del" data-id="${esc(m.id)}">${esc(t("btnDelete"))}</button>`
              }
            </div>
          </td>
        `;

        tbody.appendChild(tr);

        tr.querySelectorAll("[data-act]").forEach(btn=>{
          btn.addEventListener("click", ()=>{
            onMeasureAction(btn.getAttribute("data-act"), btn.getAttribute("data-id"), tr);
          });
        });
      });
    }

function onMeasureAction(act, id, rowEl){
      const m = state.measures.find(x=>x.id===id);
      if(!m) return;

      if(act==="edit"){ editMeasureId = id; renderMeasures(); return; }
      if(act==="cancel"){ editMeasureId = null; renderMeasures(); return; }

      if(act==="save"){
        const type = rowEl.querySelector('[data-edit="type"]')?.value ?? m.type;
        const text = rowEl.querySelector('[data-edit="text"]')?.value ?? m.text;
        const evidence = rowEl.querySelector('[data-edit="evidence"]')?.value ?? m.evidence;
        const owner = rowEl.querySelector('[data-edit="owner"]')?.value ?? m.owner;
        const responsible = rowEl.querySelector('[data-edit="responsible"]')?.value ?? m.responsible;
        const due = rowEl.querySelector('[data-edit="due"]')?.value ?? m.due;

        m.type = (type==="avoid"||type==="validate"||type==="secure"||type==="lessons") ? type : "avoid";
        m.text = String(text).trim();
        m.evidence = String(evidence||"").trim();
        m.owner = String(owner||"").trim();
        m.responsible = String(responsible||"").trim();
        m.due = String(due||"").trim();

        editMeasureId = null;
        persist();
        renderMeasures();
        return;
      }

      if(act==="open") m.status = "open";
      if(act==="done") m.status = "done";
      if(act==="drop") m.status = "drop";
      if(act==="del"){
        const ok = confirm(currentLang==="de" ? "Maßnahme löschen?" : "Delete this action?");
        if(!ok) return;
        state.measures = state.measures.filter(x=>x.id !== id);
      }

      persist();
      renderMeasures();
    }


    // ---------- JSON ----------
    function downloadJson(){
      state.lang = currentLang;
      state.problem = $("#problemInput").value || "";
      state.ts = new Date().toISOString();

      const blob = new Blob([JSON.stringify(state, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = t("jsonName");
      a.click();
      URL.revokeObjectURL(url);
    }

    function loadJsonFile(file){
      file.text().then(txt=>{
        const parsed = JSON.parse(txt);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(parsed));
        if(!restore()){
          alert(t("loadError"));
          return;
        }
        if(state.lang==="de"||state.lang==="en") currentLang = state.lang;
        localStorage.setItem(LANG_KEY, currentLang);

        buildAll();
      }).catch(()=> alert(t("loadError")));
    }

    // ---------- Export PNG (optional) ----------
    function exportPng(){
      const area = document.getElementById("capture-area");
      html2canvas(area, { scale: 2, backgroundColor:"#ffffff" }).then(canvas=>{
        const link = document.createElement("a");
        link.download = t("pngName");
        link.href = canvas.toDataURL("image/png");
        link.click();
      }).catch(()=>{
        alert(currentLang==="de" ? "PNG Export fehlgeschlagen." : "PNG export failed.");
      });
    }

    // ---------- Export SVG (PNG embedded) (optional) ----------
    function exportSvg(){
      const area = document.getElementById("capture-area");
      html2canvas(area, { scale: 2, backgroundColor:"#ffffff" }).then(canvas=>{
        const w = canvas.width;
        const h = canvas.height;
        const pngData = canvas.toDataURL("image/png");
        const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="${w}" height="${h}" viewBox="0 0 ${w} ${h}">
  <image href="${pngData}" width="${w}" height="${h}"/>
</svg>`;
        const blob = new Blob([svg], {type: "image/svg+xml"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = t("svgName");
        a.click();
        URL.revokeObjectURL(url);
      }).catch(()=>{
        alert(currentLang==="de" ? "SVG Export fehlgeschlagen." : "SVG export failed.");
      });
    }

    // ---------- AI assistant (client-side, optional) ----------
    const AI_MODEL = "gpt-4.1";
    const AI_KEY_LS = "qm_ishikawa_openai_key_v1";
    const AI_LICENSE_HASH = "07aa2015d482734372d4a9a1c07c8290198526b9ce1fd2e2dcff4d05f6792a29"; // sha256(LICENSE)
    let aiLicenseOk = false;

    let aiLastJson = null;

    function aiNowIso(){ return new Date().toISOString(); }

    function aiSetStatus(msg){
      const el = $("#aiStatus");
      if(el) el.textContent = msg || "";
    }


    async function sha256Hex(str){
      const data = new TextEncoder().encode(String(str||""));
      const hash = await crypto.subtle.digest("SHA-256", data);
      return Array.from(new Uint8Array(hash)).map(b=>b.toString(16).padStart(2,"0")).join("");
    }

    async function aiCheckLicense(){
      const licEl = $("#aiLicense");
      if(!licEl){ aiLicenseOk = true; return true; }
      const val = (licEl.value || "").trim();
      if(!val){ aiLicenseOk = false; return false; }
      const hex = await sha256Hex(val);
      aiLicenseOk = (hex === AI_LICENSE_HASH);
      return aiLicenseOk;
    }

    function aiUpdateRunState(){
      const gen = $("#btnAiGenerate");
      if(!gen) return;
      // API key is still required, but license gates the action
      gen.disabled = !aiLicenseOk;
      gen.style.opacity = aiLicenseOk ? "1" : ".65";
    }

    function aiSetPreview(obj){
      const pre = $("#aiPreview");
      if(!pre) return;
      if(!obj){
        const msg = (currentLang==="de") ? "Noch nichts generiert." : "Nothing generated yet.";
        pre.textContent = `{\n  "info": "${msg}"\n}`;
        return;
      }
      pre.textContent = JSON.stringify(obj, null, 2);
    }

    function aiSetMeta(text){
      const el = $("#aiPreviewMeta");
      if(el) el.textContent = text || "—";
    }

    function aiExtractJsonObject(text){
      try{ return JSON.parse(text); }catch(e){}
      const start = String(text||"").indexOf("{");
      const end = String(text||"").lastIndexOf("}");
      if(start >= 0 && end > start){
        const maybe = String(text).slice(start, end+1);
        return JSON.parse(maybe);
      }
      throw new Error("parse");
    }

    function aiNormalizeAndComplete(obj, problemFallback){
      const out = {
        lang: currentLang,
        problem: (obj && typeof obj.problem === "string" && obj.problem.trim()) ? obj.problem.trim() : (problemFallback || ""),
        matrix: {},
        measures: [],
        draft: { causeId:null, causeSnapshot:"", cat:"", triage:"", type:"avoid", text:"", evidence:"", owner:"", responsible:"", due:"" },
        ts: (obj && typeof obj.ts === "string" && obj.ts) ? obj.ts : aiNowIso()
      };

      const m = (obj && obj.matrix && typeof obj.matrix === "object") ? obj.matrix : {};
      for(const cat of CATS){
        const arr = Array.isArray(m[cat]) ? m[cat] : [];
        const normalized = [];
        for(const item of arr.slice(0, 5)){
          const text = (item && typeof item.text === "string") ? item.text.trim() : "";
          const triage = (item && (item.triage === "red" || item.triage === "yellow" || item.triage === "green")) ? item.triage : "yellow";
          if(text) normalized.push({ id: uid(), text, triage });
        }
        while(normalized.length < 5){
          normalized.push({
            id: uid(),
            text: (currentLang==="de" ? `(Ursache ergänzen: ${cat})` : `(Add cause: ${cat})`),
            triage: "green"
          });
        }
        out.matrix[cat] = normalized;
      }
      return out;
    }

    function aiBuildPrompt(problem, context){
      const isEN = currentLang === "en";
      const header = isEN
        ? [
            "You are a quality & process expert. Create a complete Ishikawa JSON file in the schema below.",
            "Return JSON ONLY (no explanations, no Markdown).",
            "Schema: {lang, problem, matrix, measures, draft, ts}",
            `- lang: always "${currentLang}"`,
            "- problem: from INPUT",
            "- matrix: object with EXACT keys: Mensch, Maschine, Material, Methode, Mitwelt, Messung.",
            "  Each key contains an array with EXACTLY 5 objects.",
            "  Each object: { text, triage }.",
            "  triage is one of: red | yellow | green.",
            "  text is a short, concrete cause matching the context.",
            "- measures: always []",
            "- draft: { causeId:null, causeSnapshot:string, cat:string, triage:string, type:avoid|validate|secure|lessons, text:string, evidence:string, owner:string, responsible:string, due:YYYY-MM-DD }",
            "- ts: ISO-8601 timestamp string",
            "IMPORTANT:",
            "- No placeholders like 'Cause 1'.",
            "- Distribute triage sensibly (not all red).",
            "- Write causes in English.",
          ]
        : [
            "Du bist ein Qualitäts- und Prozess-Experte. Erzeuge eine vollständige Ishikawa-JSON Datei im folgenden Schema.",
            "Gib NUR JSON zurück (keine Erklärungen, kein Markdown).",
            "Schema: {lang, problem, matrix, measures, draft, ts}",
            `- lang: immer "${currentLang}"`,
            "- problem: Fehlerbild aus INPUT",
            "- matrix: Objekt mit GENAU diesen Keys: Mensch, Maschine, Material, Methode, Mitwelt, Messung.",
            "  Jeder Key enthält ein Array mit GENAU 5 Objekten.",
            "  Jedes Objekt: { text, triage }.",
            "  triage ist eines von: red | yellow | green.",
            "  text ist eine kurze, konkrete Fehlerursache passend zum Kontext.",
            "- measures: immer [] (leer)",
            "- draft: { causeId:null, causeSnapshot:string, cat:string, triage:string, type:avoid|validate|secure|lessons, text:string, evidence:string, owner:string, responsible:string, due:YYYY-MM-DD }",
            "- ts: ISO-8601 Zeitstempel als String",
            "WICHTIG:",
            "- Keine Platzhalter wie 'Fehlerursache 1', sondern realistische Ursachen.",
            "- Verteile triage sinnvoll (nicht alles rot).",
            "- Schreibe Ursachen auf Deutsch.",
          ];

      return header.concat([
        "\nINPUT:",
        `Fehlerbild: ${problem}`,
        `Kontext: ${context || (isEN ? "(no additional context)" : "(kein weiterer Kontext)")}`
      ]).join("\n");
    }

    function aiGetOutputText(data){
      if(data && typeof data.output_text === "string") return data.output_text;
      if(data && Array.isArray(data.output)){
        const parts = [];
        for(const item of data.output){
          if(item && item.type === "message" && Array.isArray(item.content)){
            for(const c of item.content){
              if(c && (c.type === "output_text" || c.type === "text") && typeof c.text === "string") parts.push(c.text);
            }
          }
          if(item && typeof item.text === "string") parts.push(item.text);
        }
        if(parts.length) return parts.join("\n");
      }
      return JSON.stringify(data);
    }

    function aiBuildContextFromTool(){
      const lines = [];
      const p = $("#problemInput")?.value || "";
      if(p) lines.push((currentLang==="de" ? "Aktuelles Problem:" : "Current problem:") + " " + p);

      for(const cat of CATS){
        const arr = state.matrix[cat] || [];
        const items = arr
          .map(x=>({triage:x.triage, text:(x.text||"").trim()}))
          .filter(x=>x.text);
        if(items.length){
          lines.push("\n" + cat + ":");
          items.slice(0, 12).forEach(x=> lines.push(`- (${x.triage}) ${x.text}`));
          if(items.length > 12) lines.push("- ...");
        }
      }

      const meas = state.measures || [];
      if(meas.length){
        lines.push("\n" + (currentLang==="de" ? `Maßnahmen (${meas.length}):` : `Actions (${meas.length}):`));
        meas.slice(0, 8).forEach(m=>{
          const t1 = (m.text||"").trim();
          if(!t1) return;
          lines.push(`- [${m.status}] ${t1} (Owner: ${m.owner||"-"}, Due: ${m.due||"-"})`);
        });
        if(meas.length > 8) lines.push("- ...");
      }
      return lines.join("\n").trim();
    }

    async function aiGenerate(){
      const keyEl = $("#aiApiKey");
      const problemEl = $("#aiProblem");
      const contextEl = $("#aiContext");
      const btn = $("#btnAiGenerate");
      const btnApply = $("#btnAiApply");
      const btnDownload = $("#btnAiDownload");

      const apiKey = (keyEl?.value || "").trim();
      const problem = (problemEl?.value || "").trim();
      const context = (contextEl?.value || "").trim();

      if(!apiKey){ aiSetStatus(t("aiNeedKey")); return; }
      if(!problem){ aiSetStatus(t("aiNeedProblem")); return; }

      aiSetStatus(t("aiSending"));
      if(btn) btn.disabled = true;
      if(btnApply) btnApply.disabled = true;
      if(btnDownload) btnDownload.disabled = true;

      try{
        const prompt = aiBuildPrompt(problem, context);
        const res = await fetch("https://api.openai.com/v1/responses", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({ model: AI_MODEL, input: prompt })
        });

        if(!res.ok){
          const msg = await res.text().catch(()=>"");
          throw new Error(`${res.status} ${res.statusText}${msg ? `\n${msg}` : ""}`);
        }

        const data = await res.json();
        const outText = aiGetOutputText(data);
        const obj = aiExtractJsonObject(outText);
        aiLastJson = aiNormalizeAndComplete(obj, problem);

        aiSetPreview(aiLastJson);
        aiSetMeta(`${AI_MODEL} · ${new Date().toLocaleString()}`);
        aiSetStatus(t("aiDone"));

        if(btnApply) btnApply.disabled = false;
        if(btnDownload) btnDownload.disabled = false;
      }catch(e){
        aiLastJson = null;
        aiSetMeta("—");
        aiSetStatus((e && String(e.message||e)) ? String(e.message||e) : t("aiParseError"));
        if(String(e && e.message||"").toLowerCase().includes("parse")) aiSetStatus(t("aiParseError"));
      }finally{
        if(btn) btn.disabled = false;
      }
    }

    function aiDownload(){
      if(!aiLastJson) return;
      const blob = new Blob([JSON.stringify(aiLastJson, null, 2)], { type:"application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = t("jsonName");
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 1500);
    }

    function aiApplyToTool(){
      if(!aiLastJson) return;
      const ok = confirm(t("aiConfirmApply"));
      if(!ok) return;

      // overwrite full state (keeps current UI language)
      state = {
        lang: currentLang,
        problem: aiLastJson.problem || "",
        matrix: aiLastJson.matrix || Object.fromEntries(CATS.map(c=>[c,[]])),
        measures: [],
        draft: { causeId:null, causeSnapshot:"", cat:"", triage:"", type:"avoid", text:"", evidence:"", owner:"", responsible:"", due:"" },
        ts: aiNowIso()
      };
      $("#problemInput").value = state.problem;
      triageFilter = "all";
      measuresFilter = "all";
      editMeasureId = null;
      buildAll();
    }

    function aiClear(){
      aiLastJson = null;
      const p = $("#aiProblem");
      const c = $("#aiContext");
      if(p) p.value = "";
      if(c) c.value = "";
      const btnApply = $("#btnAiApply");
      const btnDownload = $("#btnAiDownload");
      if(btnApply) btnApply.disabled = true;
      if(btnDownload) btnDownload.disabled = true;
      aiSetMeta("—");
      aiSetStatus("");
      aiSetPreview(null);

      // require license before running
      (async ()=>{
        if(licEl && !licEl.value){
          aiSetStatus(t("aiNeedLicense"));
        }
        await aiCheckLicense();
        aiUpdateRunState();
      })();
    }

    // ---------- init/build ----------
    function buildAll(){
      // render categories
      CATS.forEach(renderCat);

      // draft
      syncDraftInputs();

      // i18n (also re-renders tables with translated labels)
      applyI18n();
      persist();
    }

    // ---------- wire events ----------
    document.getElementById("btnLangDE").addEventListener("click", ()=> setLanguage("de"));
    document.getElementById("btnLangEN").addEventListener("click", ()=> setLanguage("en"));

    // add cause buttons
    $$(".btn-add").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const cat = btn.getAttribute("data-cat");
        addNote(cat, "", "yellow"); // default gelb = "prüfbar / unklar"
        updateTriageMeta();
        renderTriageTable();
      });
    });

    // problem autosave
    $("#problemInput").addEventListener("input", ()=> persist());

    // triage filter chips
    $$('.chip[data-filter]').forEach(ch=>{
      ch.addEventListener("click", ()=>{
        triageFilter = ch.getAttribute("data-filter");
        $$('.chip[data-filter]').forEach(x=>x.classList.toggle("active", x.getAttribute("data-filter")===triageFilter));
        renderTriageTable();
      });
    });

    // measures filter chips
    $$('.chip[data-mfilter]').forEach(ch=>{
      ch.addEventListener("click", ()=>{
        measuresFilter = ch.getAttribute("data-mfilter");
        $$('.chip[data-mfilter]').forEach(x=>x.classList.toggle("active", x.getAttribute("data-mfilter")===measuresFilter));
        renderMeasures();
      });
    });

    // draft inputs
    $("#draftType").addEventListener("change", (e)=>{ state.draft.type = e.target.value; persist(); });
    $("#draftMeasure").addEventListener("input", (e)=>{ state.draft.text = e.target.value; persist(); });
    $("#draftEvidence").addEventListener("input", (e)=>{ state.draft.evidence = e.target.value; persist(); });
    $("#draftOwner").addEventListener("input", (e)=>{ state.draft.owner = e.target.value; persist(); });
    $("#draftResp").addEventListener("input", (e)=>{ state.draft.responsible = e.target.value; persist(); });
    $("#draftDue").addEventListener("input", (e)=>{ state.draft.due = e.target.value; persist(); });

    $("#btnSaveDraft").addEventListener("click", saveDraftToMeasures);
    $("#btnClearDraft").addEventListener("click", clearDraft);
    $("#btnSeedFromRY").addEventListener("click", seedFromRedYellow);

    // iframe snippet copy
    const btnCopy = $("#btnCopyIframe");
    if(btnCopy){
      btnCopy.addEventListener("click", async ()=>{
        const pre = $("#iframeSnippet");
        const status = $("#embedStatus");
        if(!pre) return;
        const text = pre.textContent || "";
        const okMsg = t("embedCopied");
        const failMsg = t("embedCopyFail");

        // preferred: Clipboard API
        try{
          if(navigator.clipboard && window.isSecureContext){
            await navigator.clipboard.writeText(text);
            if(status) status.textContent = okMsg;
            return;
          }
        }catch(e){}

        // fallback: hidden textarea + execCommand
        try{
          const ta = document.createElement("textarea");
          ta.value = text;
          ta.style.position = "fixed";
          ta.style.left = "-9999px";
          ta.style.top = "0";
          document.body.appendChild(ta);
          ta.focus();
          ta.select();
          const ok = document.execCommand("copy");
          document.body.removeChild(ta);
          if(status) status.textContent = ok ? okMsg : failMsg;
        }catch(e){
          if(status) status.textContent = failMsg;
        }
      });
    }

    // print / png / json / reset
    $("#btnPrint").addEventListener("click", ()=> window.print());
    $("#btnExportPng").addEventListener("click", exportPng);
    $("#btnExportSvg").addEventListener("click", exportSvg);

    $("#btnSaveJson").addEventListener("click", downloadJson);
    $("#btnLoadJson").addEventListener("click", ()=> $("#jsonFile").click());
    $("#jsonFile").addEventListener("change", (ev)=>{
      const f = ev.target.files && ev.target.files[0];
      if(!f) return;
      loadJsonFile(f);
      ev.target.value = "";
    });

    $("#btnReset").addEventListener("click", ()=>{
      if(!confirm(t("confirmReset"))) return;
      localStorage.removeItem(STORAGE_KEY);
      state = EMPTY();
      $("#problemInput").value = "";
      triageFilter = "all";
      measuresFilter = "all";
      editMeasureId = null;
      buildAll();
    });

    // ---------- AI assistant wire (optional) ----------
    (function initAi(){
      const keyEl = $("#aiApiKey");
      if(!keyEl) return;

      const rememberEl = $("#aiRemember");
      const problemEl = $("#aiProblem");
      const contextEl = $("#aiContext");

      const licEl = $("#aiLicense");

      // license gate
      if(licEl){
        licEl.addEventListener("input", async ()=>{
          await aiCheckLicense();
          aiUpdateRunState();
          if(licEl.value && !aiLicenseOk){
            aiSetStatus(t("aiBadLicense"));
          }else if(!licEl.value){
            aiSetStatus(t("aiNeedLicense"));
          }else{
            aiSetStatus("");
          }
        });
      }


      // prefill from tool
      if(problemEl) problemEl.value = $("#problemInput")?.value || "";

      // load remembered key
      try{
        const saved = localStorage.getItem(AI_KEY_LS);
        if(saved){
          keyEl.value = saved;
          if(rememberEl) rememberEl.checked = true;
        }
      }catch(e){}

      if(rememberEl){
        rememberEl.addEventListener("change", ()=>{
          try{
            if(rememberEl.checked) localStorage.setItem(AI_KEY_LS, keyEl.value || "");
            else localStorage.removeItem(AI_KEY_LS);
          }catch(e){}
        });
      }

      keyEl.addEventListener("input", ()=>{
        try{
          if(rememberEl && rememberEl.checked) localStorage.setItem(AI_KEY_LS, keyEl.value || "");
        }catch(e){}
      });

      // buttons
      const btnTake = $("#btnAiTakeProblem");
      if(btnTake){
        btnTake.addEventListener("click", ()=>{
          if(problemEl) problemEl.value = $("#problemInput")?.value || "";
          if(problemEl) problemEl.focus();
        });
      }

      const btnCtx = $("#btnAiContextFromTool");
      if(btnCtx){
        btnCtx.addEventListener("click", ()=>{
          if(contextEl) contextEl.value = aiBuildContextFromTool();
        });
      }
      $("#btnAiGenerate")?.addEventListener("click", aiGenerate);
      $("#btnAiApply")?.addEventListener("click", aiApplyToTool);
      $("#btnAiDownload")?.addEventListener("click", aiDownload);
      $("#btnAiClear")?.addEventListener("click", aiClear);
    })();

    // ---------- start ----------
    const ok = restore();
    if(ok){
      if(state.lang==="de"||state.lang==="en") currentLang = state.lang;
      localStorage.setItem(LANG_KEY, currentLang);
    }
    buildAll();

  })();
  </script>
</body>
</html>
